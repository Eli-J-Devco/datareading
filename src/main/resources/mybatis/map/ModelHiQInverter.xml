<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ModelHiQInverter">

	<insert id="insertModelHiQInverter"
		useGeneratedKeys="true" keyProperty="time">
		INSERT INTO `${datatablename}`
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="time != null">
				`time`,
			</if>
			<if test="id_device != 0.001">
				`id_device`,
			</if>
			<if test="error != 0.001">
				`error`,
			</if>
			<if test="low_alarm != 0.001">
				`low_alarm`,
			</if>
			<if test="high_alarm != 0.001">
				`high_alarm`,
			</if>
			<if test="TimeLastContacted != 0.001">
				`TimeLastContacted`,
			</if>
			<if test="InverterMode != 0.001">
				`InverterMode`,
			</if>
			<if test="InverterStatus != 0.001">
				`InverterStatus`,
			</if>
			<if test="ActivePower != 0.001">
				`ActivePower`,
			</if>
			<if test="TotalEnergy != 0.001">
				`TotalEnergy`,
			</if>
			<if test="String1Voltage != 0.001">
				`String1Voltage`,
			</if>
			<if test="String1Current != 0.001">
				`String1Current`,
			</if>
			<if test="String1Power != 0.001">
				`String1Power`,
			</if>
			
			<if test="String1Status != 0.001">
				`String1Status`,
			</if>
			<if test="String2Voltage != 0.001">
				`String2Voltage`,
			</if>
			<if test="String2Current != 0.001">
				`String2Current`,
			</if>
			<if test="String2Power != 0.001">
				`String2Power`,
			</if>
			<if test="String2Status != 0.001">
				`String2Status`,
			</if>
			<if test="SerialNumberASCII_1_4 != 0.001">
				`SerialNumberASCII_1_4`,
			</if>
			<if test="SerialNumberASCII_5_8 != 0.001">
				`SerialNumberASCII_5_8`,
			</if>
			<if test="NumberOfStrings != 0.001">
				`NumberOfStrings`,
			</if>
			<if test="PLCSignal != 0.001">
				`PLCSignal`,
			</if>
			<if test="PLCNoise != 0.001">
				`PLCNoise`,
			</if>
			<if test="FirmwareVersionASCII != 0.001">
				`FirmwareVersionASCII`,
			</if>
			
			<if test="nvmActivePower != 0.001">
				`nvmActivePower`,
			</if>
			<if test="nvmActiveEnergy != 0.001">
				`nvmActiveEnergy`,
			</if>
			<if test="MeasuredProduction != 0.001">
				`MeasuredProduction`,
			</if>
			

		</trim>

		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="time != null">
				#{time},
			</if>
			<if test="id_device != 0.001">
				#{id_device},
			</if>
			<if test="error != 0.001">
				#{error},
			</if>
			<if test="low_alarm != 0.001">
				#{low_alarm},
			</if>
			<if test="high_alarm != 0.001">
				#{high_alarm},
			</if>
			
			<if test="TimeLastContacted != 0.001">
				#{TimeLastContacted},
			</if>
			<if test="InverterMode != 0.001">
				#{InverterMode},
			</if>
			<if test="InverterStatus != 0.001">
				#{InverterStatus},
			</if>
			<if test="ActivePower != 0.001">
				#{ActivePower},
			</if>
			<if test="TotalEnergy != 0.001">
				#{TotalEnergy},
			</if>
			<if test="String1Voltage != 0.001">
				#{String1Voltage},
			</if>
			<if test="String1Current != 0.001">
				#{String1Current},
			</if>
			<if test="String1Power != 0.001">
				#{String1Power},
			</if>
			
			<if test="String1Status != 0.001">
				#{String1Status},
			</if>
			<if test="String2Voltage != 0.001">
				#{String2Voltage},
			</if>
			<if test="String2Current != 0.001">
				#{String2Current},
			</if>
			<if test="String2Power != 0.001">
				#{String2Power},
			</if>
			<if test="String2Status != 0.001">
				#{String2Status},
			</if>
			<if test="SerialNumberASCII_1_4 != 0.001">
				#{SerialNumberASCII_1_4},
			</if>
			<if test="SerialNumberASCII_5_8 != 0.001">
				#{SerialNumberASCII_5_8},
			</if>
			<if test="NumberOfStrings != 0.001">
				#{NumberOfStrings},
			</if>
			<if test="PLCSignal != 0.001">
				#{PLCSignal},
			</if>
			<if test="PLCNoise != 0.001">
				#{PLCNoise},
			</if>
			<if test="FirmwareVersionASCII != 0.001">
				#{FirmwareVersionASCII},
			</if>
			
			<if test="nvmActivePower != 0.001">
				#{nvmActivePower},
			</if>
			<if test="nvmActiveEnergy != 0.001">
				#{nvmActiveEnergy},
			</if>
			<if test="MeasuredProduction != 0.001">
				#{MeasuredProduction},
			</if>
			
		</trim>

		<trim prefix="ON DUPLICATE KEY UPDATE " suffix=""
			suffixOverrides=",">
			<if test="id_device != 0.001">
				`id_device` = #{id_device},
			</if>
			<if test="error != 0.001">
				`error` = #{error},
			</if>
			<if test="low_alarm != 0.001">
				`low_alarm` = #{low_alarm},
			</if>
			<if test="high_alarm != 0.001">
				`high_alarm` = #{high_alarm},
			</if>
			
			<if test="TimeLastContacted != 0.001">
				`TimeLastContacted` = #{TimeLastContacted},
			</if>
			<if test="InverterMode != 0.001">
				`InverterMode` = #{InverterMode},
			</if>
			<if test="InverterStatus != 0.001">
				`InverterStatus` = #{InverterStatus},
			</if>
			<if test="ActivePower != 0.001">
				`ActivePower` = #{ActivePower},
			</if>
			<if test="TotalEnergy != 0.001">
				`TotalEnergy` = #{TotalEnergy},
			</if>
			<if test="String1Voltage != 0.001">
				`String1Voltage` = #{String1Voltage},
			</if>
			<if test="String1Current != 0.001">
				`String1Current` = #{String1Current},
			</if>
			<if test="String1Power != 0.001">
				`String1Power` = #{String1Power},
			</if>
			
			<if test="String1Status != 0.001">
				`String1Status` = #{String1Status},
			</if>
			<if test="String2Voltage != 0.001">
				`String2Voltage` = #{String2Voltage},
			</if>
			<if test="String2Current != 0.001">
				`String2Current` = #{String2Current},
			</if>
			<if test="String2Power != 0.001">
				`String2Power` = #{String2Power},
			</if>
			<if test="String2Status != 0.001">
				`String2Status` = #{String2Status},
			</if>
			<if test="SerialNumberASCII_1_4 != 0.001">
				`SerialNumberASCII_1_4` = #{SerialNumberASCII_1_4},
			</if>
			<if test="SerialNumberASCII_5_8 != 0.001">
				`SerialNumberASCII_5_8` = #{SerialNumberASCII_5_8},
			</if>
			<if test="NumberOfStrings != 0.001">
				`NumberOfStrings` = #{NumberOfStrings},
			</if>
			<if test="PLCSignal != 0.001">
				`PLCSignal` = #{PLCSignal},
			</if>
			<if test="PLCNoise != 0.001">
				`PLCNoise` = #{PLCNoise},
			</if>
			<if test="FirmwareVersionASCII != 0.001">
				`FirmwareVersionASCII` = #{FirmwareVersionASCII},
			</if>
			
			<if test="nvmActivePower != 0.001">
				`nvmActivePower` = #{nvmActivePower},
			</if>
			<if test="nvmActiveEnergy != 0.001">
				`nvmActiveEnergy` = #{nvmActiveEnergy},
			</if>
			<if test="MeasuredProduction != 0.001 and MeasuredProduction > 0">
				`MeasuredProduction` = #{MeasuredProduction},
			</if>
			
		</trim>
	</insert>
	
	<select id="continuousCount" resultType="Map">
		SELECT
			COUNT(status) AS status,
			COUNT(mode) AS mode,
			COUNT(string1Status) AS string1Status,
			COUNT(string2Status) AS string2Status
		FROM (
	    	SELECT
				IF(InverterStatus = #{InverterStatus}, 1, NULL) AS status,
				IF(InverterMode = #{InverterMode}, 1, NULL) AS mode,
				IF(String1Status = #{String1Status}, 1, NULL) AS string1Status,
				IF(String2Status = #{String2Status}, 1, NULL) AS string2Status
			FROM
				${datatablename}
			WHERE
				id_device = #{id_device}
			ORDER BY
				time DESC 
			LIMIT 20
		) t
  	</select>
	
	<select id="getLastRow" resultType="com.nwm.api.entities.ModelHiQInverterEntity">
		SELECT
			dv.*
		FROM
			${view_tablename} dv 
		WHERE
			dv.id_device = #{id_device}
			<if test="time != null" >
	        	AND dv.time <![CDATA[<]]> #{time}
	        </if>
		ORDER BY
			dv.time DESC 
			LIMIT 1
	</select>
	

</mapper> 