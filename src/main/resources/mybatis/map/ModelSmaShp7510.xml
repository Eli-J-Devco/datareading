<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ModelSmaShp7510">

	<insert id="insertModelSmaShp7510" useGeneratedKeys="true"
		keyProperty="time">
		INSERT INTO `${datatablename}`
		<trim prefix="(" suffix=")" suffixOverrides="," >
		  <if test="time != null" >
                `time`,
          </if>
		  
		  <if test="id_device != 0.001" >
                `id_device`,
          </if>
		  
		  <if test="error != 0.001" >
                `error`,
          </if>
		  
		  <if test="low_alarm != 0.001" >
                `low_alarm`,
          </if>
		  
		  <if test="high_alarm != 0.001" >
                `high_alarm`,
          </if>
		  
		  <if test="ACcurrentA != 0.001" >
                `ACcurrentA`,
          </if>
          <if test="CurrentlineconductorL1 != 0.001" >
                `CurrentlineconductorL1`,
          </if>
          <if test="CurrentlineconductorL2 != 0.001" >
                `CurrentlineconductorL2`,
          </if>
          <if test="CurrentlineconductorL3 != 0.001" >
                `CurrentlineconductorL3`,
          </if>
          <if test="Scalefactorcurrent != 0.001" >
                `Scalefactorcurrent`,
          </if>
          <if test="VoltagelineconductorL1toL2 != 0.001" >
                `VoltagelineconductorL1toL2`,
          </if>
          <if test="VoltagelineconductorL2toL3 != 0.001" >
                `VoltagelineconductorL2toL3`,
          </if>
          <if test="VoltagelineconductorL3toL1 != 0.001" >
               `VoltagelineconductorL3toL1`, 
          </if>
          <if test="VoltagelineconductorL1toN != 0.001" >
                `VoltagelineconductorL1toN`,
          </if>
          <if test="VoltagelineconductorL2toN != 0.001" >
                `VoltagelineconductorL2toN`,
          </if>
          <if test="VoltagelineconductorL3toN != 0.001" >
                `VoltagelineconductorL3toN`,
          </if>
          <if test="Scalefactorvoltage != 0.001" >
                `Scalefactorvoltage`,
          </if>
          <if test="Activepower != 0.001" >
                `Activepower`,
          </if>
          <if test="Scalefactoractivepower != 0.001" >
                `Scalefactoractivepower`,
          </if>
          <if test="Powerfrequency != 0.001" >
                `Powerfrequency`,
          </if>
          <if test="Scalefactorpowerfrequency != 0.001" >
                `Scalefactorpowerfrequency`,
          </if>
          <if test="Apparentpower != 0.001" >
                `Apparentpower`,
          </if>
          <if test="Scalefactorapparentpower != 0.001" >
                `Scalefactorapparentpower`,
          </if>
          <if test="Reactivepower != 0.001" >
                `Reactivepower`,
          </if>
          <if test="Scalefactorreactivepower != 0.001" >
                `Scalefactorreactivepower`,
          </if>
          <if test="Displacementpowerfactorcos != 0.001" >
                `Displacementpowerfactorcos`,
          </if>
          <if test="Scalefactordisplacementpowerfactor != 0.001" >
                `Scalefactordisplacementpowerfactor`,
          </if>
          <if test="Totalyield != 0.001" >
                `Totalyield`,
          </if>
          <if test="calefactortotalyield != 0.001" >
                `calefactortotalyield`,
          </if>
          <if test="DCcurrent != 0.001" >
                `DCcurrent`,
          </if>
          <if test="ScalefactorDCcurrent != 0.001" >
                `ScalefactorDCcurrent`,
          </if>
          <if test="DCvoltage != 0.001" >
                `DCvoltage`,
          </if>
          <if test="ScalefactorDCvoltage != 0.001" >
                `ScalefactorDCvoltage`,
          </if>
          <if test="DCpower != 0.001" >
                `DCpower`,
          </if>
          <if test="ScalefactorDCpower != 0.001" >
                `ScalefactorDCpower`,
          </if>
          <if test="Internaltemperature != 0.001" >
                `Internaltemperature`,
          </if>
          <if test="Heatsinktemperature != 0.001" >
                `Heatsinktemperature`,
          </if>
          <if test="Transformer != 0.001" >
                `Transformer`,
          </if>
          <if test="Othertemperature != 0.001" >
                `Othertemperature`,
          </if>
          <if test="Scalefactortemperature != 0.001" >
                `Scalefactortemperature`,
          </if>
          <if test="Operatingstatus != 0.001" >
                `Operatingstatus`,
          </if>
          <if test="Manufacturerspecificstatuscode != 0.001" >
                `Manufacturerspecificstatuscode`,
          </if>
          <if test="EventnumberEvt1 != 0.001" >
               `EventnumberEvt1`,
          </if>
          <if test="EventnumberEvt2 != 0.001" >
                `EventnumberEvt2`,
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd1 != 0.001" >
                `ManufacturerspecificeventcodeEvtVnd1`,
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd2 != 0.001" >
                `ManufacturerspecificeventcodeEvtVnd2`,
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd3 != 0.001" >
                `ManufacturerspecificeventcodeEvtVnd3`,
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd4 != 0.001" >
                `ManufacturerspecificeventcodeEvtVnd4`,
          </if>
          
          
          
          
          
		  <if test="nvmActivePower != 0.001" >
		  	`nvmActivePower`,
		  </if>
		  <if test="nvmActiveEnergy != 0.001" >
		  	`nvmActiveEnergy`,
		  </if>
		  <if test="MeasuredProduction != 0.001">
				`MeasuredProduction`,
			</if>
		</trim>
		
		<trim prefix="values (" suffix=")" suffixOverrides="," >
			  <if test="time != null" >
                #{time},
	          </if>
			  
			  <if test="id_device != 0.001" >
	                #{id_device},
	          </if>
			  
			  <if test="error != 0.001" >
	                #{error},
	          </if>
			  
			  <if test="low_alarm != 0.001" >
	                #{low_alarm},
	          </if>
			  
			  <if test="high_alarm != 0.001" >
	                #{high_alarm},
	          </if>
			  
			   <if test="ACcurrentA != 0.001" >
                #{ACcurrentA},
          </if>
          <if test="CurrentlineconductorL1 != 0.001" >
                #{CurrentlineconductorL1},
          </if>
          <if test="CurrentlineconductorL2 != 0.001" >
                #{CurrentlineconductorL2},
          </if>
          <if test="CurrentlineconductorL3 != 0.001" >
                #{CurrentlineconductorL3},
          </if>
          <if test="Scalefactorcurrent != 0.001" >
                #{Scalefactorcurrent},
          </if>
          <if test="VoltagelineconductorL1toL2 != 0.001" >
                #{VoltagelineconductorL1toL2},
          </if>
          <if test="VoltagelineconductorL2toL3 != 0.001" >
                #{VoltagelineconductorL2toL3},
          </if>
          <if test="VoltagelineconductorL3toL1 != 0.001" >
               #{VoltagelineconductorL3toL1}, 
          </if>
          <if test="VoltagelineconductorL1toN != 0.001" >
                #{VoltagelineconductorL1toN},
          </if>
          <if test="VoltagelineconductorL2toN != 0.001" >
                #{VoltagelineconductorL2toN},
          </if>
          <if test="VoltagelineconductorL3toN != 0.001" >
                #{VoltagelineconductorL3toN},
          </if>
          <if test="Scalefactorvoltage != 0.001" >
                #{Scalefactorvoltage},
          </if>
          <if test="Activepower != 0.001" >
                #{Activepower},
          </if>
          <if test="Scalefactoractivepower != 0.001" >
                #{Scalefactoractivepower},
          </if>
          <if test="Powerfrequency != 0.001" >
                #{Powerfrequency},
          </if>
          <if test="Scalefactorpowerfrequency != 0.001" >
                #{Scalefactorpowerfrequency},
          </if>
          <if test="Apparentpower != 0.001" >
                #{Apparentpower},
          </if>
          <if test="Scalefactorapparentpower != 0.001" >
                #{Scalefactorapparentpower},
          </if>
          <if test="Reactivepower != 0.001" >
                #{Reactivepower},
          </if>
          <if test="Scalefactorreactivepower != 0.001" >
                #{Scalefactorreactivepower},
          </if>
          <if test="Displacementpowerfactorcos != 0.001" >
                #{Displacementpowerfactorcos},
          </if>
          <if test="Scalefactordisplacementpowerfactor != 0.001" >
                #{Scalefactordisplacementpowerfactor},
          </if>
          <if test="Totalyield != 0.001" >
                #{Totalyield},
          </if>
          <if test="calefactortotalyield != 0.001" >
                #{calefactortotalyield},
          </if>
          <if test="DCcurrent != 0.001" >
                #{DCcurrent},
          </if>
          <if test="ScalefactorDCcurrent != 0.001" >
                #{ScalefactorDCcurrent},
          </if>
          <if test="DCvoltage != 0.001" >
                #{DCvoltage},
          </if>
          <if test="ScalefactorDCvoltage != 0.001" >
                #{ScalefactorDCvoltage},
          </if>
          <if test="DCpower != 0.001" >
                #{DCpower},
          </if>
          <if test="ScalefactorDCpower != 0.001" >
                #{ScalefactorDCpower},
          </if>
          <if test="Internaltemperature != 0.001" >
                #{Internaltemperature},
          </if>
          <if test="Heatsinktemperature != 0.001" >
                #{Heatsinktemperature},
          </if>
          <if test="Transformer != 0.001" >
                #{Transformer},
          </if>
          <if test="Othertemperature != 0.001" >
                #{Othertemperature},
          </if>
          <if test="Scalefactortemperature != 0.001" >
                #{Scalefactortemperature},
          </if>
          <if test="Operatingstatus != 0.001" >
                #{Operatingstatus},
          </if>
          <if test="Manufacturerspecificstatuscode != 0.001" >
                #{Manufacturerspecificstatuscode},
          </if>
          <if test="EventnumberEvt1 != 0.001" >
               #{EventnumberEvt1}, 
          </if>
          <if test="EventnumberEvt2 != 0.001" >
                #{EventnumberEvt2},
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd1 != 0.001" >
                #{ManufacturerspecificeventcodeEvtVnd1},
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd2 != 0.001" >
                #{ManufacturerspecificeventcodeEvtVnd2},
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd3 != 0.001" >
                #{ManufacturerspecificeventcodeEvtVnd3},
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd4 != 0.001" >
                #{ManufacturerspecificeventcodeEvtVnd4},
          </if>
          
          
          
			  <if test="nvmActivePower != 0.001" >
			  	#{nvmActivePower},
			  </if>
			  <if test="nvmActiveEnergy != 0.001" >
			  	#{nvmActiveEnergy},
			  </if>
			  <if test="MeasuredProduction != 0.001">
				#{MeasuredProduction},
			</if>
		</trim>
		
		<trim prefix="ON DUPLICATE KEY UPDATE " suffix=""
			suffixOverrides=",">
			<if test="id_device != 0.001" >
	                id_device = #{id_device},
	          </if>
			  
			  <if test="error != 0.001" >
	                `error` = #{error},
	          </if>
			  
			  <if test="low_alarm != 0.001" >
	                low_alarm = #{low_alarm},
	          </if>
			  
			  <if test="high_alarm != 0.001" >
	                high_alarm = #{high_alarm},
	          </if>
			  
			   <if test="ACcurrentA != 0.001" >
                `ACcurrentA` = #{ACcurrentA},
          </if>
          <if test="CurrentlineconductorL1 != 0.001" >
                `CurrentlineconductorL1` = #{CurrentlineconductorL1},
          </if>
          <if test="CurrentlineconductorL2 != 0.001" >
                `CurrentlineconductorL2` = #{CurrentlineconductorL2},
          </if>
          <if test="CurrentlineconductorL3 != 0.001" >
                `CurrentlineconductorL3` = #{CurrentlineconductorL3},
          </if>
          <if test="Scalefactorcurrent != 0.001" >
                `Scalefactorcurrent` = #{Scalefactorcurrent},
          </if>
          <if test="VoltagelineconductorL1toL2 != 0.001" >
                `VoltagelineconductorL1toL2` = #{VoltagelineconductorL1toL2},
          </if>
          <if test="VoltagelineconductorL2toL3 != 0.001" >
                `VoltagelineconductorL2toL3` = #{VoltagelineconductorL2toL3},
          </if>
          <if test="VoltagelineconductorL3toL1 != 0.001" >
               `VoltagelineconductorL3toL1` = #{VoltagelineconductorL3toL1}, 
          </if>
          <if test="VoltagelineconductorL1toN != 0.001" >
                `VoltagelineconductorL1toN` = #{VoltagelineconductorL1toN},
          </if>
          <if test="VoltagelineconductorL2toN != 0.001" >
                `VoltagelineconductorL2toN` = #{VoltagelineconductorL2toN},
          </if>
          <if test="VoltagelineconductorL3toN != 0.001" >
                `VoltagelineconductorL3toN` = #{VoltagelineconductorL3toN},
          </if>
          <if test="Scalefactorvoltage != 0.001" >
                `Scalefactorvoltage` = #{Scalefactorvoltage},
          </if>
          <if test="Activepower != 0.001" >
                `Activepower` = #{Activepower},
          </if>
          <if test="Scalefactoractivepower != 0.001" >
                `Scalefactoractivepower` = #{Scalefactoractivepower},
          </if>
          <if test="Powerfrequency != 0.001" >
                `Powerfrequency` = #{Powerfrequency},
          </if>
          <if test="Scalefactorpowerfrequency != 0.001" >
                `Scalefactorpowerfrequency` = #{Scalefactorpowerfrequency},
          </if>
          <if test="Apparentpower != 0.001" >
                `Apparentpower` = #{Apparentpower},
          </if>
          <if test="Scalefactorapparentpower != 0.001" >
                `Scalefactorapparentpower` = #{Scalefactorapparentpower},
          </if>
          <if test="Reactivepower != 0.001" >
                `Reactivepower` = #{Reactivepower},
          </if>
          <if test="Scalefactorreactivepower != 0.001" >
                `Scalefactorreactivepower` = #{Scalefactorreactivepower},
          </if>
          <if test="Displacementpowerfactorcos != 0.001" >
                `Displacementpowerfactorcos` = #{Displacementpowerfactorcos},
          </if>
          <if test="Scalefactordisplacementpowerfactor != 0.001" >
                `Scalefactordisplacementpowerfactor` = #{Scalefactordisplacementpowerfactor},
          </if>
          <if test="Totalyield != 0.001" >
                `Totalyield` = #{Totalyield},
          </if>
          <if test="calefactortotalyield != 0.001" >
                `calefactortotalyield` = #{calefactortotalyield},
          </if>
          <if test="DCcurrent != 0.001" >
                `DCcurrent` = #{DCcurrent},
          </if>
          <if test="ScalefactorDCcurrent != 0.001" >
                `ScalefactorDCcurrent` = #{ScalefactorDCcurrent},
          </if>
          <if test="DCvoltage != 0.001" >
                `DCvoltage` = #{DCvoltage},
          </if>
          <if test="ScalefactorDCvoltage != 0.001" >
                `ScalefactorDCvoltage` = #{ScalefactorDCvoltage},
          </if>
          <if test="DCpower != 0.001" >
                `DCpower` = #{DCpower},
          </if>
          <if test="ScalefactorDCpower != 0.001" >
                `ScalefactorDCpower` = #{ScalefactorDCpower},
          </if>
          <if test="Internaltemperature != 0.001" >
                `Internaltemperature` = #{Internaltemperature},
          </if>
          <if test="Heatsinktemperature != 0.001" >
                `Heatsinktemperature` = #{Heatsinktemperature},
          </if>
          <if test="Transformer != 0.001" >
                `Transformer` = #{Transformer},
          </if>
          <if test="Othertemperature != 0.001" >
                `Othertemperature` = #{Othertemperature},
          </if>
          <if test="Scalefactortemperature != 0.001" >
                `Scalefactortemperature` = #{Scalefactortemperature},
          </if>
          <if test="Operatingstatus != 0.001" >
                `Operatingstatus` = #{Operatingstatus},
          </if>
          <if test="Manufacturerspecificstatuscode != 0.001" >
                `Manufacturerspecificstatuscode` = #{Manufacturerspecificstatuscode},
          </if>
          <if test="EventnumberEvt1 != 0.001" >
               `EventnumberEvt1` = #{EventnumberEvt1}, 
          </if>
          <if test="EventnumberEvt2 != 0.001" >
                `EventnumberEvt2` = #{EventnumberEvt2},
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd1 != 0.001" >
                `ManufacturerspecificeventcodeEvtVnd1` = #{ManufacturerspecificeventcodeEvtVnd1},
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd2 != 0.001" >
                `ManufacturerspecificeventcodeEvtVnd2` = #{ManufacturerspecificeventcodeEvtVnd2},
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd3 != 0.001" >
                `ManufacturerspecificeventcodeEvtVnd3` = #{ManufacturerspecificeventcodeEvtVnd3},
          </if>
          <if test="ManufacturerspecificeventcodeEvtVnd4 != 0.001" >
                `ManufacturerspecificeventcodeEvtVnd4` = #{ManufacturerspecificeventcodeEvtVnd4},
          </if>
          
          
          
          
			  <if test="nvmActivePower != 0.001" >
			  	nvmActivePower = #{nvmActivePower},
			  </if>
			  <if test="nvmActiveEnergy != 0.001" >
			  	nvmActiveEnergy = #{nvmActiveEnergy},
			  </if>
			  <if test="MeasuredProduction != 0.001 and MeasuredProduction > 0">
				`MeasuredProduction` = #{MeasuredProduction},
			</if>
		</trim>
		
	</insert>
	
	
	<select id="checkAlertWriteCode" resultType="Map">
    	SELECT
				m.Manufacturerspecificstatuscode AS Manufacturerspecificstatuscode,
				m.ManufacturerspecificeventcodeEvtVnd1 AS ManufacturerspecificeventcodeEvtVnd1,
				m.ManufacturerspecificeventcodeEvtVnd2 AS ManufacturerspecificeventcodeEvtVnd2,
				m.ManufacturerspecificeventcodeEvtVnd3 AS ManufacturerspecificeventcodeEvtVnd3,
				m.ManufacturerspecificeventcodeEvtVnd4 AS ManufacturerspecificeventcodeEvtVnd4
	
			FROM
				${datatablename} m
			WHERE
				id_device = #{id_device}
			ORDER BY
				time DESC 
			LIMIT 20;
  	</select>
  	
  	
  	<select id="getListTriggerFaultCode" resultType="Map" parameterType="String">
		SELECT
			l.id,
			l.id_error,
			l.id_device,
			l.`status`,
			DATE_FORMAT(l.start_date,'%Y-%m-%d %H:%i:%s') AS start_date,
			DATE_FORMAT(NOW(),'%Y-%m-%d %H:%i:%s') AS end_date			
		FROM
			`alert` l
			LEFT JOIN error e ON e.id = l.id_error
			WHERE l.`status` = 1
			AND e.is_delete = 0 AND e.`status` = 1
			AND l.is_delete = 0 AND l.id_device = #{id_device}
			<if test="faultCodeLevel == 1">
				AND l.id_error IN(1716,1717,1718,17191720,1721,1722,1723,1724,1725,1726,1727,1728)
			</if>
			
			<if test="faultCodeLevel == 2">
				AND l.id_error IN(1760,1761,1762,1763,1764,1765,1766,1767,1768,1769,1770,1771,1772,1773,1774,1775,1776,1777,1778,1779,1780,1781,1782,1783,1784,1785,1786,1787,1788,1789,1790,1791,1792,1793,1794,1795,1796,1797,1798,1799,1800,1801,1802,1803,1804,1805)
			</if>
			
			<if test="faultCodeLevel == 3">
				AND l.id_error IN(1760,1761,1762,1763,1764,1765,1766,1767,1768,1769,1770,1771,1772,1773,1774,1775,1776,1777,1778,1779,1780,1781,1782,1783,1784,1785,1786,1787,1788,1789,1790,1791,1792,1793,1794,1795,1796,1797,1798,1799,1800,1801,1802,1803,1804,1805)
			</if>
			
			<if test="faultCodeLevel == 4">
				AND l.id_error IN(1760,1761,1762,1763,1764,1765,1766,1767,1768,1769,1770,1771,1772,1773,1774,1775,1776,1777,1778,1779,1780,1781,1782,1783,1784,1785,1786,1787,1788,1789,1790,1791,1792,1793,1794,1795,1796,1797,1798,1799,1800,1801,1802,1803,1804,1805)
			</if>
			
			<if test="faultCodeLevel == 5">
				AND l.id_error IN(1760,1761,1762,1763,1764,1765,1766,1767,1768,1769,1770,1771,1772,1773,1774,1775,1776,1777,1778,1779,1780,1781,1782,1783,1784,1785,1786,1787,1788,1789,1790,1791,1792,1793,1794,1795,1796,1797,1798,1799,1800,1801,1802,1803,1804,1805)
			</if>
			
			
	</select>
	
	
	
	<select id="getLastRow" resultType="com.nwm.api.entities.ModelSmaShp7510Entity">
		SELECT
			dv.*,
			s.enable_alert
		FROM
			${view_tablename} dv 
			LEFT JOIN device d ON d.id = dv.id_device
			LEFT JOIN site s ON s.id = d.id_site
		WHERE
			dv.id_device = #{id_device}
			<if test="time != null" >
	        	AND dv.time <![CDATA[<]]> #{time}
	        </if>
		ORDER BY
			dv.time DESC 
			LIMIT 1
	</select>
	
	
</mapper> 