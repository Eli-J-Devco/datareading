<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Site">
	<resultMap id="SiteMap"
		type="com.nwm.api.entities.SiteEntity">
		<result property="id" column="id" />
		<result property="id_company" column="id_company" />
		<result property="id_country" column="id_country" />
		<result property="id_time_zone" column="id_time_zone" />
		<result property="name" column="name" />
		<result property="street" column="street" />
		<result property="lat" column="lat" />
		<result property="lng" column="lng" />
		<result property="view_lat" column="view_lat" />
		<result property="view_lng" column="view_lng" />
		
		<result property="built_since" column="built_since" />
		<result property="old_data" column="old_data" />
		<result property="number" column="number" />
		<result property="postal_code" column="postal_code" />
		<result property="city" column="city" />
		<result property="state" column="state" />
		<result property="commissioning" column="commissioning" />
		<result property="emergency_contact" column="emergency_contact" />
		<result property="ac_capacity" column="ac_capacity" />
		<result property="dc_capacity" column="dc_capacity" />
		<result property="status" column="status" />
		<result property="is_delete" column="is_delete" />
		<result property="created_date" column="created_date" />
		<result property="created_by" column="created_by" />
		<result property="updated_date" column="updated_date" />
		<result property="updated_by" column="updated_by" />
		<result property="address_short" column="address_short" />
		
		<result property="watts_3ph_total" column="watts_3ph_total" />
		<result property="sensor1_data" column="sensor1_data" />
		<result property="w_hours_total" column="w_hours_total" />
		<result property="today_kwh" column="today_kwh" />
		<result property="total_energy_this_month" column="total_energy_this_month" />
		<result property="eer_this_month" column="eer_this_month" />
		<result property="eer_last_month" column="eer_last_month" />
		<result property="w_hours_received" column="w_hours_received" />
		<result property="total_error" column="total_error" />
		<result property="alert_list" column="alert_list" />
		<result property="gallery" column="gallery" />
		<result property="street_ws" column="street_ws" />
		<result property="localization_format" column="localization_format" />
		<result property="format_sql_short" column="format_sql_short" />
		<result property="format_sql_long" column="format_sql_long" />
		<result property="format_sql_string_short" column="format_sql_string_short" />
		<result property="format_sql_string_long" column="format_sql_string_long" />
		<result property="format_sql_string_mdy" column="format_sql_string_mdy" />
		<result property="offset_from" column="offset_from" />
		<result property="current_time" column="current_time" />
		<result property="data_send_time" column="data_send_time" />
		<result property="start_date_time" column="start_date_time" />
		<result property="end_date_time" column="end_date_time" />
		<result property="config_sunset_sunrise" column="config_sunset_sunrise" />
		<result property="note" column="note" />
		<result property="is_rec_report" column="is_rec_report" />
		<result property="datalogger_ip" column="datalogger_ip" />
		<result property="about" column="about" />
		<result property="kiosk_view" column="kiosk_view" />
		<result property="site_logo" column="site_logo" />
		<result property="id_site_group" column="id_site_group" />
		<result property="timezone_datalogger" column="timezone_datalogger" />
		<result property="unit_type_temp" column="unit_type_temp" />
		<result property="unit_wind_speed" column="unit_wind_speed" />
		
		<result property="ftp_server" column="ftp_server" />
		<result property="ftp_user" column="ftp_user" />
		<result property="ftp_pass" column="ftp_pass" />
		<result property="ftp_port" column="ftp_port" />
		<result property="ftp_folder" column="ftp_folder" />
		<result property="datalogger_type" column="datalogger_type" />
		<result property="is_supper_admin" column="is_supper_admin" />
		<result property="virtual_status" column="virtual_status" />
		<result property="enable_alert" column="enable_alert" />
		
		<result property="serial_number" column="serial_number" />
		<result property="mqtt_host" column="mqtt_host" />
		<result property="mqtt_port" column="mqtt_port" />
		<result property="mqtt_protocol" column="mqtt_protocol" />
		<result property="mqtt_username" column="mqtt_username" />
		<result property="mqtt_password" column="mqtt_password" />
		<result property="site_domain_type" column="site_domain_type" />
		
		
	
		
		
		
	</resultMap>
	
	<select id="getSummaryTotalAlert" resultType="com.nwm.api.entities.SiteEntity">
		SELECT
			COUNT( a.id ) AS total_error 
		FROM
			site s
			LEFT JOIN device d ON d.id_site = s.id
			LEFT JOIN alert a ON a.id_device = d.id 
			LEFT JOIN error e ON e.id = a.id_error
		WHERE
			s.`status` = 1 
			AND s.is_delete = 0 
			AND a.`status` = 1
			AND a.is_delete = 0
			AND e.`status` = 1
			AND e.`is_delete` = 0
			AND d.`status` = 1
			AND d.is_delete = 0
			<if test="id_sites != null">
				AND s.id IN  (
					<foreach item="item" index="index" collection="id_sites" separator=" , ">
						#{item.id}
					</foreach>
				)
			</if>
			AND s.enable_alert = 1
			
	</select>
	
	
	<select id="getSiteByEmployee" resultType="Map">
		SELECT
			s.id,
			SHA1(s.id) AS hash_id,
			s.`name`,
			s.`name` AS text,
			s.`name` AS label,
			s.id AS value,
			s.is_rec_report,
			s.datalogger_ip,
			em.first_name,
			em.last_name,
			sg.name AS site_group,
			s.id_site_group,
			s.id_site_sub_group,
			s.timezone_datalogger,
			s.unit_type_temp,
			s.unit_wind_speed,
			sg.order_id,
			s.street,
			s.city,
			s.postal_code,
			s.state,
			s.serial_number,
			s.mqtt_host,
			s.mqtt_port,
			s.mqtt_protocol,
			s.mqtt_username,
			s.mqtt_password,
			s.site_domain_type,
			IF(
				s.expiration IS NOT NULL
				AND CONVERT_TZ(NOW(), '+00:00', tz.offset) > DATE_SUB(s.expiration, INTERVAL 1 MONTH),
				1,
				0
			) AS expired,
			h.is_hiding,
			0 AS is_expand
			
		FROM
			site AS s
			LEFT JOIN site_employee_map sem ON sem.id_site = s.id 
			LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
			LEFT JOIN employee em ON em.id = sem.id_employee
			LEFT JOIN site_group sg ON sg.id = s.id_site_group
			LEFT JOIN (
				SELECT
					id_site,
					MAX(is_hiding) AS is_hiding
				FROM site_employee_map
				GROUP BY id_site
			) h ON h.id_site = s.id
			<if test="(keyword != null and keyword != '' and (sort_column == 'hardware_id' or sort_column == 'device_name' or sort_column == 'serial_number')) or (device_ac_rating != null and device_ac_rating != '' and device_ac_rating_condition != null and device_ac_rating_condition != '') or (ids_inverter_group != null) ">			
				LEFT JOIN device d ON s.id = d.id_site
			</if>
			
			<if test="(tag_site != null and tag_site != '') or (keyword != null and keyword != '' and sort_column == 'tag_site')">
		      LEFT JOIN (     
		        SELECT
		          t.`name`,
		          ts.id_site
		        FROM tag t
		          LEFT JOIN tag_site_map ts ON ts.id_tag = t.id
		        WHERE
			        <if test="tag_site != null and tag_site != ''">
					 	t.`name` = #{tag_site}
					</if>
					<if test="keyword != null and keyword != '' and sort_column == 'tag_site'">
					 	t.`name` = #{keyword}
					</if>
					
		          GROUP BY ts.id_site
		        ) tid ON tid.id_site = s.id
			</if>
			
 			<if test="(tag_device != null and tag_device != '') or (keyword != null and keyword != '' and sort_column == 'tag_device')">			        
		      LEFT JOIN (
		        SELECT
		          d.id_site,
		          d.id,
		          t.`name`
		        FROM tag t
		          LEFT JOIN tag_device_map td ON td.id_tag = t.id
		          LEFT JOIN device d ON d.id = td.id_device
		        WHERE
		        	<if test="tag_device != null and tag_device != ''">
						t.`name` = #{tag_device}
					</if>
					<if test="keyword != null and keyword != '' and sort_column == 'tag_device'">
					 	t.`name` = #{keyword}
					</if>
		         
		          GROUP BY id_site
		      ) td ON td.id_site = s.id
 			</if>
		WHERE
			s.is_delete = 0	
			AND s.`status` = 1 
			<if test="is_supper_admin != 1">
				AND sem.id_employee = #{id_employee}
				AND sem.is_hiding = 0
			</if>
			
			
			<if test="keyword != null and keyword != '' and sort_column == 'name'">
				AND s.name LIKE CONCAT("%",#{keyword}, "%")
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'street'">
				AND s.street LIKE CONCAT("%",#{keyword}, "%")
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'city'">
				AND s.city LIKE CONCAT("%",#{keyword}, "%")
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'state'">
				AND s.state LIKE CONCAT("%",#{keyword}, "%")
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'postal_code'">
				AND s.postal_code LIKE CONCAT("%",#{keyword}, "%")
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'site_id'">
				AND s.id = #{keyword}
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'customer_id'">
				AND em.first_name LIKE CONCAT("%",#{keyword}, "%")
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'hardware_id'">
				AND d.id = #{keyword}
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'device_name'">
				AND d.devicename LIKE CONCAT("%",#{keyword}, "%")
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'serial_number'">
				AND d.serial_number LIKE CONCAT("%",#{keyword}, "%")
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'tag_device'">
				AND td.name = #{keyword}
			</if>
			
			<if test="keyword != null and keyword != '' and sort_column == 'tag_site'">
				AND tid.name = #{keyword}
			</if>
			
			<if test="ac_capacity != null and ac_capacity != '' and ac_capacity_condition == 'more'">	
					AND s.ac_capacity <![CDATA[>]]> #{ac_capacity}
			</if>		
			<if test="ac_capacity != null and ac_capacity != '' and ac_capacity_condition == 'equal'">	
					AND s.ac_capacity <![CDATA[=]]> #{ac_capacity}
			</if>	
			<if test="ac_capacity != null and ac_capacity != '' and ac_capacity_condition == 'less'">	
					AND s.ac_capacity <![CDATA[<]]> #{ac_capacity}
			</if>
			
			
			<if test="dc_capacity != null and dc_capacity != '' and dc_capacity_condition == 'more'">	
					AND s.dc_capacity <![CDATA[>]]> #{dc_capacity}
			</if>		
			<if test="dc_capacity != null and dc_capacity != '' and dc_capacity_condition == 'equal'">	
					AND s.dc_capacity <![CDATA[=]]> #{dc_capacity}
			</if>	
			<if test="dc_capacity != null and dc_capacity != '' and dc_capacity_condition == 'less'">	
					AND s.dc_capacity <![CDATA[<]]> #{dc_capacity}
			</if>
			
			<if test="device_ac_rating != null and device_ac_rating != '' and device_ac_rating_condition == 'more'">	
					AND d.rating_ac_power <![CDATA[>]]> #{device_ac_rating}
			</if>		
			<if test="device_ac_rating != null and device_ac_rating != '' and device_ac_rating_condition == 'equal'">	
					AND d.rating_ac_power <![CDATA[=]]> #{device_ac_rating}
			</if>	
			<if test="device_ac_rating != null and device_ac_rating != '' and device_ac_rating_condition == 'less'">	
					AND d.rating_ac_power <![CDATA[<]]> #{device_ac_rating}
			</if>
			
			<if test="data_send_time != null and data_send_time != ''">	
					AND s.data_send_time = #{data_send_time}
			</if>
			
			<if test="built_since != null and built_since != '' and built_since_condition == 'more'">  
          			AND DATE_FORMAT(s.built_since, '%Y-%m-%d') <![CDATA[>]]> #{built_since}
	      	</if>   
	    	<if test="built_since != null and built_since != '' and built_since_condition == 'equal'">  
	          		AND DATE_FORMAT(s.built_since, '%Y-%m-%d') <![CDATA[=]]> #{built_since}
	     	</if> 
	      	<if test="built_since != null and built_since != '' and built_since_condition == 'less'"> 
	          		AND DATE_FORMAT(s.built_since, '%Y-%m-%d') <![CDATA[<]]> #{built_since}
	      	</if>
		      
	      	<if test="commissioning != null and commissioning != '' and commissioning_condition == 'more'"> 
	          		AND DATE_FORMAT(s.commissioning, '%Y-%m-%d') <![CDATA[>]]> #{commissioning}
	      	</if>   
	      	<if test="commissioning != null and commissioning != '' and commissioning_condition == 'equal'">  
	          		AND DATE_FORMAT(s.commissioning, '%Y-%m-%d') <![CDATA[=]]> #{commissioning}
	      	</if> 
	      	<if test="commissioning != null and commissioning != '' and commissioning_condition == 'less'"> 
	          		AND DATE_FORMAT(s.commissioning, '%Y-%m-%d') <![CDATA[<]]> #{commissioning}
	      	</if>
	      	
	      	<if test="ids_inverter_group != null">
				AND d.id_device_group IN  (
					<foreach item="item" index="index" collection="ids_inverter_group" separator=" , ">
						#{item.id}
					</foreach>
				)
			</if>
			
			<if test="tag_site != null and tag_site != ''">
		        AND tid.name = #{tag_site}
		    </if>
		    
		    <if test="tag_device != null and tag_device != ''">
		        AND td.name = #{tag_device}
		    </if>
			
			<if test="id_company != null and id_company != 0 and id_company > 1">
				AND s.id_company = #{id_company}
			</if>
			
			
			<choose>
			
				<when test="(domain == 'localhost' or domain == 'nextwavemonitoring.com' or domain == 'staging.nextwavemonitoring.com') and is_supper_admin == 1">
					AND s.site_domain_type IN(1,2,3)
				</when>
				
				<when test="(domain == 'demo.nextwavemonitoring.com')">
					AND s.site_domain_type IN(1,2,3)
				</when>
				
				<when test="domain == 'buildings.nextwavemonitoring.com'">
					AND s.site_domain_type IN(2,3)
				</when>
				
				<when test="(domain != 'nextwavemonitoring.com') and (domain != 'buildings.nextwavemonitoring.com') and is_supper_admin != 1">
					AND s.site_domain_type IN(2,3)
				</when>
				
				<otherwise>
					AND s.site_domain_type IN(1,3)
				</otherwise>
			</choose>
				
	      	
	      	
			
		GROUP BY s.id	
		ORDER BY s.`name`, s.id_company ASC;
			 
	</select>
	
	<select id="getSiteByEmployeeREC" resultType="Map">
		SELECT
			s.id,
			s.`name`,
			s.`name` AS text,
			s.`name` AS label,
			s.id AS value,
			s.is_rec_report,
			s.datalogger_ip,
			s.table_data_report,
			CAST(s.reporting_region AS UNSIGNED) AS reporting_region,
			JSON_ARRAYAGG(JSON_OBJECT(
				'id_site', s.id,
				'value', d.id,
				'label', d.devicename,
				'table_data_report', s.table_data_report,
				'reporting_region', CAST(s.reporting_region AS UNSIGNED)
			)) AS devicesJSON
		FROM
			site AS s
			LEFT JOIN site_employee_map sem ON sem.id_site = s.id 
			LEFT JOIN device d ON d.id_site = s.id AND d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0
		WHERE
			s.is_delete = 0 
			AND s.`status` = 1 
			AND d.is_delete = 0
			AND d.status = 1
			AND sem.id_employee = #{id_employee} AND s.is_rec_report = 1
		GROUP BY
			s.id
			 
	</select>
	
	<select id="getSiteGroupByEmployee" resultType="Map" >
		SELECT
			sg.id,
			sg.name,
			sg.order_id,
			sg.hash_id,
			0 AS is_expand,
			IF(
				COUNT(ssg.id) = 0,
				JSON_ARRAY(),
				JSON_ARRAYAGG(JSON_OBJECT(
					'id', ssg.id,
					'hash_id', SHA2(ssg.id, 512),
					'id_site_group', ssg.id_site_group,
					'name', ssg.name,
					'order_id', ssg.order_id,
					'is_expand', 1
				))
			) AS sub_group_list
		FROM
			(
				SELECT
					sg.id,
					sg.`name`,
					sg.order_id,
					SHA2(sg.id, 256) AS hash_id
				FROM
					site s
					LEFT JOIN site_employee_map sem ON sem.id_site = s.id
					LEFT JOIN site_group sg ON sg.id = s.id_site_group
				WHERE
					s.is_delete = 0
					AND s.status = 1
					AND sg.is_delete = 0
					AND sg.status = 1
					AND sem.id_employee = #{id_employee}
				GROUP BY sg.id
			) sg
			LEFT JOIN (
				SELECT
					COUNT(*) AS totalSites,
					id_site_group,
					id_site_sub_group
				FROM site
				GROUP BY id_site_sub_group
			) t ON t.id_site_group = sg.id AND t.totalSites > 0
		   LEFT JOIN site_sub_group ssg ON ssg.id_site_group = t.id_site_group AND ssg.status = 1 AND ssg.is_delete = 0
		GROUP BY sg.id
	    ORDER BY sg.order_id ASC
		 	 
	</select>
	
	<select id="getSubGroupByGroup" resultType="Map" >
		SELECT
			ssg.id,
			SHA2(ssg.id, 512) AS hash_id,
			ssg.id_site_group,
			ssg.`name`,
			ssg.order_id,
			1 AS is_expand
		FROM
			site_sub_group ssg
			LEFT JOIN site_group sg ON sg.id = ssg.id_site_group
			LEFT JOIN (
				SELECT
					COUNT(*) AS totalSites,
					id_site_sub_group
				FROM site
				GROUP BY id_site_sub_group
			) t ON t.id_site_sub_group = ssg.id
		WHERE 
			ssg.status = 1
			AND ssg.is_delete = 0
			AND sg.status = 1
			AND sg.is_delete = 0
			AND ssg.id_site_group = #{id}
			AND t.totalSites > 0
	    ORDER BY ssg.id ASC
	</select>
	
	<select id="getListEmployeeManageSite" resultType="Map" >
		SELECT
			s.id,
			SHA1(s.id) AS hash_id,
			scm.id_employee,
			s.`name`,
			DATE_FORMAT(s.built_since,'%m/%d/%Y') AS built_since,
			DATE_FORMAT(s.commissioning,'%m/%d/%Y') AS commissioning,
			s.street,
			IF(s.lat = 0 OR s.postal_code IS NOT NULL OR s.state IS NOT NULL, NULL, s.lat) AS lat,
			IF(s.lng = 0 OR s.postal_code IS NOT NULL OR s.state IS NOT NULL, NULL, s.lng) AS lng,
			IF(s.lat = 0, NULL, s.lat) AS view_lat,
			IF(s.lng = 0, NULL, s.lng) AS view_lng,
			s.number,
			s.postal_code,
			s.city,
			s.state,
			s.`status`,
			s.is_delete,
			s.ac_capacity,
			s.dc_capacity,
			s.data_send_time,
			s.start_date_time,
			s.end_date_time,
			s.config_sunset_sunrise,
			s.note,
			CONCAT_WS( ' ', c.first_name,c.last_name) AS customer_name,
			IF(t.is_manage,t.is_manage, 0) AS is_manage,
			s.is_rec_report,
			s.datalogger_ip,
			s.about,
			s.kiosk_view,
			s.site_logo,
			s.id_site_group,
			s.timezone_datalogger,
			s.unit_type_temp,
			s.unit_wind_speed,
			s.ftp_server,
			s.ftp_user,
			s.ftp_pass,
			s.ftp_port,
			s.ftp_folder,
			s.datalogger_type,
			s.enable_alert,
			s.serial_number,
			s.mqtt_host,
			s.mqtt_port,
			s.mqtt_protocol,
			s.mqtt_username,
			s.mqtt_password
		FROM
			site s
			LEFT JOIN site_employee_map scm ON scm.id_site = s.id
			LEFT JOIN employee c ON c.id = scm.id_employee
			LEFT JOIN (
				SELECT si.id, 1 AS is_manage FROM site_employee_map se 
				LEFT JOIN site si ON si.id = se.id_site WHERE se.id_employee = #{id_employee}
			)t ON t.id = s.id
		WHERE s.is_delete = 0 AND s.status = 1 
		<if test="is_supper_admin != 1">
			AND scm.id_employee = #{id_employee}
		</if> 
		
		<if test="id_company != null and id_company != 0 and id_company > 1">
			AND s.id_company = #{id_company}
		</if>
		
		
		<if test="keyword != null">
			AND s.name LIKE CONCAT("%",#{keyword}, "%")
		</if> 	
		GROUP BY s.id	 
		
	    order by
	        <choose>  
	            <when test="sort_column == 'id'">
	                s.id ${order_by}
	            </when>         
	            <when test="sort_column == 'name'">
	                s.name ${order_by}
	            </when>
	            <when test="sort_column == 'customer_name'">
	                customer_name ${order_by}
	            </when>
	            
	            <otherwise>
			      s.id DESC
			    </otherwise>                                                  
	        </choose>  
		 LIMIT ${limit} OFFSET ${offset};
	</select>
	
	<select id="getManageSiteTotalRecord"  resultType="int" parameterType="com.nwm.api.entities.SiteEntity">
    	SELECT count(*) as totalRecord
		FROM site s  
		LEFT JOIN site_employee_map scm ON scm.id_site = s.id
		WHERE s.is_delete = 0 AND s.status = 1 AND scm.id_employee = #{id_employee}
		<if test="keyword != null">
			AND s.name LIKE CONCAT("%",#{keyword}, "%")
		</if>
  	</select>
  	
  	
  	
  	<select id="checkExitsManageSite"  resultType="int" parameterType="com.nwm.api.entities.SiteEntity">
    	SELECT count(*) as totalRecord
		FROM site_employee_map s  WHERE s.id_employee = #{id_employee} AND s.id_site = #{id_site}
  	</select>
  	
  	
  	<insert id="insertSiteEmployeeMap" useGeneratedKeys="true" keyProperty="id_site">
		INSERT INTO `site_employee_map`(
			id_employee,
			id_site
		)VALUES(
			#{id_employee},
			#{id_site}
		);
		<selectKey keyProperty="id" resultType="int">
	        SELECT 
	        LAST_INSERT_ID() as id
        </selectKey>
	</insert>
	
	<update id="updateHidingSite">
		UPDATE `site_employee_map` sem
		LEFT JOIN (
			SELECT
				id_employee,
				MIN(id_role) AS id_role
			FROM employee_role_map
			GROUP BY id_employee
		) erm ON erm.id_employee = sem.id_employee
		SET
			`is_hiding` = #{is_hiding}
		WHERE
			sem.`id_site` = #{id}
			AND erm.id_role != 1
	</update>
  	
  	
  	
  	<update id="updateTableVirtualAndReport">
		UPDATE `site` 
		SET
			`table_data_virtual` = #{table_data_virtual},
			`table_data_report` = #{table_data_report}
		WHERE
			`id` = #{id}
	</update>
	
	
	<insert id="createTableReportSite">
		CREATE TABLE IF NOT EXISTS `site${id}_data_report` 
		  (
		  	  `time` datetime NOT NULL,
			  `id_device` int(11) NOT NULL,
			  `InverterUptime` int(2) DEFAULT NULL,
			  `DayTime` int(2) DEFAULT NULL,
			  `InverterUptimeDaytime` double DEFAULT NULL COMMENT 'Inverter Uptime/Daytime',
			  `ActualGeneration` double DEFAULT NULL COMMENT 'Actual Generation',
			  `EstimatedGeneration` double DEFAULT NULL COMMENT 'Estimated Generation',
			  `EstimatedGenerationIndex` double DEFAULT NULL COMMENT 'Estimated Generation Index (%)',
			  `InverterAvailability` double DEFAULT NULL COMMENT 'Inverter Availability',
			  `PowerTodayTotal` double DEFAULT NULL,
			  `PowerTodayAVG` double DEFAULT NULL,
			  `POATotal` double DEFAULT NULL,
			  `POAAVG` double DEFAULT NULL,
			  `TCellAVG` double DEFAULT NULL,
			  PRIMARY KEY (`time`,`id_device`) USING BTREE,
			  KEY `id_device` (`id_device`),
			  CONSTRAINT `fk_report${id}_site_data_report` FOREIGN KEY (`id_device`) REFERENCES `device` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
		  )
		  ENGINE=InnoDB DEFAULT CHARSET=utf8;
	</insert>
	
	
	
	
	
	<insert id="createTableVirtualDeviceSite">
		CREATE TABLE IF NOT EXISTS `model${id}_virtual_meter_or_inverter`
		  (
		  	  `time` datetime NOT NULL,
			  `id_device` int(11) NOT NULL,
			  `nvmActivePower` double DEFAULT NULL,
			  `nvmActiveEnergy` double DEFAULT NULL,
			  `nvm_irradiance` double DEFAULT NULL,
			  `nvm_temperature` double DEFAULT NULL,
			  `expected_power_dc` double DEFAULT NULL,
			  `expected_power_ac` double DEFAULT NULL,
			  `expected_energy` double DEFAULT NULL,
			  `r_irradiance` double DEFAULT NULL,
			  `total_poa` double DEFAULT NULL,
			  `panel_temp` double DEFAULT NULL,
			  `ambient_temp` double DEFAULT NULL,
			  `calculation_poa` double DEFAULT NULL,
			  `calculation_temp` double DEFAULT NULL,
			  `calculation_clipping` double DEFAULT NULL,
			  PRIMARY KEY (`time`,`id_device`) USING BTREE,
			  KEY `id_device` (`id_device`),
			  CONSTRAINT `fk_model_virtual_device${id}` FOREIGN KEY (`id_device`) REFERENCES `device` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
		  )
		  ENGINE=InnoDB DEFAULT CHARSET=utf8;
	</insert>
	
  	
  	
  	
  	<delete id = "deleteSiteEmployeeMap" parameterType = "com.nwm.api.entities.SiteEntity">
		DELETE from `site_employee_map` WHERE id_employee = #{id_employee} AND id_site = #{id_site};
	</delete>
	
	
	<delete id = "deleteSiteEmployeeMapEdit" parameterType = "com.nwm.api.entities.SiteEntity">
		DELETE from `site_employee_map` WHERE id_site = #{id};
	</delete>
  	
  	
  	<insert id="insertSite" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `site`(
			`id_company`,
			`id_country`,
			`id_time_zone`,
			`name`,
			`street`,
			`lat`,
			`lng`,
			`built_since`,
			`old_data`,
			`number`,
			`postal_code`,
			`city`,
			`state`,
			`commissioning`,
			`emergency_contact`,
			`ac_capacity`,
			`dc_capacity`,
			`gallery`,
			`data_send_time`,
			`start_date_time`,
			`end_date_time`,
			`config_sunset_sunrise`,
			`note`,
			`is_rec_report`,
			`reporting_region`,
			`datalogger_ip`,
			`about`,
			`kiosk_view`,
			`site_logo`,
			`diagram`,
			`id_site_group`,
			`id_site_sub_group`,
			`timezone_datalogger`,
			`unit_type_temp`,
			`unit_wind_speed`,
			`ftp_server`,
			`ftp_user`,
			`ftp_pass`,
			`ftp_port`,
			`ftp_folder`,
			`datalogger_type`,
			`is_show_each_meter`,
			`expiration`,
			`enable_alert`,
			`serial_number`,
			`mqtt_host`,
			`mqtt_port`,
			`mqtt_protocol`,
			`mqtt_username`,
			`mqtt_password`,
			`site_type`,
			`dashboard_overview_note`,
			`g_company_name`,
			`g_account_number`,
			`g_voltage_level_type`,
			`g_voltage_level`,
			`g_pcc_location`,
			`g_maximum_capacity`,
			`g_interconnection_agreement_details`,
			`g_grid_contraints`,
			`g_existing_ders`,
			`g_der_capacities`,
			`g_tariff_structure_rate_schedule`,
			`g_net_metering_feed_in_tariff`,
			`g_power_quality_requirements`,
			`g_transformer_size`,
			`g_transformer_type`,
			`g_status`,
			`g_lat`,
			`g_lng`,		
			`is_solar_site`
		)VALUES(
			#{id_company},
			#{id_country},
			#{id_time_zone},
			#{name},
			#{street},
			#{lat},
			#{lng},
			DATE_FORMAT(#{built_since}, '%Y-%m-%d'),
			#{old_data},
			#{number},
			#{postal_code},
			#{city},
			#{state},
			DATE_FORMAT(#{commissioning}, '%Y-%m-%d'),
			#{emergency_contact},
			#{ac_capacity},
			#{dc_capacity},
			#{gallery},
			#{data_send_time},
			#{start_date_time},
			#{end_date_time},
			#{config_sunset_sunrise},
			#{note},
			#{is_rec_report},
			#{reporting_region},
			#{datalogger_ip},
			#{about},
			#{kiosk_view},
			#{site_logo},
			#{diagram},
			#{id_site_group},
			#{id_site_sub_group},
			#{timezone_datalogger},
			#{unit_type_temp},
			#{unit_wind_speed},
			#{ftp_server},
			#{ftp_user},
			#{ftp_pass},
			#{ftp_port},
			#{ftp_folder},
			#{datalogger_type},
			#{is_show_each_meter},
			#{expiration},
			#{enable_alert},
			#{serial_number},
			#{mqtt_host},
			#{mqtt_port},
			#{mqtt_protocol},
			#{mqtt_username},
			#{mqtt_password},
			#{site_type},
			#{dashboard_overview_note},
			#{g_company_name},
			#{g_account_number},
			#{g_voltage_level_type},
			#{g_voltage_level},
			#{g_pcc_location},
			#{g_maximum_capacity},
			#{g_interconnection_agreement_details},
			#{g_grid_contraints},
			#{g_existing_ders},
			#{g_der_capacities},
			#{g_tariff_structure_rate_schedule},
			#{g_net_metering_feed_in_tariff},
			#{g_power_quality_requirements},
			#{g_transformer_size},
			#{g_transformer_type},
			#{g_status},
			#{g_lat},
			#{g_lng},
			#{is_solar_site}
		);
		<selectKey keyProperty="id" resultType="int">
	        SELECT 
	        LAST_INSERT_ID() as id
        </selectKey>
	</insert>
	
	<update id="updateSite">
		UPDATE `site`
		SET
			`id_company` = #{id_company},
			`id_country` = #{id_country},
			`id_time_zone` = #{id_time_zone},
			`name` = #{name},
			`street` = #{street},
			`lat` = #{lat},
			`lng` = #{lng},
			`built_since` = DATE_FORMAT(#{built_since}, '%Y-%m-%d'),
			`old_data` = #{old_data},
			`number` = #{number},
			`postal_code` = #{postal_code},
			`state` = #{state},
			`city` = #{city},
			`commissioning` = DATE_FORMAT(#{commissioning}, '%Y-%m-%d'),
			`emergency_contact` = #{emergency_contact},
			`ac_capacity` = #{ac_capacity},
			`dc_capacity` = #{dc_capacity},
			`gallery` = #{gallery},
			`data_send_time` = #{data_send_time},
			`start_date_time` = #{start_date_time},
			`end_date_time` = #{end_date_time},
			`config_sunset_sunrise` = #{config_sunset_sunrise},
			`note` = #{note},
			`is_rec_report` = #{is_rec_report},
			`reporting_region` = #{reporting_region},
			`datalogger_ip` = #{datalogger_ip},
			`about` = #{about},
			`kiosk_view` = #{kiosk_view},
			`site_logo` = #{site_logo},
			`diagram` = #{diagram},
			`id_site_group` = #{id_site_group},
			`id_site_sub_group` = #{id_site_sub_group},
			`timezone_datalogger` = #{timezone_datalogger},
			`unit_type_temp` = #{unit_type_temp},
			`unit_wind_speed` = #{unit_wind_speed},
			`ftp_server` = #{ftp_server},
			`ftp_user` = #{ftp_user},
			`ftp_pass` = #{ftp_pass},
			`ftp_port` = #{ftp_port},
			`ftp_folder` = #{ftp_folder},
			`datalogger_type` = #{datalogger_type},
			`expiration` = #{expiration},
			`is_show_each_meter` = #{is_show_each_meter},
			`enable_alert` = #{enable_alert},
			`serial_number` = #{serial_number},
			`mqtt_host` = #{mqtt_host},
			`mqtt_port` = #{mqtt_port},
			`mqtt_protocol` = #{mqtt_protocol},
			`mqtt_username` = #{mqtt_username},
			`mqtt_password` = #{mqtt_password},		
			`site_type` = #{site_type},
			`dashboard_overview_note` = #{dashboard_overview_note},
			`g_company_name` = #{g_company_name},
			`g_account_number` = #{g_account_number},
			`g_voltage_level_type` = #{g_voltage_level_type},
			`g_voltage_level` = #{g_voltage_level},
			`g_pcc_location` = #{g_pcc_location},
			`g_maximum_capacity` = #{g_maximum_capacity},
			`g_interconnection_agreement_details` = #{g_interconnection_agreement_details},
			`g_grid_contraints` = #{g_grid_contraints},
			`g_existing_ders` = #{g_existing_ders},
			`g_der_capacities` = #{g_der_capacities},
			`g_tariff_structure_rate_schedule` = #{g_tariff_structure_rate_schedule},
			`g_net_metering_feed_in_tariff` = #{g_net_metering_feed_in_tariff},
			`g_power_quality_requirements` = #{g_power_quality_requirements},
			`g_transformer_size` = #{g_transformer_size},
			`g_transformer_type` = #{g_transformer_type},
			`g_status` = #{g_status},
			`g_lat` = #{g_lat},
			`g_lng` = #{g_lng},
			`is_solar_site` = #{is_solar_site}
		WHERE
			`id` = #{id}
	</update>
  	
  	<select id="getList" resultType="com.nwm.api.entities.SiteEntity">
		SELECT
			s.id,
			SHA1(s.id) AS hash_id,
			s.id AS id_site,
			s.id_company,
			s.`name`,
			DATE_FORMAT(s.built_since,'%m/%d/%Y') AS built_since,
			DATE_FORMAT(s.commissioning,'%m/%d/%Y') AS commissioning,
			DATE_FORMAT(s.expiration,'%m/%d/%Y') AS expiration,
			s.street,
			s.lat,
			s.lng,
			IF(s.lat = 0, NULL, s.lat) AS view_lat,
			IF(s.lng = 0, NULL, s.lng) AS view_lng,
			s.number,
			s.postal_code,
			s.city,
			s.state,
			s.`status`,
			s.is_delete,
			s.ac_capacity,
			s.id_country,
			s.id_time_zone,
			s.dc_capacity,
			CONCAT_WS( ', ', s.number, s.street, s.city, s.state, s.postal_code ) AS address,
			s.site_default,
			s.gallery,
			s.data_send_time,
			s.start_date_time,
			s.end_date_time,
			s.config_sunset_sunrise,
			s.note,
			t.customer_name,
			t.ids_employee,
			s.is_rec_report,
			s.reporting_region,
			s.datalogger_ip,
			s.about,
			s.kiosk_view,
			s.site_logo,
			s.id_site_group,
			s.id_site_sub_group,
			s.timezone_datalogger,
			s.unit_type_temp,
			s.unit_wind_speed,
			c.name AS company,
			sg.name AS site_group,
			tz.name AS time_zone,
			IFNULL(DATE_FORMAT(al.modified_date,'%m/%d/%Y %H:%i:%s'), 'N/A') AS last_modified,
			s.ftp_server,
			s.ftp_user,
			s.ftp_pass,
			s.ftp_port,
			s.ftp_folder,
			s.datalogger_type,
			s.diagram,
			h.is_hiding,
			s.is_show_each_meter,
			COUNT(td.id_site) AS virtual_status,
			s.enable_alert,
			s.serial_number,
			s.mqtt_host,
			s.mqtt_port,
			s.mqtt_protocol,
			s.mqtt_username,
			s.mqtt_password,		
			s.site_type,
			s.dashboard_overview_note,
			s.b_year_built,
			s.g_company_name,
			s.g_account_number,
			s.g_voltage_level_type,
			s.g_voltage_level,
			s.g_pcc_location,
			s.g_maximum_capacity,
			s.g_interconnection_agreement_details,
			s.g_grid_contraints,
			s.g_existing_ders,
			s.g_der_capacities,
			s.g_tariff_structure_rate_schedule,
			s.g_net_metering_feed_in_tariff,
			s.g_power_quality_requirements,
			s.g_transformer_size,
			s.g_transformer_type,
			s.g_status,
			s.g_lat,
			s.g_lng,
			g.gas_company_name,
			g.gas_account_number,
			g.gas_average_daily_consumption,
			g.gas_peak_demand,
			g.gas_service_type,
			g.gas_service_pressure,
			g.gas_interconnection_agreement,
			g.gas_complicance_standard,
			g.gas_safety_features,
			g.gas_additional_notes,
			g.gas_billing_cycle,
			g.gas_billing_type,
			g.gas_tariff_structure,
			g.gas_billing_address,
			g.gas_status,
			w.water_company_name,
			w.water_account_number,
			w.water_service_connection_type,
			w.water_quality_standard,
			w.water_quality_parameter,
			w.water_billing_cycle,
			w.water_billing_type,
			w.water_tariff_structure,
			w.water_billing_address,
			w.water_additional_notes,
			w.water_status,
			e.electricity_company_name,
			e.electricity_account_number,
			e.electricity_average_daily_consumption,
			e.electricity_peak_demand,
			e.electricity_service_type,
			e.electricity_service_pressure,
			e.electricity_interconnection_agreement,
			e.electricity_complicance_standard,
			e.electricity_safety_features,
			e.electricity_additional_notes,
			e.electricity_billing_cycle,
			e.electricity_billing_type,
			e.electricity_tariff_structure,
			e.electricity_billing_address,
			e.electricity_limit_power,
			e.electricity_limit_power_unit,
			e.electricity_over_limit_power_cost,
			e.electricity_over_limit_power_per,
			e.electricity_over_limit_power_unit,		
			s.is_solar_site
		FROM
			site s
			LEFT JOIN site_employee_map sem ON sem.id_site = s.id
			
			LEFT JOIN (
				SELECT d.id_site FROM device d WHERE d.id_device_type = 12 GROUP BY d.id_site
			)td ON td.id_site = s.id
			
			LEFT JOIN (
				SELECT
					id_site,
					MAX(is_hiding) AS is_hiding
				FROM site_employee_map
				GROUP BY id_site
			) h ON h.id_site = s.id
			LEFT JOIN company c ON c.id = s.id_company
			LEFT JOIN site_group sg ON sg.id = s.id_site_group
			LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
			LEFT JOIN (
						SELECT id_site,
						MAX(modified_date) AS modified_date
						FROM auditing_logs
						GROUP BY id_site
						
			) al ON al.id_site = s.id
			LEFT JOIN (
						SELECT id_site, 
							GROUP_CONCAT(CONCAT_WS( ' ', c.first_name,c.last_name) SEPARATOR ', ') AS customer_name,
							GROUP_CONCAT(c.id SEPARATOR ', ') AS ids_employee
						FROM site_employee_map scm
						LEFT JOIN employee c ON c.id = scm.id_employee
						GROUP BY scm.id_site
					)t ON t.id_site = s.id
			LEFT JOIN site_gas g ON g.id_site = s.id
			LEFT JOIN site_water w ON w.id_site = s.id
			LEFT JOIN site_electricity e ON e.id_site = s.id
					
		WHERE s.is_delete = 0 AND s.`status` = 1
		<if test="is_supper_admin != 1">
			 AND sem.id_employee = #{id_employee}
		</if>

		<if test="keyword != null">
			AND (s.name LIKE CONCAT("%",#{keyword}, "%"))
		</if>
		
		<if test="id_company != null and id_company != 0 and id_company > 1">
			AND s.id_company = #{id_company}
		</if>
		
		
		GROUP BY s.id 
		
		
		
		 	
		    order by
	        <choose>  
	            <when test="sort_column == 'id'">
	                s.id ${order_by}
	            </when>         
	            <when test="sort_column == 'site_name'">
	                s.name ${order_by}
	            </when>
	            <when test="sort_column == 'customer_name'">
	                t.customer_name ${order_by}
	            </when>
	            <when test="sort_column == 'dc_capacity'">
	                dc_capacity ${order_by}
	            </when>
	             <when test="sort_column == 'ac_capacity'">
	                ac_capacity ${order_by}
	            </when>
	            <when test="sort_column == 'built_since'">
	                DATE_FORMAT(built_since,'%Y-%m-%d') ${order_by}
	            </when>
	            <when test="sort_column == 'company'">
	                company ${order_by}
	            </when>
	            <when test="sort_column == 'site_group'">
	                site_group ${order_by}
	            </when>
	            <when test="sort_column == 'commissioning'">
	                DATE_FORMAT(commissioning,'%Y-%m-%d') ${order_by}
	            </when>
	            <when test="sort_column == 'time_zone'">
	                time_zone ${order_by}
	            </when>
	            <when test="sort_column == 'data_send_time'">
	                s.data_send_time ${order_by}
	            </when>
	            
	            <when test="sort_column == 'last_modified'">
	                DATE_FORMAT(al.modified_date,'%Y-%m-%d') ${order_by}
	            </when>
	            
	            
	            
	            <when test="sort_column == 'status'">
	                status ${order_by}
	            </when>
	            
	            <otherwise>
			      s.`name`, s.id_company ASC
			    </otherwise>                                                  
	        </choose>  
		 	 
		 LIMIT ${limit} OFFSET ${offset};
	</select>
	
  	
	
	<select id="getListCount"  resultType="int" parameterType="com.nwm.api.entities.SiteEntity">
    	SELECT count(*) as totalRow
		FROM site s
		<if test="is_supper_admin != 1">
			 LEFT JOIN site_employee_map sem ON sem.id_site = s.id
		</if>
		WHERE s.`is_delete` = 0 AND s.`status` = 1
		<if test="is_supper_admin != 1">
			 AND sem.id_employee = #{id_employee}
		</if>
		
		<if test="keyword != null">
			AND (s.name LIKE CONCAT("%",#{keyword}, "%"))
		</if> 
		
		<if test="id_company != null and id_company != 0 and id_company > 1">
			AND s.id_company = #{id_company}
		</if>
		
  	</select>
  	
  	
  	<update id="updateStatus">
		UPDATE `site`
		SET
			`status` = #{status}
		WHERE
			`id` = #{id}
	</update>
	<update id="deleteSite">
		UPDATE `site`
		SET
			`is_delete` = #{is_delete}
		WHERE
			`id` = #{id}
	</update>
	
	<select id="getAllSiteByEmployee" resultType="Map">
		SELECT
			s.id,
			SHA1(s.id) AS hash_id,
			s.id_company,
			s.id_country,
			s.id_time_zone,
			s.`name`,
			s.street,
			IF(s.lat = 0, NULL, s.lat) AS lat,
			IF(s.lng = 0, NULL, s.lng) AS lng,
			IF(s.lat = 0, NULL, s.lat) AS view_lat,
			IF(s.lng = 0, NULL, s.lng) AS view_lng,
			built_since,
			s.old_data,
			s.number,
			s.postal_code,
			s.city,
			s.state,
			commissioning,
			s.emergency_contact,
			s.ac_capacity,
			s.dc_capacity,
			s.status,
			s.is_delete,
			s.created_date,
			s.created_by,
			s.updated_date,
			s.updated_by,
			s.gallery,
			s.data_send_time,
			s.start_date_time,
			s.end_date_time,
			s.config_sunset_sunrise,
			s.note,
			s.is_rec_report,
			s.datalogger_ip,
			s.about,
			s.kiosk_view,
			s.site_logo,
			s.id_site_group,
			s.timezone_datalogger,
			s.unit_type_temp,
			s.unit_wind_speed,
			s.ftp_server,
			s.ftp_user,
			s.ftp_pass,
			s.ftp_port,
			s.ftp_folder,
			s.datalogger_type,
			s.enable_alert,
			s.serial_number,
			s.mqtt_host,
			s.mqtt_port,
			s.mqtt_protocol,
			s.mqtt_username,
			s.mqtt_password
		FROM
			site AS s
		WHERE
			 s.is_delete = 0 AND s.`status` = 1
			 <if test="id_sites != null">
				AND s.id IN  (
					<foreach item="item" index="index" collection="id_sites" separator=" , ">
						#{item.id}
					</foreach>
				)
			</if>
	</select>
	
	<select id="getAllSite" resultMap="SiteMap" parameterType="String">
		SELECT
			s.id,
			SHA1(s.id) AS hash_id,
			s.id_company,
			s.id AS value,
			s.id_country,
			s.`name`,
			s.`name` AS label,
			s.street,
			IF(s.lat = 0, NULL, s.lat) AS lat,
			IF(s.lng = 0, NULL, s.lng) AS lng,
			IF(s.lat = 0, NULL, s.lat) AS view_lat,
			IF(s.lng = 0, NULL, s.lng) AS view_lng,
			built_since,
			s.old_data,
			s.number,
			s.postal_code,
			s.city,
			s.state,
			commissioning,
			s.emergency_contact,
			s.ac_capacity,
			s.dc_capacity,
			s.status,
			s.is_delete,
			s.created_date,
			s.created_by,
			s.updated_date,
			s.updated_by,
			s.gallery,
			s.note,
			s.is_rec_report,
			s.datalogger_ip,
			s.about,
			s.kiosk_view,
			s.site_logo,
			s.id_site_group,
			s.timezone_datalogger,
			s.unit_type_temp,
			s.unit_wind_speed,
			s.ftp_server,
			s.ftp_user,
			s.ftp_pass,
			s.ftp_port,
			s.ftp_folder,
			s.datalogger_type,
			s.enable_alert,
			s.serial_number,
			s.mqtt_host,
			s.mqtt_port,
			s.mqtt_protocol,
			s.mqtt_username,
			s.mqtt_password
		FROM
			site AS s
		WHERE s.is_delete = 0
		<if test="id_company != null and id_company != 0 and id_company > 1">
			AND s.id_company = #{id_company}
		</if>
		;
	</select>
	
	<select id="getAllSiteGroup" resultType="Map">
		SELECT
			id,
			name AS label
		FROM
			site_group
		WHERE
			status = 1
			AND is_delete = 0;
	</select>

	<select id="getAllSiteByIdCustomer" resultMap="SiteMap" parameterType="String">
		SELECT
			s.id,
			s.id_customer,
			s.id_country,
			s.id_time_zone,
			s.`name`,
			s.street,
			s.lat,
			s.lng,
			built_since,
			s.old_data,
			s.number,
			s.postal_code,
			s.city,
			s.state,
			commissioning,
			s.emergency_contact,
			s.ac_capacity,
			s.dc_capacity,
			s.status,
			s.is_delete,
			s.created_date,
			s.created_by,
			s.updated_date,
			s.updated_by,
			s.gallery,
			s.site_logo
		FROM
			site AS s
		WHERE
			s.id_customer = ${id_customer} AND s.is_delete = 0;
	</select>
	
	
	
  	
  	
  	<select id="getSiteCustomerById" resultMap="SiteMap" parameterType="Integer">
		SELECT
			COUNT( s.id ) AS total_site,
			ROUND(SUM( s.dc_capacity ),2) AS installed_capacity,
			SUM( t.expected_last_month ) AS expected_last_month,
			SUM( t.expected_this_month ) AS expected_this_month,
			ROUND(SUM( ivt.today_kwh ),0) AS measured_today,
			ms.w_hours_received,
			SUM( ms.w_hours_received - cFirstMonth.cfirst_month_w_hours_received ) AS measured_this_month,
			SUM( cFirstMonth.cfirst_month_w_hours_received - lFirstMonth.first_month_w_hours_received ) AS measured_last_month,
			ROUND( ( SUM( ms.w_hours_received - cFirstMonth.cfirst_month_w_hours_received ) / SUM( t.expected_this_month ) ) * 100, 2 ) AS err_this_month,
			ROUND( ( SUM( cFirstMonth.cfirst_month_w_hours_received - lFirstMonth.first_month_w_hours_received ) / SUM( t.expected_this_month ) ) * 100, 2 ) AS err_last_month,
			SUM( al.total_error ) AS total_error,
			DAY(LAST_DAY(NOW())) AS lday_off_month,
			ROUND(SUM( t.expected_this_month / DAY(LAST_DAY(NOW())) ), 0) AS expected_today,
			ROUND((SUM( ivt.today_kwh ) / SUM( t.expected_this_month / DAY(LAST_DAY(NOW())) )) * 100, 2) AS err_today,
			DATE_FORMAT(NOW(), '%M %d, %Y') AS today,
			DATE_FORMAT(NOW(), '%M 01, %Y') AS this_month,
			DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 MONTH), '%M 01, %Y') AS last_month
		FROM
			site s
			LEFT JOIN (
			SELECT
				en.id_site,
			CASE
					
					WHEN MONTH ( NOW( ) ) = 1 THEN
					en.`jan` 
					WHEN MONTH ( NOW( ) ) = 2 THEN
					en.`feb` 
					WHEN MONTH ( NOW( ) ) = 3 THEN
					en.`mar` 
					WHEN MONTH ( NOW( ) ) = 4 THEN
					en.`apr` 
					WHEN MONTH ( NOW( ) ) = 5 THEN
					en.`may` 
					WHEN MONTH ( NOW( ) ) = 6 THEN
					en.`jun` 
					WHEN MONTH ( NOW( ) ) = 7 THEN
					en.`jul` 
					WHEN MONTH ( NOW( ) ) = 8 THEN
					en.`aug` 
					WHEN MONTH ( NOW( ) ) = 9 THEN
					en.`sep` 
					WHEN MONTH ( NOW( ) ) = 10 THEN
					en.`oct` 
					WHEN MONTH ( NOW( ) ) = 11 THEN
					en.`nov` 
					WHEN MONTH ( NOW( ) ) = 12 THEN
					en.`dec` ELSE 0 
				END AS expected_this_month,
			CASE
					
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 1 THEN
					en.`jan` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 2 THEN
					en.`feb` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 3 THEN
					en.`mar` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 4 THEN
					en.`apr` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 5 THEN
					en.`may` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 6 THEN
					en.`jun` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 7 THEN
					en.`jul` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 8 THEN
					en.`aug` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 9 THEN
					en.`sep` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 10 THEN
					en.`oct` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 11 THEN
					en.`nov` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 12 THEN
					en.`dec` ELSE 0 
				END AS expected_last_month 
			FROM
				energy_expectations en
				LEFT JOIN site et ON et.id = en.id_site 
			WHERE
				en.`year` = YEAR ( NOW( ) ) 
			) t ON t.id_site = s.id
			LEFT JOIN (
			SELECT
				sh.id_device,
				sh.w_hours_received,
				de.id_site 
			FROM
				model_shark100 AS sh,
				( SELECT id_device, MAX( time ) AS sh_time FROM model_shark100 ms GROUP BY id_device ) AS max_sh
				LEFT JOIN device AS de ON de.id = max_sh.id_device 
			WHERE
				sh.id_device = max_sh.id_device 
				AND sh.time = max_sh.sh_time 
			) ms ON s.id = ms.id_site
			LEFT JOIN (
			SELECT
				ms.time,
				ms.id_device,
				ms.today_kwh,
				dv.id_site 
			FROM
				model_ivt_solaron_ext ms,
				( SELECT id_device, MAX( time ) AS transaction_time FROM model_ivt_solaron_ext GROUP BY id_device ) AS max_ms
				LEFT JOIN device AS dv ON dv.id = max_ms.id_device 
			WHERE
				ms.id_device = max_ms.id_device 
				AND ms.time = max_ms.transaction_time 
			) ivt ON ivt.id_site = s.id
			LEFT JOIN (
			SELECT
				sh.time,
				sh.w_hours_received AS cfirst_month_w_hours_received,
				di.id_site 
			FROM
				model_shark100 sh,
				(
				SELECT
					sh.id_device,
					sh.w_hours_received,
					MIN( time ) AS sh_time 
				FROM
					model_shark100 AS sh 
				WHERE
					YEAR ( sh.time ) = YEAR ( NOW( ) ) 
					AND MONTH ( sh.time ) = MONTH ( NOW( ) ) 
				GROUP BY
					id_device 
				) AS max_first_month
				LEFT JOIN device AS di ON di.id = max_first_month.id_device 
			WHERE
				sh.id_device = max_first_month.id_device 
				AND sh.time = max_first_month.sh_time 
			) cFirstMonth ON cFirstMonth.id_site = s.id
			LEFT JOIN (
			SELECT
				sh.time,
				sh.w_hours_received AS first_month_w_hours_received,
				di.id_site 
			FROM
				model_shark100 sh,
				(
				SELECT
					sh.id_device,
					sh.w_hours_received,
					MIN( time ) AS sh_time 
				FROM
					model_shark100 AS sh 
				WHERE
					YEAR ( sh.time ) = YEAR ( ADDDATE( NOW( ), INTERVAL - 1 MONTH ) ) 
					AND MONTH ( sh.time ) = MONTH ( ADDDATE( NOW( ), INTERVAL - 1 MONTH ) ) 
				GROUP BY
					id_device 
				) AS max_first_month
				LEFT JOIN device AS di ON di.id = max_first_month.id_device 
			WHERE
				sh.id_device = max_first_month.id_device 
				AND sh.time = max_first_month.sh_time 
			) lFirstMonth ON lFirstMonth.id_site = s.id
			LEFT JOIN (
			SELECT
				s.id AS id_site,
				COUNT( a.id ) AS total_error 
			FROM
				site s
				LEFT JOIN device d ON d.id_site = s.id
				RIGHT JOIN alert a ON a.id_device = d.id 
				AND a.`status` = 1
				LEFT JOIN error er ON a.id_error = er.id 
			GROUP BY
				s.id 
			) al ON al.id_site = s.id 
		WHERE
			s.id_customer = #{id_customer}
		GROUP BY
			s.id_customer;
	</select>
	
	
	<select id="getDetailSite" resultType="com.nwm.api.entities.SiteEntity" parameterType="com.nwm.api.entities.SiteEntity">
		SELECT
			CONCAT_WS( ", ", s.city, s.state ) AS address_short,
			CONCAT_WS( ", ", s.number, s.street ) AS street_ws,
			s.id,
			s.id_country,
			s.id_time_zone,
			s.`name`,
			s.lat,
			s.lng,
			s.old_data,
			s.number,
			s.street,
			s.postal_code,
			s.city,
			s.state,
			DATE_FORMAT( s.commissioning, '%m-%d-%Y' ) AS commissioning,
			s.emergency_contact,
			s.ac_capacity,
			s.dc_capacity,
			s.`status`,
			s.is_delete,
			s.created_date,
			s.created_by,
			s.updated_date,
			s.updated_by,
			DATE_FORMAT( s.built_since, '%m-%d-%Y' ) AS built_since,
			c.`name` AS country_name,
			s.gallery,
			c.localization_format,
			c.format_sql_short,
			c.format_sql_long,
			c.format_sql_string_short,
			c.format_sql_string_long,
			c.format_sql_string_mdy
		FROM
			site s 
			LEFT JOIN country c ON c.id = s.id_country
		WHERE
			s.id = #{id} 
			AND s.`status` = 1 
			AND s.is_delete = 0
	</select>
	
	<select id="getActiveAlarm" resultType="Map" >
		SELECT
			a.id,
			a.id_device,
			a.id_level,
			a.id_error,
			a.start_date,
			a.end_date,
			a.asset,
			a.capacity,
			a.`status`,
			al.`name` AS alert_level,
			e.error_code,
			e.message,
			d.devicename,
			d.id_site,
			CASE
		
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 DAY ) THEN TIMESTAMPDIFF( DAY, a.start_date, NOW( ) )
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 HOUR ) THEN TIMESTAMPDIFF( HOUR, a.start_date, NOW( ) )
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 MINUTE ) THEN TIMESTAMPDIFF( MINUTE, a.start_date, NOW( ) ) ELSE 0
				END AS times_ago,
				
				CASE
		
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 DAY ) THEN 'day'
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 HOUR ) THEN 'hour'
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 MINUTE ) THEN 'minute' ELSE 'now'
				END AS times_ago_unit
			
		FROM
			site s
			LEFT JOIN device d ON d.id_site = s.id
			RIGHT JOIN alert a ON a.id_device = d.id AND a.`status` = 1
			LEFT JOIN alert_level al ON al.id = a.id_level
			LEFT JOIN error e ON e.id = a.id_error 
		WHERE
			s.id = #{id}
			AND s.`status` = 1 
			AND s.is_delete = 0 LIMIT 6
	</select>
	
	
	<select id="getChartKPIDayIrradiance" resultType="Map" >
		SELECT
			s.id,
			s.id_time_zone,
			mr.id_device,
			DATE_FORMAT( mr.time, '%Y-%m-%d %H:%i:00' ) AS time,
			CONVERT_TZ( mr.time, '+00:00', t.`offset` ) AS local_time,
			DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%H:%i' ) AS time_day,
			mr.sensor1_data 
		FROM
			site s
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			LEFT JOIN device d ON d.id_site = s.id
			LEFT JOIN model_rt1_class30000 mr ON mr.id_device = d.id 
		WHERE
			s.id = #{id} 
			AND s.id_customer = #{id_customer}
			AND s.`status` = 1 
			AND s.is_delete = 0 
			AND YEAR ( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) = YEAR ( #{kpi_filter} ) 
			AND MONTH ( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) = MONTH ( #{kpi_filter} ) 
			AND DAY ( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) = DAY ( #{kpi_filter} )
	</select>
	
	
	<select id="getChartKPIDayPower" resultType="Map" >
		SELECT
			s.id,			
			DATE_FORMAT( mv.time, '%Y-%m-%d %H:%i:00' ) AS time,
			CONVERT_TZ( mv.time, '+00:00', t.`offset` ) AS local_time,
			DATE_FORMAT( CONVERT_TZ( mv.time, '+00:00', t.`offset` ), '%H:%i' ) AS time_day,
	
			mv.id_device,
			mv.ac_power
		FROM
			site s
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			LEFT JOIN device d ON d.id_site = s.id
			LEFT JOIN model_ivt_solaron_ext mv ON mv.id_device = d.id 
		WHERE
			s.id = #{id} 
			AND s.id_customer = #{id_customer}
			AND s.`status` = 1 
			AND s.is_delete = 0 
			AND YEAR ( CONVERT_TZ( mv.time, '+00:00', t.`offset` ) ) = YEAR ( #{kpi_filter} ) 
			AND MONTH ( CONVERT_TZ( mv.time, '+00:00', t.`offset` ) ) = MONTH ( #{kpi_filter} ) 
			AND DAY ( CONVERT_TZ( mv.time, '+00:00', t.`offset` ) ) = DAY ( #{kpi_filter} )
	</select>
	
	
	<select id="getChartKPIDayEnergy" resultType="Map" >
		SELECT
			t.*
			FROM
				(
					SELECT
						s.id,
						DATE_FORMAT( mv.time, '%Y-%m-%d %H' ) AS time,
						DATE_FORMAT(CONVERT_TZ( mv.time, '+00:00', t.`offset` ), '%Y-%m-%d %H') AS local_time,
						mv.id_device,
					mv.ytd_kwh_total 
					FROM
						site s
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
						LEFT JOIN device d ON d.id_site = s.id
						LEFT JOIN model_ivt_solaron_ext mv ON mv.id_device = d.id 
					WHERE
						s.id = #{id} 
						AND s.id_customer = #{id_customer} 
						AND s.`status` = 1 
						AND s.is_delete = 0 
						AND CONVERT_TZ( mv.time, '+00:00', t.`offset` ) BETWEEN #{kpi_filter} 
						AND  ADDDATE( #{kpi_filter} ,INTERVAL 1 DAY) 
					) t GROUP BY t.local_time
	</select>
	
	
	
	<select id="getChartKPIMonthPower" resultType="Map" >
		SELECT
			t.*,
			ROUND(SUM(t.ac_power),2)  AS total_month_ac_power
		FROM
			(
			SELECT
				s.id,
				DATE_FORMAT( mv.time, '%Y-%m-%d %H:%i:00' ) AS `utc_time`,
				CONVERT_TZ( mv.time, '+00:00', t.`offset` ) AS local_time,
				DATE_FORMAT( CONVERT_TZ( mv.time, '+00:00', t.`offset` ), '%d. %b' ) AS convert_time,
				DATE_FORMAT( CONVERT_TZ( mv.time, '+00:00', t.`offset` ), '%W, %b %d, %Y' ) AS full_time,
				mv.id_device,
				mv.ac_power 
			FROM
				site s
				LEFT JOIN time_zone t ON t.id = s.id_time_zone
				LEFT JOIN device d ON d.id_site = s.id
				LEFT JOIN model_ivt_solaron_ext mv ON mv.id_device = d.id 
			WHERE
				s.id = #{id}
				AND s.id_customer = #{id_customer}
				AND s.`status` = 1 
				AND s.is_delete = 0 
				AND mv.time IS NOT NULL
				AND YEAR ( CONVERT_TZ( mv.time, '+00:00', t.`offset` ) ) = YEAR ( #{kpi_filter} ) 
				AND MONTH ( CONVERT_TZ( mv.time, '+00:00', t.`offset` ) ) = MONTH ( #{kpi_filter} )
			) t 
		GROUP BY
			t.convert_time 
	</select>
	
	
	<select id="getChartKPIMonthInsolation" resultType="Map" >
		SELECT t.*, ROUND(AVG(t.sensor1_data) * 24/1000 ,2)  AS avg_month_sensor1_data FROM (
			SELECT
					s.id,
					s.id_time_zone,
					mr.id_device,
					DATE_FORMAT( mr.time, '%Y-%m-%d %H:%i:00' ) AS `utc_time`,
					CONVERT_TZ( mr.time, '+00:00', t.`offset` ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%H:%i' ) AS time_day,
					DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%d. %b' ) AS convert_time,
					DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%W, %b %d, %Y' ) AS full_time,
					mr.sensor1_data 
				FROM
					site s
					LEFT JOIN time_zone t ON t.id = s.id_time_zone
					LEFT JOIN device d ON d.id_site = s.id
					LEFT JOIN model_rt1_class30000 mr ON mr.id_device = d.id 
				WHERE
					s.id = #{id} 
					AND s.id_customer = #{id_customer}
					AND s.`status` = 1 
					AND s.is_delete = 0 
					AND mr.time IS NOT NULL
					AND YEAR ( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) = YEAR ( #{kpi_filter} ) 
					AND MONTH ( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) = MONTH ( #{kpi_filter} ) 
		)t GROUP BY t.convert_time
	</select>
	
	<select id="getChartKPIMonth" resultType="Map" >
		SELECT
			tmin.*,
			m.full_time,
			m.convert_time,
			MIN( tmin.ytd_kwh_total ) AS min_value,
			MAX( tmin.ytd_kwh_total ) AS max_value,
			ROUND(MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2) AS total_day_kw,
			m.avg_month_sensor1_data,
			IFNULL(ROUND( ((MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total )) / (m.avg_month_sensor1_data * tmin.ac_capacity)) * 100 ,2),0) AS day_pr
		FROM
			(
			SELECT
				iv.time,
				si.id,
				si.ac_capacity,
				iv.id_device,
				iv.ytd_kwh_total,
				DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS local_time
				
			FROM
				site si
				LEFT JOIN time_zone t ON t.id = si.id_time_zone
				LEFT JOIN device d ON d.id_site = si.id
				LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
			WHERE
				si.id = #{id}
				AND si.id_customer = #{id_customer}
				AND si.`status` = 1 
				AND si.is_delete = 0 
				AND iv.error = 0
				AND YEAR ( CONVERT_TZ( iv.time, '+00:00', t.`offset` ) ) = YEAR ( #{kpi_filter} ) 
				AND MONTH ( CONVERT_TZ( iv.time, '+00:00', t.`offset` ) ) = MONTH ( #{kpi_filter} ) 
				
			) tmin 
			LEFT JOIN (
				SELECT t.*, ROUND((AVG(t.sensor1_data) * 24)/1000 ,2)  AS avg_month_sensor1_data FROM (
						SELECT
								s.id,
								s.id_time_zone,
								mr.id_device,
								DATE_FORMAT( mr.time, '%Y-%m-%d %H:%i:00' ) AS `utc_time`,
								CONVERT_TZ( mr.time, '+00:00', t.`offset` ) AS local_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%H:%i' ) AS time_day,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%d. %b' ) AS convert_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%W, %b %d, %Y' ) AS full_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS mr_local_time,
								mr.sensor1_data 
							FROM
								site s
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
								LEFT JOIN device d ON d.id_site = s.id
								LEFT JOIN model_rt1_class30000 mr ON mr.id_device = d.id 
							WHERE
								s.id = #{id}
								AND s.id_customer = #{id_customer}
								AND s.`status` = 1 
								AND s.is_delete = 0 
								AND mr.time IS NOT NULL
								AND YEAR ( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) = YEAR ( #{kpi_filter} ) 
								AND MONTH ( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) = MONTH ( #{kpi_filter} ) 
					)t GROUP BY t.convert_time
			)m ON m.mr_local_time = tmin.local_time
		GROUP BY tmin.local_time
	</select>
	
	
	<select id="getChartKPIYear" resultType="Map" >
		SELECT
			tmin.*,
			m.full_time,
			m.convert_time,
			MIN( tmin.ytd_kwh_total ) AS min_value,
			MAX( tmin.ytd_kwh_total ) AS max_value,
			ROUND(MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2) AS total_month_kw,
			m.avg_month_sensor1_data,
			IFNULL(ROUND( ((MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total )) / (m.avg_month_sensor1_data * tmin.ac_capacity)) * 100 ,2),0) AS month_pr
		FROM
			(
			SELECT
				iv.time,
				si.id,
				si.ac_capacity,
				iv.id_device,
				iv.ytd_kwh_total,
				DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%Y-%m' ) AS local_time
				
			FROM
				site si
				LEFT JOIN time_zone t ON t.id = si.id_time_zone
				LEFT JOIN device d ON d.id_site = si.id
				LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
			WHERE
				si.id = #{id}
				AND si.id_customer = #{id_customer}
				AND si.`status` = 1 
				AND si.is_delete = 0 
				AND iv.error = 0
				AND YEAR ( CONVERT_TZ( iv.time, '+00:00', t.`offset` ) ) = YEAR ( #{kpi_filter} ) 
				
			) tmin 
			LEFT JOIN (
				SELECT t.*, ROUND((AVG(t.sensor1_data) * 24 * ((DAY(MAX(t.local_time)) + 1) - DAY(MIN(t.local_time))) )/1000 ,2)  AS avg_month_sensor1_data  FROM (
						SELECT
								s.id,
								s.id_time_zone,
								mr.id_device,
								DATE_FORMAT( mr.time, '%Y-%m-%d %H:%i:00' ) AS `utc_time`,
								CONVERT_TZ( mr.time, '+00:00', t.`offset` ) AS local_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%H:%i' ) AS time_day,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), "%b '%y" ) AS convert_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%W, %b %d, %Y' ) AS full_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y-%m' ) AS mr_local_time,
								mr.sensor1_data 
							FROM
								site s
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
								LEFT JOIN device d ON d.id_site = s.id
								LEFT JOIN model_rt1_class30000 mr ON mr.id_device = d.id 
							WHERE
								s.id = #{id}
								AND s.id_customer = #{id_customer}
								AND s.`status` = 1 
								AND s.is_delete = 0 
								AND mr.time IS NOT NULL
								AND YEAR ( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) = YEAR ( #{kpi_filter} ) 
					)t GROUP BY t.mr_local_time
			)m ON m.mr_local_time = tmin.local_time
		GROUP BY tmin.local_time
	</select>
	

	
	
	<select id="reportQuickQuery" resultType="Map" >
		SELECT
			d.devicename,
			DATE_FORMAT( CONVERT_TZ( sh.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:%i' ) AS local_time,
			DATE_FORMAT( CONVERT_TZ( sh.time, '+00:00', t.`offset` ), '%H:%i' ) AS local_hour,
			sh.* 
		FROM
			site s
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			LEFT JOIN device d ON d.id_site = s.id
			<if test="device_type == 1">
			LEFT JOIN model_ivt_solaron_ext sh ON d.id = sh.id_device
			</if>
			
			<if test="device_type == 2">
			LEFT JOIN model_shark100 sh ON d.id = sh.id_device
			</if>
			
			<if test="device_type == 4">
			LEFT JOIN model_rt1_class30000 sh ON d.id = sh.id_device
			</if>
			 
		WHERE
			d.id = #{id_device} 
			AND s.id = #{id} 
			AND s.`status` = 1 
			AND s.is_delete = 0 
			AND CONVERT_TZ( sh.time, '+00:00', t.`offset` ) BETWEEN #{start_date} 
			AND #{end_date}
	</select>

	
	
	<select id="getSpecificYieldMonth" resultType="Map" >
		SELECT
				tmin.*,
				ROUND( MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2 ) AS energy_day_kw,
				CONCAT_WS( ' - ', DATE_FORMAT( k.t_min, #{format_sql_string_mdy} ), DATE_FORMAT( k.t_max, #{format_sql_string_mdy} ) ) AS xAxisTitle 
			FROM
				(
				SELECT
					si.id,
					si.id_customer,
					iv.time,
					iv.ytd_kwh_total,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), #{format_sql_string_short} ) AS full_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%d. %b' ) AS convert_time
				FROM
					site si
					LEFT JOIN time_zone t ON t.id = si.id_time_zone
					LEFT JOIN device d ON d.id_site = si.id
					LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
				WHERE
					si.id = #{id}
					AND si.id_customer = #{id_customer}
					AND si.`status` = 1 
					AND si.is_delete = 0 
					AND iv.error = 0 
					AND CONVERT_TZ( iv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date}
				) tmin
				
				LEFT JOIN (
					SELECT
						t.* 
					FROM
						(
						SELECT
							s.id,
							s.id_customer,
							s.id_time_zone,
							mr.id_device,
							DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%d. %b' ) AS convert_time,
							DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS mr_local_time,
							MIN( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) AS t_min,
							MAX( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) AS t_max 
						FROM
							site s
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
							LEFT JOIN device d ON d.id_site = s.id
							LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
						WHERE
							s.id = #{id}
							AND s.id_customer = #{id_customer}
							AND s.`status` = 1 
							AND s.is_delete = 0 
							AND mr.time IS NOT NULL 
							AND CONVERT_TZ( mr.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date}
						) t 
					GROUP BY
						t.convert_time 
					) k ON k.id = tmin.id 

			GROUP BY
				tmin.local_time;
	</select>
	
	<select id="getSpecificYieldYear" resultType="Map" >
		SELECT
				tmin.*,
				ROUND( MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2 ) AS energy_month_kw,
				CONCAT_WS( ' - ', DATE_FORMAT( k.t_min, #{format_sql_string_mdy} ), DATE_FORMAT( k.t_max, #{format_sql_string_mdy} ) ) AS xAxisTitle 
			FROM
				(
				SELECT
					si.id,
					si.id_customer,
					iv.time,
					iv.ytd_kwh_total,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%Y-%m' ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), #{format_sql_string_short} ) AS full_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%b %Y' ) AS convert_time
				FROM
					site si
					LEFT JOIN time_zone t ON t.id = si.id_time_zone
					LEFT JOIN device d ON d.id_site = si.id
					LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
				WHERE
					si.id = #{id}
					AND si.id_customer = #{id_customer}
					AND si.`status` = 1 
					AND si.is_delete = 0 
					AND iv.error = 0 
					AND CONVERT_TZ( iv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date}
				) tmin
				
				LEFT JOIN (
					SELECT
						t.* 
					FROM
						(
						SELECT
							s.id,
							s.id_customer,
							s.id_time_zone,
							mr.id_device,
							DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%d. %b' ) AS convert_time,
							DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y-%m' ) AS mr_local_time,
							MIN( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) AS t_min,
							MAX( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) AS t_max 
						FROM
							site s
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
							LEFT JOIN device d ON d.id_site = s.id
							LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
						WHERE
							s.id = #{id}
							AND s.id_customer = #{id_customer}
							AND s.`status` = 1 
							AND s.is_delete = 0 
							AND mr.time IS NOT NULL 
							AND CONVERT_TZ( mr.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date}
						) t 
					GROUP BY
						t.convert_time 
					) k ON k.id = tmin.id 

			GROUP BY
				tmin.local_time;
	</select>
	
	
	<select id="getDailyReportSumary" resultType="Map" >
		SELECT
				tmin.*,
				ROUND( MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2 ) AS energy_today_kw,
				k.month_ytd_kwh_total,
				k.month_format_time,
				m.year_ytd_kwh_total,
				m.year_format_time
			FROM
				(
				SELECT
					si.id,
					d.devicename,
					si.id_customer,
					iv.time,
					iv.ytd_kwh_total,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), #{format_sql_short} ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), #{format_sql_string_short} ) AS full_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), #{format_sql_string_mdy} ) AS convert_time
				FROM
					site si
					LEFT JOIN time_zone t ON t.id = si.id_time_zone
					LEFT JOIN device d ON d.id_site = si.id
					LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
				WHERE
					si.id = #{id}
					AND si.id_customer = #{id_customer}
					AND si.`status` = 1 
					AND si.is_delete = 0 
					AND iv.error = 0 
					AND CONVERT_TZ( iv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date}
				) tmin
				
				LEFT JOIN (
					SELECT
						t.* 
						FROM
							(
							SELECT
								s.id,
								ROUND(MAX(mr.ytd_kwh_total) - MIN(mr.ytd_kwh_total),2) AS month_ytd_kwh_total,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y-%m' ) AS local_format_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%M %Y' ) AS month_format_time
							FROM
								site s
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
								LEFT JOIN device d ON d.id_site = s.id
								LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
							WHERE
								s.id = #{id}
								AND s.id_customer = #{id_customer}
								AND s.`status` = 1 
								AND s.is_delete = 0 
								AND mr.error = 0
								AND CONVERT_TZ( mr.time, '+00:00', t.`offset` ) BETWEEN CONCAT_WS('-',YEAR(#{start_date}), MONTH(#{start_date}), '01 00:00:00') AND #{end_date}
							) t 
						GROUP BY t.local_format_time
					) k ON k.id = tmin.id 
					
				LEFT JOIN (
					SELECT
						t.* 
						FROM
							(
							SELECT
								s.id,
								ROUND(MAX(mr.ytd_kwh_total) - MIN(mr.ytd_kwh_total),2) AS year_ytd_kwh_total,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y' ) AS local_format_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y' ) AS year_format_time
							FROM
								site s
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
								LEFT JOIN device d ON d.id_site = s.id
								LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
							WHERE
								s.id = #{id}
								AND s.id_customer = #{id_customer}
								AND s.`status` = 1 
								AND s.is_delete = 0 
								AND mr.error = 0
								AND CONVERT_TZ( mr.time, '+00:00', t.`offset` ) BETWEEN CONCAT_WS('-',YEAR(#{start_date}), '01-01 00:00:00') AND #{end_date}
							) t 
						GROUP BY t.local_format_time 	
				) m ON m.id = tmin.id 
			GROUP BY
				tmin.local_time;
	</select>
	
	
	<select id="getDailyReportChart" resultType="Map" >
	
		<if test="kpi_type == 'daily_report'">
			SELECT
				si.id,
				si.id_customer,
				iv.time,
				iv.ytd_kwh_total,
				CONCAT_WS('',DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), REPLACE(#{format_sql_long}, ":%i:%s", "")),':00') AS local_time,
				DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%H:00' ) AS convert_time,
				DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), #{format_sql_string_short} ) AS full_time
			FROM
				site si
				LEFT JOIN time_zone t ON t.id = si.id_time_zone
				LEFT JOIN device d ON d.id_site = si.id
				LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
			WHERE
				si.id = #{id} 
				AND si.id_customer = #{id_customer}
				AND si.`status` = 1 
				AND si.is_delete = 0 
				AND iv.error = 0 
				AND CONVERT_TZ( iv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} 
				AND #{end_date} 
			GROUP BY
				local_time;
		</if>
		
		<if test="kpi_type == 'monthly_report'">
			SELECT
				tmin.*,
				ROUND( MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2 ) AS energy_month_kw,
				CONCAT_WS( ' - ', DATE_FORMAT( k.t_min, #{format_sql_string_mdy} ), DATE_FORMAT( k.t_max, #{format_sql_string_mdy} ) ) AS xAxisTitle 
			FROM
				(
				SELECT
					si.id,
					si.id_customer,
					iv.time,
					iv.ytd_kwh_total,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%W, %b %d, %Y' ) AS full_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%d. %b' ) AS convert_time
				FROM
					site si
					LEFT JOIN time_zone t ON t.id = si.id_time_zone
					LEFT JOIN device d ON d.id_site = si.id
					LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
				WHERE
					si.id = #{id}
					AND si.id_customer = #{id_customer}
					AND si.`status` = 1 
					AND si.is_delete = 0 
					AND iv.error = 0 
					AND CONVERT_TZ( iv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date}
				) tmin
				
				LEFT JOIN (
					SELECT
						t.* 
					FROM
						(
						SELECT
							s.id,
							s.id_customer,
							s.id_time_zone,
							mr.id_device,
							DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%d. %b' ) AS convert_time,
							DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS mr_local_time,
							MIN( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) AS t_min,
							MAX( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) AS t_max 
						FROM
							site s
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
							LEFT JOIN device d ON d.id_site = s.id
							LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
						WHERE
							s.id = #{id}
							AND s.id_customer = #{id_customer}
							AND s.`status` = 1 
							AND s.is_delete = 0 
							AND mr.time IS NOT NULL 
							AND CONVERT_TZ( mr.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date}
						) t 
					GROUP BY
						t.convert_time 
					) k ON k.id = tmin.id 

			GROUP BY
				tmin.local_time;
		</if>
		
	</select>
	
	
	<select id="getReportVisualizationDevice" resultType="Map" >
		SELECT
				tmin.*,
				ROUND( MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2 ) AS energy_month_kw,
				CONCAT_WS( ' - ', DATE_FORMAT( k.t_min, #{format_sql_string_mdy} ), DATE_FORMAT( k.t_max, #{format_sql_string_mdy} ) ) AS xAxisTitle 
			FROM
				(
				SELECT
					si.id,
					si.id_customer,
					iv.time,
					iv.ytd_kwh_total,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%Y-%m' ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%b %Y' ) AS full_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, '+00:00', t.`offset` ), '%b %Y' ) AS convert_time
				FROM
					site si
					LEFT JOIN time_zone t ON t.id = si.id_time_zone
					LEFT JOIN device d ON d.id_site = si.id
					LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
				WHERE
					si.id = #{id_site}
					AND si.id_customer = #{id_customer}
					AND d.id = #{id_device}
					AND si.`status` = 1 
					AND si.is_delete = 0 
					AND iv.error = 0 
					AND CONVERT_TZ( iv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date}
				) tmin
				
				LEFT JOIN (
					SELECT
						t.* 
					FROM
						(
						SELECT
							s.id,
							s.id_customer,
							s.id_time_zone,
							mr.id_device,
							DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%d. %b' ) AS convert_time,
							DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y-%m' ) AS mr_local_time,
							MIN( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) AS t_min,
							MAX( CONVERT_TZ( mr.time, '+00:00', t.`offset` ) ) AS t_max 
						FROM
							site s
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
							LEFT JOIN device d ON d.id_site = s.id
							LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
						WHERE
							s.id = #{id_site}
							AND s.id_customer = #{id_customer}
							AND d.id = #{id_device}
							AND s.`status` = 1 
							AND s.is_delete = 0 
							AND mr.time IS NOT NULL 
							AND CONVERT_TZ( mr.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date}
						) t 
					GROUP BY
						t.convert_time 
					) k ON k.id = tmin.id 

			GROUP BY
				tmin.local_time;
	</select>
	
	<select id="getReportVisualizationDeviceDay" resultType="Map" >
		SELECT
			t.*,
			ROUND( MAX( t.ytd_kwh_total ) - MIN( t.ytd_kwh_total ), 2 ) AS hour_kwh_total,
			CONCAT_WS('',DATE_FORMAT( t.convert_time, REPLACE(#{format_sql_long}, ":%i:%s", "") ),':00') AS tooltip_date,
			DATE_FORMAT( t.convert_time, '%H:00' ) AS hour_time,
			DATE_FORMAT( t.convert_time, #{format_sql_string_short} ) AS xAxisTitle 
		FROM
			(
			SELECT
				s.id,
				mr.ac_power,
				mr.ytd_kwh_total,
				DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:%s:%i' ) AS convert_time,
				DATE_FORMAT( CONVERT_TZ( mr.time, '+00:00', t.`offset` ), '%Y-%m-%d %H' ) AS mr_local_time 
			FROM
				site s
				LEFT JOIN time_zone t ON t.id = s.id_time_zone
				LEFT JOIN device d ON d.id_site = s.id
				LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
			WHERE
				s.id = #{id_site}
				AND s.id_customer = #{id_customer}
				AND d.id = #{id_device}
				AND s.`status` = 1 
				AND s.is_delete = 0 
				AND mr.time IS NOT NULL 
				AND CONVERT_TZ( mr.time, '+00:00', t.`offset` ) BETWEEN #{start_date} 
				AND #{end_date} 
			) t 
		GROUP BY
			HOUR ( t.mr_local_time );
	</select>
	
	<select id="getAnnualComparison" resultType="Map" >
		SELECT t.*,
			(
			IFNULL(t.jan_kwh_total, 0) + IFNULL(t.feb_kwh_total, 0) + IFNULL(t.mar_kwh_total, 0) + IFNULL(t.apr_kwh_total, 0) + IFNULL(t.may_kwh_total, 0) + IFNULL(t.jun_kwh_total, 0) + IFNULL(t.jul_kwh_total, 0) + IFNULL(t.aug_kwh_total, 0) + IFNULL(t.sep_kwh_total, 0) + IFNULL(t.oct_kwh_total, 0) + IFNULL(t.nov_kwh_total, 0) + IFNULL(t.dec_kwh_total, 0)
			) AS year_total
			
			FROM (
				SELECT
					s.id,
					iv.time,
					iv.id_device,
					YEAR(iv.time) AS `year`,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=1 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=1 then iv.ytd_kwh_total end),0))/1000, 2 ) AS jan_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=2 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=2 then iv.ytd_kwh_total end),0))/1000, 2 ) AS feb_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=3 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=3 then iv.ytd_kwh_total end),0))/1000, 2 ) AS mar_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=4 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=4 then iv.ytd_kwh_total end),0))/1000, 2 ) AS apr_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=5 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=5 then iv.ytd_kwh_total end),0))/1000, 2 ) AS may_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=6 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=6 then iv.ytd_kwh_total end),0))/1000, 2 ) AS jun_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=7 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=7 then iv.ytd_kwh_total end),0))/1000, 2 ) AS jul_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=8 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=8 then iv.ytd_kwh_total end),0))/1000, 2 ) AS aug_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=9 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=9 then iv.ytd_kwh_total end),0))/1000, 2 ) AS sep_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=10 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=10 then iv.ytd_kwh_total end),0))/1000, 2 ) AS oct_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=11 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=11 then iv.ytd_kwh_total end),0))/1000, 2 ) AS nov_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=12 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, '+00:00', t.`offset`))=12 then iv.ytd_kwh_total end),0))/1000, 2 ) AS dec_kwh_total
					
				FROM
					site s 
					LEFT JOIN time_zone t ON t.id = s.id_time_zone
					LEFT JOIN device d ON d.id_site = s.id
					LEFT JOIN model_ivt_solaron_ext iv ON d.id = iv.id_device
					WHERE s.id = #{id_site} AND s.id_customer = #{id_customer} AND iv.error = 0 AND iv.ytd_kwh_total > 0 AND CONVERT_TZ( iv.time, t.`offset`, '+07:00') <![CDATA[<=]]> #{current_time}
					GROUP BY iv.id_device, YEAR(iv.time)
			)t GROUP BY t.id_device, YEAR(t.time)
	</select>
	
	<select id="getSitePerPage" resultType="Map">
		SELECT
			e.site_per_page
			
		FROM
			employee e
			
		WHERE 
			e.id = #{id_employee}
			LIMIT 1;
  	</select>
  	
  	<select id="getSiteDetail" resultType="com.nwm.api.entities.SiteEntity">
		SELECT
			s.id,
			s.id AS id_site,
			SHA1(s.id) AS hash_id,
			s.id_company,
			s.`name`,
			DATE_FORMAT(s.built_since,'%m/%d/%Y') AS built_since,
			DATE_FORMAT(s.commissioning,'%m/%d/%Y') AS commissioning,
			DATE_FORMAT(s.expiration,'%m/%d/%Y') AS expiration,
			s.street,
			s.lat,
			s.lng,
			IF(s.lat = 0, NULL, s.lat) AS view_lat,
			IF(s.lng = 0, NULL, s.lng) AS view_lng,
			s.number,
			s.postal_code,
			s.city,
			s.state,
			s.`status`,
			s.is_delete,
			s.ac_capacity,
			s.id_country,
			s.id_time_zone,
			s.dc_capacity,
			CONCAT_WS( ', ', s.number, s.street, s.city, s.state, s.postal_code ) AS address,
			s.site_default,
			s.gallery,
			s.data_send_time,
			s.start_date_time,
			s.end_date_time,
			s.config_sunset_sunrise,
			s.note,
			t.customer_name,
			t.ids_employee,
			s.is_rec_report,
			s.reporting_region,
			s.datalogger_ip,
			s.about,
			s.kiosk_view,
			s.site_logo,
			s.id_site_group,
			s.id_site_sub_group,
			s.timezone_datalogger,
			s.unit_type_temp,
			s.unit_wind_speed,
			c.name AS company,
			sg.name AS site_group,
			tz.name AS time_zone,
			IFNULL(DATE_FORMAT(al.modified_date,'%m/%d/%Y %H:%i:%s'), 'N/A') AS last_modified,
			s.ftp_server,
			s.ftp_user,
			s.ftp_pass,
			s.ftp_port,
			s.ftp_folder,
			s.datalogger_type,
			s.diagram,
			h.is_hiding,
			s.is_show_each_meter,
			COUNT(td.id_site) AS virtual_status,
			s.enable_alert,
			s.serial_number,
			s.mqtt_host,
			s.mqtt_port,
			s.mqtt_protocol,
			s.mqtt_username,
			s.mqtt_password,
			s.site_type,
			s.dashboard_overview_note,
			s.b_year_built,
			s.g_company_name,
			s.g_account_number,
			s.g_voltage_level_type,
			s.g_voltage_level,
			s.g_pcc_location,
			s.g_maximum_capacity,
			s.g_interconnection_agreement_details,
			s.g_grid_contraints,
			s.g_existing_ders,
			s.g_der_capacities,
			s.g_tariff_structure_rate_schedule,
			s.g_net_metering_feed_in_tariff,
			s.g_power_quality_requirements,
			s.g_transformer_size,
			s.g_transformer_type,
			s.g_status,
			s.g_lat,
			s.g_lng,
			t.dataEmployeeJSON,
			se.siteElectricityRateSchedulesJSON,
			sgg.siteGasRateSchedulesJSON,
			sw.siteWaterRateSchedulesJSON,
			sa.siteAreaJSON,
			sb.siteAreaBuildingJSON,
			sf.siteAreaBuildingFloorJSON,
			sr.siteAreaBuildingFloorRoomJSON,
			g.gas_company_name,
			g.gas_account_number,
			g.gas_average_daily_consumption,
			g.gas_peak_demand,
			g.gas_service_type,
			g.gas_service_pressure,
			g.gas_interconnection_agreement,
			g.gas_complicance_standard,
			g.gas_safety_features,
			g.gas_additional_notes,
			g.gas_billing_cycle,
			g.gas_billing_type,
			g.gas_tariff_structure,
			g.gas_billing_address,
			g.gas_status,
			w.water_company_name,
			w.water_account_number,
			w.water_service_connection_type,
			w.water_quality_standard,
			w.water_quality_parameter,
			w.water_billing_cycle,
			w.water_billing_type,
			w.water_tariff_structure,
			w.water_billing_address,
			w.water_additional_notes,
			w.water_status,
			e.electricity_company_name,
			e.electricity_account_number,
			e.electricity_average_daily_consumption,
			e.electricity_peak_demand,
			e.electricity_service_type,
			e.electricity_service_pressure,
			e.electricity_interconnection_agreement,
			e.electricity_complicance_standard,
			e.electricity_safety_features,
			e.electricity_additional_notes,
			e.electricity_billing_cycle,
			e.electricity_billing_type,
			e.electricity_tariff_structure,
			e.electricity_billing_address,
			e.electricity_limit_power,
			e.electricity_limit_power_unit,
			e.electricity_over_limit_power_cost,
			e.electricity_over_limit_power_per,
			e.electricity_over_limit_power_unit,
			s.is_solar_site
		FROM
			site s
			LEFT JOIN site_employee_map sem ON sem.id_site = s.id
			
			LEFT JOIN (
				SELECT d.id_site FROM device d WHERE d.id_device_type = 12 GROUP BY d.id_site
			)td ON td.id_site = s.id
			
			LEFT JOIN (
				SELECT
					id_site,
					MAX(is_hiding) AS is_hiding
				FROM site_employee_map
				GROUP BY id_site
			) h ON h.id_site = s.id
			LEFT JOIN company c ON c.id = s.id_company
			LEFT JOIN site_group sg ON sg.id = s.id_site_group
			LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
			LEFT JOIN (
						SELECT id_site,
						MAX(modified_date) AS modified_date
						FROM auditing_logs
						GROUP BY id_site
						
			) al ON al.id_site = s.id
			LEFT JOIN (
						SELECT scm.id_site, 
							GROUP_CONCAT(CONCAT_WS( ' ', c.first_name,c.last_name) SEPARATOR ', ') AS customer_name,
							GROUP_CONCAT(c.id SEPARATOR ', ') AS ids_employee,
							JSON_ARRAYAGG(JSON_OBJECT(
								'id', c.id,
								'value', c.id,
								'fullname', CONCAT_WS( ' ', c.first_name,c.last_name),
								'label', CONCAT_WS( ' ', c.first_name,c.last_name),
								'text', CONCAT_WS( ' ', c.first_name,c.last_name),
								'email', c.email
							)) AS dataEmployeeJSON
						FROM site_employee_map scm
						LEFT JOIN employee c ON c.id = scm.id_employee
						WHERE scm.id_site = #{id}
						GROUP BY scm.id_site
					)t ON t.id_site = s.id
			LEFT JOIN (
						SELECT
							sa.id_site,
							JSON_ARRAYAGG(JSON_OBJECT(
								'id_site', sa.id_site,
								'id', sa.id,
								'name', sa.name,
								'type', sa.type,
								'total_area', sa.total_area,
								'status', sa.status
							)) AS siteAreaJSON
						FROM
							site_area sa
						WHERE  sa.id_site = #{id}
						GROUP BY sa.id_site
					) sa ON sa.id_site = s.id
			LEFT JOIN (
						SELECT
							sb.id_site,
							JSON_ARRAYAGG(JSON_OBJECT(
								'id_area', sb.id_area,
								'id_site', sb.id_site,
								'id', sb.id,
								'name', sb.name,
								'type', sb.type,
								'total_area', sb.total_area,
								'status', sb.status
							)) AS siteAreaBuildingJSON
						FROM
							site_area_building sb
						WHERE sb.id_site = #{id}
						GROUP BY sb.id_site
					) sb ON sb.id_site = s.id
			LEFT JOIN (
						SELECT
							sf.id_site,
							JSON_ARRAYAGG(JSON_OBJECT(
								'id_building', sf.id_building,
								'id_site', sf.id_site,
								'id', sf.id,
								'name', sf.name,
								'type', sf.type,
								'total_area', sf.total_area,
								'status', sf.status
							)) AS siteAreaBuildingFloorJSON
						FROM
							site_area_building_floor sf
						WHERE sf.id_site = #{id}
				) sf ON sf.id_site = s.id
			LEFT JOIN (
						SELECT
							sr.id_site,
							JSON_ARRAYAGG(JSON_OBJECT(
								'id_floor', sr.id_floor,
								'id_site', sr.id_site,
								'id', sr.id,
								'name', sr.name,
								'type', sr.type,
								'total_area', sr.total_area,
								'status', sr.status
							)) AS siteAreaBuildingFloorRoomJSON
						FROM
							site_area_building_floor_room sr
						WHERE sr.id_site = #{id}
				) sr ON sr.id_site = s.id
			LEFT JOIN (
						SELECT
							sa.id_site_gas,
							JSON_ARRAYAGG(JSON_OBJECT(
								'id_site_gas', sa.id_site_gas,
								'id', sa.id,
								'cost', sa.cost,
								'unit', sa.unit,
								'date_from', sa.date_from,
								'date_to', sa.date_to,
								'status', sa.status,
								'cost_from', sa.cost_from,
								'cost_to', sa.cost_to		
							)) AS siteGasRateSchedulesJSON
						FROM
							site_gas_billing_rate_schedule sa
						WHERE  sa.id_site_gas = #{id}
						GROUP BY sa.id_site_gas
					) sgg ON sgg.id_site_gas = s.id	
			LEFT JOIN (
						SELECT
							sa.id_site_water,
							JSON_ARRAYAGG(JSON_OBJECT(
								'id_site_water', sa.id_site_water,
								'id', sa.id,
								'cost', sa.cost,
								'unit', sa.unit,
								'date_from', sa.date_from,
								'date_to', sa.date_to,
								'status', sa.status,
								'cost_from', sa.cost_from,
								'cost_to', sa.cost_to		
							)) AS siteWaterRateSchedulesJSON
						FROM
							site_water_billing_rate_schedule sa
						WHERE  sa.id_site_water = #{id}
						GROUP BY sa.id_site_water
					) sw ON sw.id_site_water = s.id
			LEFT JOIN (
						SELECT
							sa.id_site_electricity,
							JSON_ARRAYAGG(JSON_OBJECT(
								'id_site_electricity', sa.id_site_electricity,
								'id', sa.id,
								'cost', sa.cost,
								'unit', sa.unit,
								'date_from', sa.date_from,
								'date_to', sa.date_to,
								'time_from', sa.time_from,
								'time_to', sa.time_to,
								'status', sa.status,
								'kwh_from', sa.kwh_from,
								'kwh_to', sa.kwh_to		
							)) AS siteElectricityRateSchedulesJSON
						FROM
							site_electricity_billing_rate_schedule sa
						WHERE  sa.id_site_electricity = #{id}
						GROUP BY sa.id_site_electricity
					) se ON se.id_site_electricity = s.id
				
			LEFT JOIN site_gas g ON g.id_site = s.id
			LEFT JOIN site_water w ON w.id_site = s.id
			LEFT JOIN site_electricity e ON e.id_site = s.id
							
		WHERE s.is_delete = 0 AND s.`status` = 1 AND s.id = #{id}
		GROUP BY s.id
	</select>
  	
  	<insert id="insertSiteArea"  useGeneratedKeys="true" keyProperty="id" >
		INSERT INTO `site_area` (id, id_site, name, type, total_area, status)
	        VALUES
	        <foreach collection="areaList" item="item" index="" separator=",">
	            (#{item.id}, #{id_site}, #{item.name}, #{item.type}, #{item.total_area}, #{item.status})
	        </foreach>
	        ON DUPLICATE KEY UPDATE
	        id_site = VALUES(id_site),
	        name = VALUES(name),
	        type = VALUES(type),
	        total_area = VALUES(total_area),
	        status = VALUES(status)
	</insert>
	
	<insert id="insertSiteAreaBuilding"  useGeneratedKeys="true" keyProperty="id" >
		INSERT INTO `site_area_building` (id, id_site, id_area, name, type, total_area, status)
	        VALUES
	        <foreach collection="buildingList" item="item" index="" separator=",">
	            (#{item.id}, #{id_site}, #{item.id_area}, #{item.name}, #{item.type}, #{item.total_area}, #{item.status})
	        </foreach>
	        ON DUPLICATE KEY UPDATE
	        id_site = VALUES(id_site),
	        id_area = VALUES(id_area),
	        name = VALUES(name),
	        type = VALUES(type),
	        total_area = VALUES(total_area),
	        status = VALUES(status)
	</insert>
	
	<insert id="insertSiteAreaBuildingFloor"  useGeneratedKeys="true" keyProperty="id" >
		INSERT INTO `site_area_building_floor` (id, id_site, id_building, name, type, total_area, status)
	        VALUES
	        <foreach collection="floorList" item="item" index="" separator=",">
	            (#{item.id}, #{id_site}, #{item.id_building}, #{item.name}, #{item.type}, #{item.total_area}, #{item.status})
	        </foreach>
	        ON DUPLICATE KEY UPDATE
	        id_site = VALUES(id_site),
	        id_building = VALUES(id_building),
	        name = VALUES(name),
	        type = VALUES(type),
	        total_area = VALUES(total_area),
	        status = VALUES(status)
	</insert>
	
	<insert id="insertSiteAreaBuildingFloorRoom"  useGeneratedKeys="true" keyProperty="id" >
		INSERT INTO `site_area_building_floor_room` (id, id_site, id_floor, name, type, total_area, status)
	        VALUES
	        <foreach collection="roomList" item="item" index="" separator=",">
	            (#{item.id}, #{id_site}, #{item.id_floor}, #{item.name}, #{item.type}, #{item.total_area}, #{item.status})
	        </foreach>
	        ON DUPLICATE KEY UPDATE
	        id_site = VALUES(id_site),
	        id_floor = VALUES(id_floor),
	        name = VALUES(name),
	        type = VALUES(type),
	        total_area = VALUES(total_area),
	        status = VALUES(status)
	</insert>
	
	<insert id="insertSiteGasRateSchedules"  useGeneratedKeys="true" keyProperty="id" >
		INSERT INTO `site_gas_billing_rate_schedule` (id, id_site_gas, cost, unit, date_from, date_to, status, cost_from, cost_to)
	        VALUES
	        <foreach collection="gasRateSchedulesList" item="item" index="" separator=",">
	            (#{item.id}, #{item.id_site_gas}, #{item.cost}, #{item.unit}, #{item.date_from}, #{item.date_to}, #{item.status}, #{item.cost_from}, #{item.cost_to})
	        </foreach>
	        ON DUPLICATE KEY UPDATE
	        id_site_gas = VALUES(id_site_gas),
	        cost = VALUES(cost),
	        unit = VALUES(unit),
	        date_from = VALUES(date_from),
	        date_to = VALUES(date_to),
	        status = VALUES(status),
	        cost_from = VALUES(cost_from),
	        cost_to = VALUES(cost_to)
	</insert>
	
	<insert id="insertSiteWaterRateSchedules"  useGeneratedKeys="true" keyProperty="id" >
		INSERT INTO `site_water_billing_rate_schedule` (id, id_site_water, cost, unit, date_from, date_to, status, cost_from, cost_to)
	        VALUES
	        <foreach collection="waterRateSchedulesList" item="item" index="" separator=",">
	            (#{item.id}, #{item.id_site_water}, #{item.cost}, #{item.unit}, #{item.date_from}, #{item.date_to}, #{item.status}, #{item.cost_from}, #{item.cost_to})
	        </foreach>
	        ON DUPLICATE KEY UPDATE
	        id_site_water = VALUES(id_site_water),
	        cost = VALUES(cost),
	        unit = VALUES(unit),
	        date_from = VALUES(date_from),
	        date_to = VALUES(date_to),
	        status = VALUES(status),
	        cost_from = VALUES(cost_from),
	        cost_to = VALUES(cost_to)
	</insert>
	
	<insert id="insertSiteElectricityRateSchedules"  useGeneratedKeys="true" keyProperty="id" >
		INSERT INTO `site_electricity_billing_rate_schedule` (id, id_site_electricity, cost, unit, date_from, date_to, status, time_from, time_to, kwh_from, kwh_to)
	        VALUES
	        <foreach collection="electricityRateSchedulesList" item="item" index="" separator=",">
	            (#{item.id}, #{item.id_site_electricity}, #{item.cost}, #{item.unit}, #{item.date_from}, #{item.date_to}, #{item.status}, #{item.time_from}, #{item.time_to}, #{item.kwh_from}, #{item.kwh_to})
	        </foreach>
	        ON DUPLICATE KEY UPDATE
	        id_site_electricity = VALUES(id_site_electricity),
	        cost = VALUES(cost),
	        unit = VALUES(unit),
	        date_from = VALUES(date_from),
	        date_to = VALUES(date_to),
	        status = VALUES(status),
	        time_from = VALUES(time_from),
	        time_to = VALUES(time_to),
	        kwh_from = VALUES(kwh_from),
	        kwh_to = VALUES(kwh_to)
	</insert>
	
	<delete id="deleteSiteArea">
		DELETE FROM `site_area`
		WHERE id = #{id} AND id_site = #{id_site}
	</delete>
	
	<delete id="deleteSiteAreaBuilding">
		DELETE FROM `site_area_building`
		WHERE id = #{id} AND id_site = #{id_site}
	</delete>
	
	<delete id="deleteSiteAreaBuildingFloor">
		DELETE FROM `site_area_building_floor`
		WHERE id = #{id} AND id_site = #{id_site}
	</delete>
	
	<delete id="deleteSiteAreaBuildingFloorRoom">
		DELETE FROM `site_area_building_floor_room`
		WHERE id = #{id} AND id_site = #{id_site}
	</delete>
	
	<delete id="deleteSiteWaterRateSchedule">
		DELETE FROM `site_water_billing_rate_schedule`
		WHERE id = #{id} AND id_site_water = #{id_site_water}
	</delete>
	
	<delete id="deleteSiteGasRateSchedule">
		DELETE FROM `site_gas_billing_rate_schedule`
		WHERE id = #{id} AND id_site_gas = #{id_site_gas}
	</delete>
	
	<delete id="deleteSiteElectricityRateSchedule">
		DELETE FROM `site_electricity_billing_rate_schedule`
		WHERE id = #{id} AND id_site_electricity = #{id_site_electricity}
	</delete>
	
	<insert id="insertSiteGas"  useGeneratedKeys="true" keyProperty="id" >
		INSERT INTO `site_gas` (id_site, gas_company_name, gas_account_number, gas_average_daily_consumption, gas_peak_demand, gas_service_type, gas_service_pressure, gas_interconnection_agreement, gas_complicance_standard, gas_safety_features, gas_additional_notes, gas_billing_cycle, gas_billing_type, gas_tariff_structure, gas_billing_address, gas_status)
	        VALUES (#{id_site}, #{gas_company_name}, #{gas_account_number}, #{gas_average_daily_consumption}, #{gas_peak_demand}, #{gas_service_type}, #{gas_service_pressure}, #{gas_interconnection_agreement}, #{gas_complicance_standard}, #{gas_safety_features}, #{gas_additional_notes}, #{gas_billing_cycle},  #{gas_billing_type}, #{gas_tariff_structure}, #{gas_billing_address}, #{gas_status})
	        ON DUPLICATE KEY UPDATE
	        gas_company_name = VALUES(gas_company_name),
	        gas_account_number = VALUES(gas_account_number),
	        gas_average_daily_consumption = VALUES(gas_average_daily_consumption),
	        gas_peak_demand = VALUES(gas_peak_demand),
	        gas_service_type = VALUES(gas_service_type),
	        gas_service_pressure = VALUES(gas_service_pressure),
	        gas_interconnection_agreement = VALUES(gas_interconnection_agreement),
	        gas_complicance_standard = VALUES(gas_complicance_standard),
	        gas_safety_features = VALUES(gas_safety_features),
	        gas_additional_notes = VALUES(gas_additional_notes),        
	        gas_billing_cycle = VALUES(gas_billing_cycle),
	        gas_billing_type = VALUES(gas_billing_type),        
	        gas_tariff_structure = VALUES(gas_tariff_structure),
	        gas_billing_address = VALUES(gas_billing_address),
	        gas_status = VALUES(gas_status)	        
	</insert>
	
	<insert id="insertSiteWater"  useGeneratedKeys="true" keyProperty="id" >
		INSERT INTO `site_water` (id_site, water_company_name, water_account_number, water_service_connection_type, water_quality_standard, water_quality_parameter, water_billing_cycle, water_billing_type, water_tariff_structure, water_billing_address, water_additional_notes, water_status)
	        VALUES (#{id_site}, #{water_company_name}, #{water_account_number}, #{water_service_connection_type}, #{water_quality_standard}, #{water_quality_parameter}, #{water_billing_cycle}, #{water_billing_type}, #{water_tariff_structure}, #{water_billing_address}, #{water_additional_notes}, #{water_status})
	        ON DUPLICATE KEY UPDATE
	        water_company_name = VALUES(water_company_name),
	        water_account_number = VALUES(water_account_number),
	        water_service_connection_type = VALUES(water_service_connection_type),
	        water_quality_standard = VALUES(water_quality_standard),
	        water_quality_parameter = VALUES(water_quality_parameter),
	        water_billing_cycle = VALUES(water_billing_cycle),
	        water_billing_type = VALUES(water_billing_type),
	        water_tariff_structure = VALUES(water_tariff_structure),
	        water_billing_address = VALUES(water_billing_address),
	        water_additional_notes = VALUES(water_additional_notes),        
	        water_status = VALUES(water_status)        
	</insert>
	
	<insert id="insertSiteElectricity"  useGeneratedKeys="true" keyProperty="id" >
		INSERT INTO `site_electricity` (id_site, electricity_company_name, electricity_account_number, electricity_average_daily_consumption, electricity_peak_demand, electricity_service_type, electricity_service_pressure, electricity_interconnection_agreement, electricity_complicance_standard, electricity_safety_features, electricity_additional_notes, electricity_billing_cycle, electricity_billing_type, electricity_tariff_structure, electricity_billing_address, electricity_limit_power, electricity_limit_power_unit, electricity_over_limit_power_cost, electricity_over_limit_power_per, electricity_over_limit_power_unit, electricity_status)
	        VALUES (#{id_site}, #{electricity_company_name}, #{electricity_account_number}, #{electricity_average_daily_consumption}, #{electricity_peak_demand}, #{electricity_service_type}, #{electricity_service_pressure}, #{electricity_interconnection_agreement}, #{electricity_complicance_standard}, #{electricity_safety_features}, #{electricity_additional_notes}, #{electricity_billing_cycle}, #{electricity_billing_type}, #{electricity_tariff_structure}, #{electricity_billing_address}, #{electricity_limit_power}, #{electricity_limit_power_unit}, #{electricity_over_limit_power_cost}, #{electricity_over_limit_power_per}, #{electricity_over_limit_power_unit}, #{electricity_status})
	        ON DUPLICATE KEY UPDATE
	        electricity_company_name = VALUES(electricity_company_name),
	        electricity_account_number = VALUES(electricity_account_number),
	        electricity_average_daily_consumption = VALUES(electricity_average_daily_consumption),
	        electricity_peak_demand = VALUES(electricity_peak_demand),
	        electricity_service_type = VALUES(electricity_service_type),
	        electricity_service_pressure = VALUES(electricity_service_pressure),
	        electricity_interconnection_agreement = VALUES(electricity_interconnection_agreement),
	        electricity_complicance_standard = VALUES(electricity_complicance_standard),
	        electricity_safety_features = VALUES(electricity_safety_features),
	        electricity_additional_notes = VALUES(electricity_additional_notes),        
	        electricity_billing_cycle = VALUES(electricity_billing_cycle),
	        electricity_billing_type = VALUES(electricity_billing_type),
	        electricity_tariff_structure = VALUES(electricity_tariff_structure),
	        electricity_billing_address = VALUES(electricity_billing_address),
	        electricity_limit_power = VALUES(electricity_limit_power),
	        electricity_limit_power_unit = VALUES(electricity_limit_power_unit),
	        electricity_over_limit_power_cost = VALUES(electricity_over_limit_power_cost),
	        electricity_over_limit_power_per = VALUES(electricity_over_limit_power_per),
	        electricity_over_limit_power_unit = VALUES(electricity_over_limit_power_unit),
	        electricity_status = VALUES(electricity_status)  
	</insert>
	
</mapper>