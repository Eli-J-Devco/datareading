<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ModelXGI1500">

	<insert id="insertModelXGI1500" useGeneratedKeys="true"
		keyProperty="time">
		INSERT INTO `${datatablename}`
		<trim prefix="(" suffix=")" suffixOverrides="," >
		  <if test="time != null" >
                `time`,
          </if>
		  
		  <if test="id_device != 0.001" >
                `id_device`,
          </if>
		  
		  <if test="error != 0.001" >
                `error`,
          </if>
		  
		  <if test="low_alarm != 0.001" >
                `low_alarm`,
          </if>
		  
		  <if test="high_alarm != 0.001" >
                `high_alarm`,
          </if>
		  
		  <if test="ACCurrentAverage != 0.001" >
                `ACCurrentAverage`,
          </if>
          <if test="ACCurrentA != 0.001" >
                `ACCurrentA`,
          </if>
          <if test="ACCurrentB != 0.001" >
                `ACCurrentB`,
          </if>
          <if test="ACCurrentC != 0.001" >
                `ACCurrentC`,
          </if>
          <if test="ACVoltageAB != 0.001" >
                `ACVoltageAB`,
          </if>
          <if test="ACVoltageBC != 0.001" >
                `ACVoltageBC`,
          </if>
          <if test="ACVoltageCA != 0.001" >
                `ACVoltageCA`,
          </if>
          <if test="ACVoltageAN != 0.001" >
               `ACVoltageAN`, 
          </if>
          <if test="ACVoltageBN != 0.001" >
                `ACVoltageBN`,
          </if>
          <if test="ACVoltageCN != 0.001" >
                `ACVoltageCN`,
          </if>
          <if test="ActivePower != 0.001" >
                `ActivePower`,
          </if>
          <if test="Frequency != 0.001" >
                `Frequency`,
          </if>
          <if test="ApparentPower != 0.001" >
                `ApparentPower`,
          </if>
          <if test="ReactivePower != 0.001" >
                `ReactivePower`,
          </if>
          <if test="PowerFactor != 0.001" >
                `PowerFactor`,
          </if>
          <if test="ActiveEnergyRawNet != 0.001" >
                `ActiveEnergyRawNet`,
          </if>
          <if test="DCVoltage != 0.001" >
                `DCVoltage`,
          </if>
          <if test="OperatingState != 0.001" >
                `OperatingState`,
          </if>
          <if test="OperatingStatus != 0.001" >
                `OperatingStatus`,
          </if>
          <if test="FaultStatus != 0.001" >
                `FaultStatus`,
          </if>
          <if test="Fault1 != 0.001" >
                `Fault1`,
          </if>
          <if test="Fault2 != 0.001" >
                `Fault2`,
          </if>
          <if test="Fault3 != 0.001" >
                `Fault3`,
          </if>

          <if test="SerialNumberHex4Reg != 0.001" >
                `SerialNumberHex4Reg`,
          </if>
          <if test="CabinetTemperature != 0.001" >
                `CabinetTemperature`,
          </if>
          <if test="InternalTemperature != 0.001" >
                `InternalTemperature`,
          </if>
          <if test="IMITemperature != 0.001" >
                `IMITemperature`,
          </if>
          <if test="ControlDeviceOnOff != 0.001" >
                `ControlDeviceOnOff`,
          </if>
          <if test="ActivePowerSetpointPercent != 0.001" >
                `ActivePowerSetpointPercent`,
          </if>
          <if test="ActivePowerControlEnable != 0.001" >
                `ActivePowerControlEnable`,
          </if>
          <if test="PowerFactorSetpoint != 0.001" >
                `PowerFactorSetpoint`,
          </if>
          <if test="PowerFactorControlEnable != 0.001" >
                `PowerFactorControlEnable`,
          </if>
          <if test="ReactivePowerSetpointPercent != 0.001" >
                `ReactivePowerSetpointPercent`,
          </if>
          <if test="ReactivePowerControlEnable != 0.001" >
               `ReactivePowerControlEnable`, 
          </if>
          
         
		  <if test="nvmActivePower != 0.001" >
		  	`nvmActivePower`,
		  </if>
		  <if test="nvmActiveEnergy != 0.001" >
		  	`nvmActiveEnergy`,
		  </if>
		  <if test="MeasuredProduction != 0.001">
				`MeasuredProduction`,
			</if>
		</trim>
		
		<trim prefix="values (" suffix=")" suffixOverrides="," >
			  <if test="time != null" >
                #{time},
	          </if>
			  
			  <if test="id_device != 0.001" >
	                #{id_device},
	          </if>
			  
			  <if test="error != 0.001" >
	                #{error},
	          </if>
			  
			  <if test="low_alarm != 0.001" >
	                #{low_alarm},
	          </if>
			  
			  <if test="high_alarm != 0.001" >
	                #{high_alarm},
	          </if>
			  
			    <if test="ACCurrentAverage != 0.001" >
                #{ACCurrentAverage},
          </if>
          <if test="ACCurrentA != 0.001" >
                #{ACCurrentA},
          </if>
          <if test="ACCurrentB != 0.001" >
                #{ACCurrentB},
          </if>
          <if test="ACCurrentC != 0.001" >
                #{ACCurrentC},
          </if>
          <if test="ACVoltageAB != 0.001" >
                #{ACVoltageAB},
          </if>
          <if test="ACVoltageBC != 0.001" >
                #{ACVoltageBC},
          </if>
          <if test="ACVoltageCA != 0.001" >
                #{ACVoltageCA},
          </if>
          <if test="ACVoltageAN != 0.001" >
               #{ACVoltageAN}, 
          </if>
          <if test="ACVoltageBN != 0.001" >
                #{ACVoltageBN},
          </if>
          <if test="ACVoltageCN != 0.001" >
                #{ACVoltageCN},
          </if>
          <if test="ActivePower != 0.001" >
                #{ActivePower},
          </if>
          <if test="Frequency != 0.001" >
                #{Frequency},
          </if>
          <if test="ApparentPower != 0.001" >
                #{ApparentPower},
          </if>
          <if test="ReactivePower != 0.001" >
                #{ReactivePower},
          </if>
          <if test="PowerFactor != 0.001" >
                #{PowerFactor},
          </if>
          <if test="ActiveEnergyRawNet != 0.001" >
                #{ActiveEnergyRawNet},
          </if>
          <if test="DCVoltage != 0.001" >
                #{DCVoltage},
          </if>
          <if test="OperatingState != 0.001" >
                #{OperatingState},
          </if>
          <if test="OperatingStatus != 0.001" >
                #{OperatingStatus},
          </if>
          <if test="FaultStatus != 0.001" >
                #{FaultStatus},
          </if>
          <if test="Fault1 != 0.001" >
                #{Fault1},
          </if>
          <if test="Fault2 != 0.001" >
                #{Fault2},
          </if>
          <if test="Fault3 != 0.001" >
                #{Fault3},
          </if>

          <if test="SerialNumberHex4Reg != 0.001" >
                #{SerialNumberHex4Reg},
          </if>
          <if test="CabinetTemperature != 0.001" >
                #{CabinetTemperature},
          </if>
          <if test="InternalTemperature != 0.001" >
                #{InternalTemperature},
          </if>
          <if test="IMITemperature != 0.001" >
                #{IMITemperature},
          </if>
          <if test="ControlDeviceOnOff != 0.001" >
                #{ControlDeviceOnOff},
          </if>
          <if test="ActivePowerSetpointPercent != 0.001" >
                #{ActivePowerSetpointPercent},
          </if>
          <if test="ActivePowerControlEnable != 0.001" >
                #{ActivePowerControlEnable},
          </if>
          <if test="PowerFactorSetpoint != 0.001" >
                #{PowerFactorSetpoint},
          </if>
          <if test="PowerFactorControlEnable != 0.001" >
                #{PowerFactorControlEnable},
          </if>
          <if test="ReactivePowerSetpointPercent != 0.001" >
                #{ReactivePowerSetpointPercent},
          </if>
          <if test="ReactivePowerControlEnable != 0.001" >
               #{ReactivePowerControlEnable}, 
          </if>
          
         
		  <if test="nvmActivePower != 0.001" >
		  	#{nvmActivePower},
		  </if>
		  <if test="nvmActiveEnergy != 0.001" >
		  	#{nvmActiveEnergy},
		  </if>
		  <if test="MeasuredProduction != 0.001">
				#{MeasuredProduction},
			</if>
		</trim>
		
		<trim prefix="ON DUPLICATE KEY UPDATE " suffix=""
			suffixOverrides=",">
			<if test="id_device != 0.001" >
	                id_device = #{id_device},
	          </if>
			  
			  <if test="error != 0.001" >
	                `error` = #{error},
	          </if>
			  
			  <if test="low_alarm != 0.001" >
	                low_alarm = #{low_alarm},
	          </if>
			  
			  <if test="high_alarm != 0.001" >
	                high_alarm = #{high_alarm},
	          </if>
			  
			    <if test="ACCurrentAverage != 0.001" >
                `ACCurrentAverage` = #{ACCurrentAverage},
          </if>
          <if test="ACCurrentA != 0.001" >
                `ACCurrentA` = #{ACCurrentA},
          </if>
          <if test="ACCurrentB != 0.001" >
                `ACCurrentB` = #{ACCurrentB},
          </if>
          <if test="ACCurrentC != 0.001" >
                `ACCurrentC` = #{ACCurrentC},
          </if>
          <if test="ACVoltageAB != 0.001" >
                `ACVoltageAB` = #{ACVoltageAB},
          </if>
          <if test="ACVoltageBC != 0.001" >
                `ACVoltageBC` = #{ACVoltageBC},
          </if>
          <if test="ACVoltageCA != 0.001" >
                `ACVoltageCA` = #{ACVoltageCA},
          </if>
          <if test="ACVoltageAN != 0.001" >
               `ACVoltageAN` = #{ACVoltageAN}, 
          </if>
          <if test="ACVoltageBN != 0.001" >
                `ACVoltageBN` = #{ACVoltageBN},
          </if>
          <if test="ACVoltageCN != 0.001" >
                `ACVoltageCN` = #{ACVoltageCN},
          </if>
          <if test="ActivePower != 0.001" >
                `ActivePower` = #{ActivePower},
          </if>
          <if test="Frequency != 0.001" >
                `Frequency` = #{Frequency},
          </if>
          <if test="ApparentPower != 0.001" >
                `ApparentPower` = #{ApparentPower},
          </if>
          <if test="ReactivePower != 0.001" >
                `ReactivePower` = #{ReactivePower},
          </if>
          <if test="PowerFactor != 0.001" >
                `PowerFactor` = #{PowerFactor},
          </if>
          <if test="ActiveEnergyRawNet != 0.001" >
                `ActiveEnergyRawNet` = #{ActiveEnergyRawNet},
          </if>
          <if test="DCVoltage != 0.001" >
                `DCVoltage` = #{DCVoltage},
          </if>
          <if test="OperatingState != 0.001" >
                `OperatingState` = #{OperatingState},
          </if>
          <if test="OperatingStatus != 0.001" >
                `OperatingStatus` = #{OperatingStatus},
          </if>
          <if test="FaultStatus != 0.001" >
                `FaultStatus` = #{FaultStatus},
          </if>
          <if test="Fault1 != 0.001" >
                `Fault1` = #{Fault1},
          </if>
          <if test="Fault2 != 0.001" >
                `Fault2` = #{Fault2},
          </if>
          <if test="Fault3 != 0.001" >
                `Fault3` = #{Fault3},
          </if>

          <if test="SerialNumberHex4Reg != 0.001" >
                `SerialNumberHex4Reg` = #{SerialNumberHex4Reg},
          </if>
          <if test="CabinetTemperature != 0.001" >
                `CabinetTemperature` = #{CabinetTemperature},
          </if>
          <if test="InternalTemperature != 0.001" >
                `InternalTemperature` = #{InternalTemperature},
          </if>
          <if test="IMITemperature != 0.001" >
                `IMITemperature` = #{IMITemperature},
          </if>
          <if test="ControlDeviceOnOff != 0.001" >
                `ControlDeviceOnOff` = #{ControlDeviceOnOff},
          </if>
          <if test="ActivePowerSetpointPercent != 0.001" >
                `ActivePowerSetpointPercent` = #{ActivePowerSetpointPercent},
          </if>
          <if test="ActivePowerControlEnable != 0.001" >
                `ActivePowerControlEnable` = #{ActivePowerControlEnable},
          </if>
          <if test="PowerFactorSetpoint != 0.001" >
                `PowerFactorSetpoint` = #{PowerFactorSetpoint},
          </if>
          <if test="PowerFactorControlEnable != 0.001" >
                `PowerFactorControlEnable` = #{PowerFactorControlEnable},
          </if>
          <if test="ReactivePowerSetpointPercent != 0.001" >
                `ReactivePowerSetpointPercent` = #{ReactivePowerSetpointPercent},
          </if>
          <if test="ReactivePowerControlEnable != 0.001" >
               `ReactivePowerControlEnable` = #{ReactivePowerControlEnable}, 
          </if>
          
         
          
         
		  <if test="nvmActivePower != 0.001" >
		  	`nvmActivePower` = #{nvmActivePower},
		  </if>
		  <if test="nvmActiveEnergy != 0.001" >
		  	`nvmActiveEnergy` = #{nvmActiveEnergy},
		  </if>
		  <if test="MeasuredProduction != 0.001">
				`MeasuredProduction` = #{MeasuredProduction},
			</if>
		
		</trim>
		
	</insert>
	
	<select id="checkAlertWriteCode" resultType="Map">
    	SELECT
				m.Fault1 AS Fault1,
				m.Fault2 AS Fault2,
				m.Fault3 AS Fault3,
				m.FaultStatus AS FaultStatus
				
			FROM
				${datatablename} m
			WHERE
				id_device = #{id_device}
			ORDER BY
				time DESC 
			LIMIT 20;
  	</select>
  	
  	<select id="getListTriggerFaultCode" resultType="Map" parameterType="String">
		SELECT
			l.id,
			l.id_error,
			l.id_device,
			l.`status`,
			DATE_FORMAT(l.start_date,'%Y-%m-%d %H:%i:%s') AS start_date,
			DATE_FORMAT(NOW(),'%Y-%m-%d %H:%i:%s') AS end_date			
		FROM
			`alert` l
			LEFT JOIN error e ON e.id = l.id_error
			WHERE l.`status` = 1
			AND e.is_delete = 0 AND e.`status` = 1
			AND l.is_delete = 0 AND l.id_device = #{id_device}
			<if test="faultCodeLevel == 1">
				AND l.id_error IN(1572,1573,1574,1575,1576,1577,1578,1579,1580,1581,1582,1583)
			</if>
			
			<if test="faultCodeLevel == 2">
				AND l.id_error IN(1584,1585,1586,1587,1588,1589,1590,1591,1592,1593,1594,1595)
			</if>
			
			<if test="faultCodeLevel == 3">
				AND l.id_error IN(1596,1597,1598,1599,1600,1601,1602,1603,1604,1605,1606,1607,1608,1609,1610,1611,1612,1613,1614,1615,1621)
			</if>
			
			<if test="faultCodeLevel == 4">
				AND l.id_error IN(1616,1617,1618,1619,1620)
			</if>
	</select>
	
	
	<select id="getLastRow" resultType="com.nwm.api.entities.ModelXGI1500Entity">
		SELECT
			dv.*,
			s.enable_alert
		FROM
			${view_tablename} dv 
			LEFT JOIN device d ON d.id = dv.id_device
			LEFT JOIN site s ON s.id = d.id_site
		WHERE
			dv.id_device = #{id_device}
			<if test="time != null" >
	        	AND dv.time <![CDATA[<]]> #{time}
	        </if>
		ORDER BY
			dv.time DESC 
			LIMIT 1
	</select>
	
	
</mapper> 