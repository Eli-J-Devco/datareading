<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ModelHuaweiSun200028ktl">

	<insert id="insertModelHuaweiSun200028ktl" useGeneratedKeys="true"
		keyProperty="time">
		INSERT INTO `${datatablename}`
		<trim prefix="(" suffix=")" suffixOverrides="," >
		  <if test="time != null" >
                `time`,
          </if>
		  
		  <if test="id_device != 0.001" >
                `id_device`,
          </if>
		  
		  <if test="error != 0.001" >
                `error`,
          </if>
		  
		  <if test="low_alarm != 0.001" >
                `low_alarm`,
          </if>
		  
		  <if test="high_alarm != 0.001" >
                `high_alarm`,
          </if>
		  
		  <if test="ActivePower != 0.001" >
                `ActivePower`,
          </if>
          <if test="ReactivePower != 0.001" >
                `ReactivePower`,
          </if>
          <if test="TotalDCInputCurrent != 0.001" >
                `TotalDCInputCurrent`,
          </if>
          <if test="TotalInputPower != 0.001" >
                `TotalInputPower`,
          </if>
          <if test="InsulationResistance != 0.001" >
                `InsulationResistance`,
          </if>
          <if test="PowerFactor != 0.001" >
                `PowerFactor`,
          </if>
          <if test="InverterStatus != 0.001" >
                `InverterStatus`,
          </if>
          <if test="CabinetTemperature != 0.001" >
               `CabinetTemperature`, 
          </if>
          <if test="MajorFaultCode != 0.001" >
                `MajorFaultCode`,
          </if>
          <if test="MinorFaultCode != 0.001" >
                `MinorFaultCode`,
          </if>
          <if test="WarningCode != 0.001" >
                `WarningCode`,
          </if>
         
		  <if test="nvmActivePower != 0.001" >
		  	`nvmActivePower`,
		  </if>
		  <if test="nvmActiveEnergy != 0.001" >
		  	`nvmActiveEnergy`,
		  </if>
		  <if test="MeasuredProduction != 0.001">
				`MeasuredProduction`,
			</if>
		</trim>
		
		<trim prefix="values (" suffix=")" suffixOverrides="," >
			  <if test="time != null" >
                #{time},
	          </if>
			  
			  <if test="id_device != 0.001" >
	                #{id_device},
	          </if>
			  
			  <if test="error != 0.001" >
	                #{error},
	          </if>
			  
			  <if test="low_alarm != 0.001" >
	                #{low_alarm},
	          </if>
			  
			  <if test="high_alarm != 0.001" >
	                #{high_alarm},
	          </if>
			  
			  <if test="ActivePower != 0.001" >
                #{ActivePower},
          </if>
          <if test="ReactivePower != 0.001" >
                #{ReactivePower},
          </if>
          <if test="TotalDCInputCurrent != 0.001" >
                #{TotalDCInputCurrent},
          </if>
          <if test="TotalInputPower != 0.001" >
                #{TotalInputPower},
          </if>
          <if test="InsulationResistance != 0.001" >
                #{InsulationResistance},
          </if>
          <if test="PowerFactor != 0.001" >
                #{PowerFactor},
          </if>
          <if test="InverterStatus != 0.001" >
                #{InverterStatus},
          </if>
          <if test="CabinetTemperature != 0.001" >
               #{CabinetTemperature}, 
          </if>
          <if test="MajorFaultCode != 0.001" >
                #{MajorFaultCode},
          </if>
          <if test="MinorFaultCode != 0.001" >
                #{MinorFaultCode},
          </if>
          <if test="WarningCode != 0.001" >
                #{WarningCode},
          </if>
         
		  <if test="nvmActivePower != 0.001" >
		  	#{nvmActivePower},
		  </if>
		  <if test="nvmActiveEnergy != 0.001" >
		  	#{nvmActiveEnergy},
		  </if>
		  <if test="MeasuredProduction != 0.001">
				#{MeasuredProduction},
			</if>
		</trim>
		
		<trim prefix="ON DUPLICATE KEY UPDATE " suffix=""
			suffixOverrides=",">
			<if test="id_device != 0.001" >
	                id_device = #{id_device},
	          </if>
			  
			  <if test="error != 0.001" >
	                `error` = #{error},
	          </if>
			  
			  <if test="low_alarm != 0.001" >
	                low_alarm = #{low_alarm},
	          </if>
			  
			  <if test="high_alarm != 0.001" >
	                high_alarm = #{high_alarm},
	          </if>
			  
			  <if test="ActivePower != 0.001" >
                `ActivePower` = #{ActivePower},
          </if>
          <if test="ReactivePower != 0.001" >
                `ReactivePower` = #{ReactivePower},
          </if>
          <if test="TotalDCInputCurrent != 0.001" >
                `TotalDCInputCurrent` = #{TotalDCInputCurrent},
          </if>
          <if test="TotalInputPower != 0.001" >
                `TotalInputPower` = #{TotalInputPower},
          </if>
          <if test="InsulationResistance != 0.001" >
                `InsulationResistance` = #{InsulationResistance},
          </if>
          <if test="PowerFactor != 0.001" >
                `PowerFactor` = #{PowerFactor},
          </if>
          <if test="InverterStatus != 0.001" >
                `InverterStatus` = #{InverterStatus},
          </if>
          <if test="CabinetTemperature != 0.001" >
               `CabinetTemperature` = #{CabinetTemperature}, 
          </if>
          <if test="MajorFaultCode != 0.001" >
                `MajorFaultCode` = #{MajorFaultCode},
          </if>
          <if test="MinorFaultCode != 0.001" >
                `MinorFaultCode` = #{MinorFaultCode},
          </if>
          <if test="WarningCode != 0.001" >
                `WarningCode` = #{WarningCode},
          </if>
         
         
		  <if test="nvmActivePower != 0.001" >
		  	`nvmActivePower` = #{nvmActivePower},
		  </if>
		  <if test="nvmActiveEnergy != 0.001" >
		  	`nvmActiveEnergy` = #{nvmActiveEnergy},
		  </if>
		  <if test="MeasuredProduction != 0.001">
				`MeasuredProduction` = #{MeasuredProduction},
			</if>
		</trim>
		
	</insert>
	
	
	<select id="checkAlertWriteCode" resultType="Map">
    	SELECT
				m.MajorFaultCode AS MajorFaultCode,
				m.MinorFaultCode AS MinorFaultCode,
				m.WarningCode AS WarningCode
			FROM
				${datatablename} m
			WHERE
				id_device = #{id_device}
			ORDER BY
				time DESC 
			LIMIT 20;
  	</select>
  	
  	
  	<select id="getListTriggerFaultCode" resultType="Map" parameterType="String">
		SELECT
			l.id,
			l.id_error,
			l.id_device,
			l.`status`,
			DATE_FORMAT(l.start_date,'%Y-%m-%d %H:%i:%s') AS start_date,
			DATE_FORMAT(NOW(),'%Y-%m-%d %H:%i:%s') AS end_date			
		FROM
			`alert` l
			LEFT JOIN error e ON e.id = l.id_error
			WHERE l.`status` = 1
			AND e.is_delete = 0 AND e.`status` = 1
			AND l.is_delete = 0 AND l.id_device = #{id_device}
			<if test="faultCodeLevel == 1">
				AND l.id_error IN(1647,1648,1649,1650,1651,1652,1653,1654,1655,1656,1657,1658,1659,1660,1661,1662,1663,1664,1665,1666,1667,1668,1669,1670,1671,1672,1673,1674,1675,1676,1677,1678,1679,1680,1681,1682,1683,1684,1685,1686,1687,1688,1689,1690,1691,1692)
			</if>
			
			<if test="faultCodeLevel == 2">
				AND l.id_error IN(1693,1694,1695,1696)
			</if>
			
			<if test="faultCodeLevel == 3">
				AND l.id_error IN(1697,1698,1699,1700,1701,1702,1703,1704,1705,1706,1707,1708,1709,1710,1711,1712,1713,1714,1715 )
			</if>
			
	</select>
	
	
	
	<select id="getLastRow" resultType="com.nwm.api.entities.ModelHuaweiSun200028ktlEntity">
		SELECT
			dv.*,
			s.enable_alert
		FROM
			${view_tablename} dv 
			LEFT JOIN device d ON d.id = dv.id_device
			LEFT JOIN site s ON s.id = d.id_site
		WHERE
			dv.id_device = #{id_device}
			<if test="time != null" >
	        	AND dv.time <![CDATA[<]]> #{time}
	        </if>
		ORDER BY
			dv.time DESC 
			LIMIT 1
	</select>
	
	
</mapper> 