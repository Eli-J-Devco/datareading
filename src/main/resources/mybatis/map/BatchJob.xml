<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BatchJob">
	<resultMap id="BatchJobMap"
		type="com.nwm.api.entities.DeviceEntity">
		<result property="id" column="id" />
		<result property="id_site" column="id_site" />
		<result property="id_vendor" column="id_vendor" />
		<result property="serial_number" column="serial_number" />
		<result property="modbusdevicenumber" column="modbusdevicenumber" />
		<result property="devicename" column="devicename" />
		<result property="devicetype" column="devicetype" />
		<result property="deviceclass" column="deviceclass" />
		<result property="configuration" column="configuration" />
		<result property="configurationchangetime" column="configurationchangetime" />
		<result property="configurationchecksum" column="configurationchecksum" />
		<result property="datatablename" column="datatablename" />
		<result property="id_customer" column="id_customer" />
		<result property="id_device_type" column="id_device_type" />
		<result property="active" column="active" />
		<result property="id_device_group" column="id_device_group" />
		<result property="keyword" column="keyword" />
		
		
	</resultMap>
	
	<select id="getDeviceBySerialNumber" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.*,
			dg.table_name AS device_group_table
		FROM
			device d 
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
		WHERE
			d.`status` = 1 
			AND d.`is_delete` = 0
			AND d.serialnumber = #{serialnumber}
			LIMIT 1
	</select>
	
	
	<select id="getListSiteSentMailAlert" resultType="com.nwm.api.entities.SiteEntity" >
		SELECT
			s.*
		FROM
			site AS s
		WHERE
			s.`status` = 1 AND s.is_delete = 0 AND s.cf_email_subscribers IS NOT NULL
	</select>
	
	
	
	<select id="getListDeviceSolarOpenWeather" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			s.lat,
			s.lng,
			d.devicename,
			d.datatablename
		FROM
			device d
			LEFT JOIN site s ON d.id_site = s.id 
		WHERE
			d.id_device_group = 24 
			AND s.`status` = 1 
			AND d.`status` = 1 
			AND s.is_delete = 0 
			AND d.is_delete = 0
			AND s.lat != 0
			AND s.lng != 0
	</select>
	
	
	<select id="getListDeviceOpenMeteoWeather" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			s.lat,
			s.lng,
			d.devicename,
			d.datatablename
		FROM
			device d
			LEFT JOIN site s ON d.id_site = s.id 
		WHERE
			d.id_device_group = 110
			AND s.`status` = 1 
			AND d.`status` = 1 
			AND s.is_delete = 0 
			AND d.is_delete = 0
			AND s.lat != 0
			AND s.lng != 0
	</select>
	
	
	
	<select id="getListAlertOpenBySite" resultType="Map" >
		SELECT
			a.id,
			a.id_device,
			a.open_send_mail,
			a.close_send_mail,
			d.devicename,
			e.message,
			e.error_code,
			IF(a.`status` = 0, 'Closed', 'Opened') AS `status`,
			IF(a.start_date IS NULL , "N/A", DATE_FORMAT( CONVERT_TZ( a.start_date, '+00:00', t.`offset` ), '%m-%d-%Y %H:%i %p' ) ) AS start_date,
			IF(a.end_date IS NULL , "N/A", DATE_FORMAT( CONVERT_TZ( a.end_date, '+00:00', t.`offset` ), '%m-%d-%Y %H:%i %p' ) ) AS end_date
		FROM
			alert a
			LEFT JOIN error e ON e.id = a.id_error
			LEFT JOIN device d ON d.id = a.id_device 
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 
			AND d.id_site  = #{id}
			AND a.`status` = 1
			AND e.`status` = 1
			AND a.is_delete = 0
			AND e.is_delete = 0
			AND d.is_delete = 0
			AND a.open_send_mail = 0 AND a.`status` = 1
			ORDER BY a.`status` DESC
	</select>
	
	<select id="getListAlertCloseBySite" resultType="Map" >
		SELECT
			a.id,
			a.id_device,
			a.open_send_mail,
			a.close_send_mail,
			d.devicename,
			e.message,
			e.error_code,
			IF(a.`status` = 0, 'Closed', 'Opened') AS `status`,
			IF(a.start_date IS NULL , "N/A", DATE_FORMAT( CONVERT_TZ( a.start_date, '+00:00', t.`offset` ), '%m-%d-%Y %H:%i %p' ) ) AS start_date,
			IF(a.end_date IS NULL , "N/A", DATE_FORMAT( CONVERT_TZ( a.end_date, '+00:00', t.`offset` ), '%m-%d-%Y %H:%i %p' ) ) AS end_date
		FROM
			alert a
			LEFT JOIN error e ON e.id = a.id_error
			LEFT JOIN device d ON d.id = a.id_device 
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 
			AND d.id_site  = #{id}
			AND a.`status` = 1
			AND e.`status` = 1
			AND a.is_delete = 0
			AND e.is_delete = 0
			AND d.is_delete = 0
			AND a.close_send_mail = 0 AND a.`status` = 0
			ORDER BY a.`status` DESC
	</select>
	
	
	
	<update id="updateOpenSentAlert">
		UPDATE `alert`
		SET
			open_send_mail = 1
		WHERE
			`id` = #{id} AND `id_device` = #{id_device}
	</update>
	
	
	<update id="updateCloseSentAlert">
		UPDATE `alert`
		SET
			close_send_mail = 1, open_send_mail = 1
		WHERE
			`id` = #{id} AND `id_device` = #{id_device}
	</update>
	
	
	
	<select id="getListErrorByType" resultType="com.nwm.api.entities.ErrorEntity" >
		SELECT
			e.*
		FROM
			error e 
			LEFT JOIN alert a ON a.id_error = e.id
		WHERE
			e.type = 1 
			AND e.id_device_group = #{id_device_group}
			AND e.`status` = 1
			AND a.id_device = #{id_device} 
			AND a.`status` = 1
	</select>
	
	<select id="getListSite" resultType="com.nwm.api.entities.SiteEntity">
		SELECT
			t.`value` AS time_zone_value,
			s.*
		FROM
			site AS s
			LEFT JOIN time_zone t ON t.id = s.id_time_zone 
		WHERE
			s.`status` = 1 AND s.is_delete = 0
	</select>
	
	
	
	<select id="getListDeviceBySite" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			dg.code_prefix,
			s.start_date_time,
			s.end_date_time,
			t.`offset` AS timezone_offset,
			t.`value` AS timezone_value,
			d.id_device_group
		FROM
			device AS d
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 AND d.disable_alert = 1  AND s.`status` = 1 AND d.id_site = #{id_site} AND d.id_device_type NOT IN(5)
	</select>
	
	<select id="getLastRowItem" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    		`time`, 
    		id_device, 
    		d.devicename,
    		CONVERT_TZ( u.time, '+00:00', t.`offset` ) AS time_format
		FROM ${datatablename} u
		LEFT JOIN device d ON d.id = u.id_device
		LEFT JOIN site s ON s.id = d.id_site
		LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE u.id_device = #{id_device}
		ORDER BY u.`time` DESC LIMIT 1;
  	</select>
  	
  	
  
	
	
	<!-- <select id="getLastValueLifetime" resultType="com.nwm.api.entities.DeviceEntity">
		SELECT
			dv.id_device AS id,
			nvmActiveEnergy AS energy_lifetime 
		FROM
			${datatablename} dv 
		WHERE
			dv.id_device = #{id} 
			AND dv.nvmActiveEnergy > 0 
		ORDER BY
			dv.time DESC 
			LIMIT 1;
			
	</select> -->
	
	<!-- <select id="getLastValueEnergyToday" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id_site,
			d.id,
			ROUND((
					MAX( dv.nvmActiveEnergy ) - MIN( dv.nvmActiveEnergy ) 
					),
				1 
			) AS energy_today 
		FROM
			${datatablename} dv
			LEFT JOIN device d ON d.id = dv.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone 
		WHERE
			d.id = #{id}
			AND dv.nvmActiveEnergy > 0 
			AND DATE_FORMAT(CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d') = DATE_FORMAT( #{current_time}, '%Y-%m-%d')
			AND s.`status` = 1 
			AND d.`status` = 1 
	</select> -->
	
	
	<!-- <select id="getDataDeviceEnergyThisMonth" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id_site,
			d.id,
			ROUND((
					MAX( dv.nvmActiveEnergy ) - MIN( dv.nvmActiveEnergy ) 
					),
				1 
			) AS energy_this_month 
		FROM
			${datatablename} dv
			LEFT JOIN device d ON d.id = dv.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone 
		WHERE
			d.id = #{id}
			AND dv.nvmActiveEnergy > 0 
			AND DATE_FORMAT(CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m') = DATE_FORMAT( #{current_time}, '%Y-%m')
			AND s.`status` = 1 
			AND d.`status` = 1 
	</select> -->
	
	<!-- <update id="updateDataDeviceEnergyThisMonth">
		UPDATE `device`
		SET
			`energy_this_month` = #{energy_this_month}
		WHERE
			`id` = #{id}
	</update> --> 
	
	
	<!-- <update id="updateDataDeviceLifetime">
		UPDATE `device`
		SET
			`energy_lifetime` = #{energy_lifetime}
		WHERE
			`id` = #{id}
	</update> -->
	
	
	
	<!-- <update id="updateDataDeviceEnergyToday">
		UPDATE `device`
		SET
			`energy_today` = #{energy_today}
		WHERE
			`id` = #{id}
	</update> --> 
	

	<select id="getListMeterAndInverter" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			d.view_tablename,
			d.job_tablename,
			dg.code_prefix,
			s.start_date_time,
			s.end_date_time,
			t.`offset` AS timezone_offset,
			t.`value` AS timezone_value,
			d.id_device_group
		FROM
			device AS d
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 AND d.is_delete = 0
			AND s.`status` = 1 AND d.id_device_type IN (1, 3) AND d.disable_alert = 1
	</select>
	
	
	<select id="getListDeviceCelModem" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			d.view_tablename,
			d.job_tablename,
			d.id_device_group,
			d.ssh_host,
			d.ssh_port,
			d.ssh_user,
			d.ssh_pass
		FROM
			device AS d
			LEFT JOIN site s ON s.id = d.id_site 
		WHERE
			d.`status` = 1 AND d.is_delete = 0
			AND s.`status` = 1 AND d.id_device_group IN (40) 
			AND d.ssh_host IS NOT NULL
			AND d.ssh_user IS NOT NULL
			AND d.ssh_pass IS NOT NULL
			AND d.ssh_port IS NOT NULL
	</select>
	
	
	
	<select id="getListDeviceCelModemSierraRs50" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			d.view_tablename,
			d.job_tablename,
			d.id_device_group,
			d.ssh_host,
			d.ssh_port,
			d.ssh_user,
			d.ssh_pass
		FROM
			device AS d
			LEFT JOIN site s ON s.id = d.id_site 
		WHERE
			d.`status` = 1 AND d.is_delete = 0
			AND s.`status` = 1 AND d.id_device_group IN (44) 
			AND d.ssh_host IS NOT NULL
			AND d.ssh_user IS NOT NULL
			AND d.ssh_pass IS NOT NULL
			AND d.ssh_port IS NOT NULL
	</select>
	
	
	<select id="getListDeviceDatalogger" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			d.view_tablename,
			d.job_tablename,
			d.id_device_group,
			d.ssh_host,
			d.ssh_port,
			d.ssh_user,
			d.ssh_pass
		FROM
			device AS d
			LEFT JOIN site s ON s.id = d.id_site 
		WHERE
			d.`status` = 1 AND d.is_delete = 0
			AND s.`status` = 1 AND d.id_device_group IN (19)
			AND d.ssh_host IS NOT NULL
			AND d.ssh_user IS NOT NULL
			AND d.ssh_pass IS NOT NULL
			AND d.ssh_port IS NOT NULL
	</select>
	
	
	<select id="getListAccountLock" resultType="com.nwm.api.entities.UserEntity" >
		SELECT
			u.`id`,
			u.`password`,
			u.`first_name`,
			u.`last_name`,
			u.`id` AS id_user,
			u.`email` AS user_name,
			concat( u.first_name, ', ', u.last_name ) AS `name`,
			u.avatar,
			u.alert_filter,
			DATE_FORMAT(u.lock_time, "%Y-%m-%d %H:%s:%i") AS lock_time,
			u.account_locked,
			u.failed_attempt,
			( SELECT `value` FROM system_setup WHERE type = 'max_failed_attempt' ) AS max_failed_attempt,
			( SELECT `value` FROM system_setup WHERE type = 'time_account_locked' ) AS time_account_locked
			
		FROM
			`employee` u
		WHERE u.`status` = 1 AND u.is_delete = 0 AND u.account_locked = 1 GROUP BY u.id;
	</select>
	
	
	
	
	<select id="getListMeterAndInverterBySite" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			d.view_tablename,
			d.job_tablename,
			dg.code_prefix,
			s.start_date_time,
			s.end_date_time,
			t.`offset` AS timezone_offset,
			t.`value` AS timezone_value,
			d.id_device_group,
			d.last_updated,
			d.job_tablename
		FROM
			device AS d
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 AND d.is_delete = 0
			AND s.`status` = 1 AND d.id_device_type IN (1, 3) AND d.disable_alert = 1 AND s.id = #{id_site}
	</select>
	
	
	
	<select id="getListAllDevice" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			d.view_tablename,
			d.job_tablename,
			dg.code_prefix,
			s.start_date_time,
			s.end_date_time,
			t.`offset` AS timezone_offset,
			t.`value` AS timezone_value,
			d.id_device_group,
			d.id_device_type,
			d.job_tablename
		FROM
			device AS d
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 AND d.is_delete = 0
			AND s.`status` = 1 AND d.id_device_type IN (1, 3, 4, 6) AND s.`status` = 1 AND d.disable_alert = 1
	</select>
	
	
	<select id="getLastRowItemResetLastValue" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    		d.id,
    		`time`, 
    		id_device, 
    		d.devicename,
    		<if test="id_device_type == 1 or id_device_type == 3">
				u.nvmActivePower AS nvmActivePower,
			</if>
			
			<if test="id_device_type == 4 or id_device_type == 6 ">
				u.nvm_irradiance AS nvmActivePower,
			</if>
			
    		CONVERT_TZ( u.time, '+00:00', t.`offset` ) AS time_format
    		
    		
		FROM ${datatablename} u
		LEFT JOIN device d ON d.id = u.id_device
		LEFT JOIN site s ON s.id = d.id_site
		LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE u.id_device = #{id_device}
		AND DATE_FORMAT( u.time, '%Y-%m-%d %H:%i:%s') <![CDATA[>=]]> DATE_FORMAT( DATE_ADD( #{current_time} ,INTERVAL -60 MINUTE), '%Y-%m-%d %H:%i:%s')
		ORDER BY u.`time` DESC LIMIT 1;
  	</select>
	

	
	<select id="getLastRowItemCheckNoProduction" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
			`time`,
			id_device,
			error,
			s.start_date_time,
			s.end_date_time,
			d.id,
			IFNULL(u.nvmActivePower, 0.001) AS nvmActivePower
		FROM
			${datatablename} u
			LEFT JOIN device d ON d.id = u.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			
		WHERE
		
			u.id_device = #{id}
			AND DATE_FORMAT(CONVERT_TZ( u.time, '+00:00', t.`offset` ), "%Y-%m-%d %H:%i:%s") <![CDATA[<=]]> DATE_FORMAT( #{current_time}, "%Y-%m-%d 18:00:00")
		ORDER BY
			u.`time` DESC 
			LIMIT 1;
  	</select>
  	
	<select id="checkAlertlExist" parameterType="com.nwm.api.entities.AlertEntity" resultType="int">
    	SELECT
    	COUNT(u.id) as totalRecord
		FROM `alert` as u
		LEFT JOIN error e ON e.id = u.id_error
		WHERE u.id_device = #{id_device} 
		AND u.id_error = #{id_error} 
		AND u.`status` = 1
		AND u.is_delete = 0
		AND e.is_delete = 0 
		AND e.`status` = 1;
		
			
  	</select>
  	
	<select id="checkNoProductionAlertlExist" parameterType="com.nwm.api.entities.DeviceEntity" resultType="int">
    	SELECT
    		COUNT(u.id) as totalRecord
		FROM 
			`alert` as u
			LEFT JOIN error e ON e.id = u.id_error
		WHERE
			u.id_device = #{id} 
			AND u.`status` = 1
			AND u.is_delete = 0
			AND e.error_code = 1000
			AND e.`status` = 1
			AND e.is_delete = 0 
  	</select>
  	
  	
  	<select id="checkErrorExist" parameterType="com.nwm.api.entities.ErrorEntity" resultType="int">
    	SELECT
    	COUNT(e.id) as totalRecord
		FROM `error` as e
		WHERE e.id = #{id_error} 
		AND e.is_delete = 0 
		AND e.`status` = 1;
		
			
  	</select>
	
	
	
	<select id="getRowItemAlert" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    	u.id,
    	u.id_device,
    	u.id_error
		FROM `alert` as u
		WHERE u.id_device = #{id} AND u.id_error = #{id_error} AND u.`status` = 1 AND u.is_delete = 0
			LIMIT 1;
  	</select>
  	
  	
	
	<update id="updateCloseAlert">
		UPDATE `alert`
		SET
			status = 0,
			end_date = #{end_date}
		WHERE
			`id` = #{id} AND `id_device` = #{id_device}
	</update>
	
	
	
	<update id="updateWeather">
		UPDATE `site`
		SET
			weather_icon = #{weather_icon},
			weather_description = #{weather_description},
			weather_indoor_temp = #{weather_indoor_temp},
			weather_indoor_temp_unit = #{weather_indoor_temp_unit},
			weather_outdoor_temp = #{weather_outdoor_temp},
			weather_outdoor_temp_unit = #{weather_outdoor_temp_unit},
			weather_time = #{weather_time},
			weather_humidity = #{weather_humidity},
			weather_humidity_unit = #{weather_humidity_unit},
			weather_wind = #{weather_wind},
			weather_wind_unit = #{weather_wind_unit},
			weather_rain = #{weather_rain},
			weather_rain_unit = #{weather_rain_unit},
			weather_snow = #{weather_snow},
			weather_snow_unit = #{weather_snow_unit},
			sunrise = #{sunrise},
			sunset = #{sunset},
			temperature_2m_max = #{temperature_2m_max},
			temperature_2m_min = #{temperature_2m_min}
						
		WHERE
			`id` = #{id_site}
	</update>
	
	
	<update id="updateSunriseSunsetJava">
		UPDATE `site`
		SET
			sunrise = #{sunrise},
			sunset = #{sunset}
		WHERE
			`id` = #{id_site}
	</update>
	
	
	
	<update id="updateLastValueDevice">
		UPDATE `device`
		SET
			`last_value` = #{last_value}
		WHERE
			`id` = #{id}
	</update>
	
	
	<update id="updateSunriseSunset">
		UPDATE `site`
		SET
			start_date_time = #{start_date_time},
			end_date_time = #{end_date_time},
			sunrise = #{sunrise},
			sunset = #{sunset}
		WHERE
			`id` = #{id}
	</update>
		

	<select id="getListDevice" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			dg.code_prefix,
			s.start_date_time,
			s.end_date_time,
			t.`offset` AS timezone_offset,
			t.`value` AS timezone_value,
			d.id_device_group
		FROM
			device AS d
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 
			AND s.`status` = 1 AND d.id_device_type IN (1, 3)  AND d.id_device_type NOT IN(5)
	</select>
	
	
	
	
	
	
  	
  	
  	<select id="getErrorItem" resultType="com.nwm.api.entities.ErrorEntity">
    	SELECT
    		*
		FROM error e
		WHERE e.error_code = #{error_code} AND e.id_device_group = #{id_device_group} LIMIT 1;
  	</select>
  	
  	
  	
  	
  	
  	<insert id="insertAlert" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `alert_queue`(
			`id_device`,
			`id_error`,
			`start_date`,
			`end_date`,
			`asset`,
			`capacity`
		)VALUES(
			#{id_device},
			#{id_error},
			#{start_date},
			#{end_date},
			#{asset},
			#{capacity}
		);
		<selectKey keyProperty="id" resultType="int">
	        SELECT 
	        LAST_INSERT_ID() as id
        </selectKey>
	</insert>
	
	
	<select id="getListAlertCronJob" resultType="Map" parameterType="String">
		SELECT
			a.id,
			a.id_device,
			a.id_error,
			d.datatablename,
			d.id_device_type,
			d.id_device_group
		FROM
			alert AS a
			LEFT JOIN device d ON d.id = a.id_device 
		WHERE
			a.`status` = 1 
			AND a.is_delete = 0 
			AND d.`status` = 1 
			AND d.is_delete = 0
					
	</select>
	
	
	<select id="getLastRowItemAutoCloseAlert" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    		u.`time`, 
    		u.`id_device`, 
    		u.`error`
		FROM ${datatablename} u 
		LEFT JOIN device d ON u.id_device = d.id
		LEFT JOIN site s ON d.id_site = s.id
		LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE u.id_device = #{id_device}
		AND CONVERT_TZ( u.time, '+00:00', t.`offset` ) <![CDATA[<=]]>  CONVERT_TZ( ( NOW() ), 'UTC', t.`value` )
		ORDER BY `time` DESC LIMIT 1;
  	</select>
  	
  	
  	<!-- <select id="getLastRowItemCheckNoCommunication" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    		u.`time`, 
    		u.`id_device`, 
    		u.`error`,
    		IFNULL(u.nvmActivePower, 0.001) AS nvmActivePower,
    		u.nvmActiveEnergy,
    		d.devicename
		FROM ${datatablename} u 
		LEFT JOIN device d ON u.id_device = d.id
		LEFT JOIN site s ON d.id_site = s.id
		LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE u.id_device = #{id_device}
		
		AND DATE_FORMAT( u.time , '%Y-%m-%d %H:%i:%s') <![CDATA[>=]]> DATE_FORMAT( DATE_ADD( NOW() ,INTERVAL -45 MINUTE) , '%Y-%m-%d %H:%i:%s')
		AND DATE_FORMAT( u.time , '%Y-%m-%d %H:%i:%s') <![CDATA[<=]]> convert_tz( #{current_time},  t.`offset`, '+00:00')
		
		
		
		ORDER BY u.time DESC LIMIT 1;
  	</select> -->
  	
  	<select id="getAlertDetail" resultType="com.nwm.api.entities.AlertEntity">
    	SELECT
    	u.*
		FROM `alert` as u
		WHERE u.id_device = #{id_device} AND u.id_error = #{id_error} AND u.`status` = 1 AND u.is_delete = 0
			LIMIT 1;
  	</select>
  	
  	

  	
  	
  	<delete id="deleteAlert">
		DELETE FROM `alert`
		WHERE id = #{id} AND id_device = #{id_device} AND id_error = #{id_error}
	</delete>
	
	<update id="UpdateErrorMultiRow">
	    UPDATE `alert` SET `status` = 0, `end_date` = #{end_date} 
	    WHERE `id_error` = #{id_error} AND `id_device` = #{id_device}
	</update>

	
	
	
	<select id="getDeviceDatalogger" resultMap="BatchJobMap" parameterType="Integer">
		SELECT
			* 
		FROM
			device d 
		WHERE
			d.`status` = 1 
			AND d.id_site = #{id_site}
			AND d.id_device_group = 19 
			LIMIT 1
	</select>
	
	
	<select id="getDataloggerItem" resultType="com.nwm.api.entities.BatchJobTableEntity">
		SELECT
			* 
		FROM
			model_datalogger m
			LEFT JOIN device d ON d.id = m.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			m.id_device = #{id_device}
			AND DATE_FORMAT(CONVERT_TZ( m.time, '+00:00', t.`offset` ) , '%Y-%m-%d %H:%i:%s') <![CDATA[>=]]> DATE_FORMAT(CONVERT_TZ( DATE_ADD( NOW() ,INTERVAL -30 MINUTE) , '+00:00', t.`offset` ) , '%Y-%m-%d %H:%i:%s')
			LIMIT 1;
			
  	</select>
  	
  	
  	<select id="getListDeviceMeterAndInverter" resultType="com.nwm.api.entities.DeviceEntity">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site,
			s.table_data_report
		FROM
			device d
			LEFT JOIN site s ON s.id = d.id_site
		WHERE
			d.id_device_type IN(1,3,7,9)
			AND d.is_excluded_meter = 0
			AND d.id_site = #{id}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getListDeviceMeterBySite" resultType="com.nwm.api.entities.DeviceEntity">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site,
			s.table_data_report
		FROM
			device d
			LEFT JOIN site s ON s.id = d.id_site
		WHERE
			d.id_device_type IN(3,7,9)
			AND d.is_excluded_meter = 0
			AND d.id_site = #{id}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	<select id="getListDeviceWeather" resultType="com.nwm.api.entities.DeviceEntity">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site,
			s.table_data_report
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
			LEFT JOIN site s ON s.id = d.id_site
		WHERE
			dt.id IN(4) 
			AND d.id_site = #{id}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getListDeviceInverterBySite" resultType="com.nwm.api.entities.DeviceEntity">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site,
			s.table_data_report
		FROM
			device d
			LEFT JOIN site s ON s.id = d.id_site
		WHERE
			d.id_device_type IN(1)
			AND d.id_site = #{id}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	
	
	<select id="getSiteDataReportIIMW" resultType="com.nwm.api.entities.SiteDataReportEntity">
		SELECT
			ac.id_device,
			ac.time_full AS `time`,
			t.InverterUptime,
			IFNULL((t.end_date_time - t.start_date_time), 10) AS DayTime,
			ROUND(t.InverterUptime/ (IFNULL((t.end_date_time - t.start_date_time), 10 )), 2 ) AS InverterUptimeDaytime,
			ac.nvmActiveEnergy AS ActualGeneration,
			ROUND(ac.estimated, 2) AS EstimatedGeneration,
			ROUND(ac.nvmActiveEnergy/ac.estimated, 2) AS EstimatedGenerationIndex,
			IF(ROUND(t.InverterUptime / IFNULL((t.end_date_time - t.start_date_time), 10) ,2) > 1, 1, ROUND(t.InverterUptime / IFNULL((t.end_date_time - t.start_date_time), 10) ,2)) AS InverterAvailability,
			ROUND(ac.nvmActivePower, 2) AS PowerTodayTotal,
			ROUND(ac.avg_nvmActivePower, 2) AS PowerTodayAVG,
			NULL AS POATotal,
			NULL AS POAAVG,
			ac.previousRead,
			ac.currentRead
		FROM (
			SELECT 
				iv.id_device,
				iv.time_full,
				iv.format_date,
				iv.nvmActiveEnergy,
				iv.nvmActivePower,
				iv.avg_nvmActivePower,
				CASE
					 when iv.time_month = '01' then ROUND((SELECT en.jan FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/31)
					 when iv.time_month = '02' then ROUND((SELECT en.feb FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/DAY(LAST_DAY(iv.time_full)))
					 when iv.time_month = '03' then ROUND((SELECT en.mar FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/31)
					 when iv.time_month = '04' then ROUND((SELECT en.apr FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/30)
					 when iv.time_month = '05' then ROUND((SELECT en.may FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/31)
					 when iv.time_month = '06' then ROUND((SELECT en.jun FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/30)
					 when iv.time_month = '07' then ROUND((SELECT en.jul FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/31)
					 when iv.time_month = '08' then ROUND((SELECT en.aug FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/31)
					 when iv.time_month = '09' then ROUND((SELECT en.sep FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/30)
					 when iv.time_month = '10' then ROUND((SELECT en.oct FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/31)
					 when iv.time_month = '11' then ROUND((SELECT en.nov FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/30)
					 when iv.time_month = '12' then ROUND((SELECT en.`dec` FROM energy_expectations en WHERE en.id_site=#{id_site} AND `year`=iv.time_year)/31)
					END as estimated,
				iv.previousRead AS previousRead,
				iv.currentRead AS currentRead
			FROM (
					SELECT
						dv.id_device,
						DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d 00:00' ) AS time_full,
						DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d' ) AS format_date,
						DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%m' ) AS time_month,
						DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y' ) AS time_year,
						<!--MAX(dv.nvmActiveEnergy) - MIN(dv.nvmActiveEnergy) AS nvmActiveEnergy, -->
						SUM(dv.MeasuredProduction) AS nvmActiveEnergy,
						IF(SUM(dv.nvmActivePower) <![CDATA[<]]> 0.1, 0, SUM(dv.nvmActivePower)) AS nvmActivePower,
						IF(AVG(dv.nvmActivePower) <![CDATA[<]]> 0.1, 0, AVG(dv.nvmActivePower)) AS avg_nvmActivePower,
						MIN(dv.nvmActiveEnergy) AS previousRead,
						MAX(dv.nvmActiveEnergy) AS currentRead
					FROM
						${datatablename} dv
						LEFT JOIN device d ON d.id = dv.id_device
						LEFT JOIN site s ON s.id = d.id_site 
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
					WHERE
						dv.id_device = #{id}
						AND (CONVERT_TZ( dv.time, 'UTC', t.value ) BETWEEN #{start_date} AND #{end_date})
						AND s.`status` = 1 
						AND d.`status` = 1 
					GROUP BY
						d.id,
						format_date
			) iv
		) ac
		LEFT JOIN (
			SELECT 
				iv.id_device,
				iv.start_date_time,
				iv.end_date_time,
				iv.format_date,
				COUNT(IF(iv.nvmActivePower > 0, 1, NULL)) AS InverterUptime
			FROM (
					SELECT
						dv.id_device,
						s.start_date_time,
						s.end_date_time,
						DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d %H:00' ) AS time_format,
						DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d' ) AS format_date,
						IF(SUM(dv.nvmActivePower) <![CDATA[<]]> 0.1, 0, SUM(dv.nvmActivePower)) AS nvmActivePower
					FROM
						${datatablename} dv
						LEFT JOIN device d ON d.id = dv.id_device
						LEFT JOIN site s ON s.id = d.id_site 
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
					WHERE
						dv.id_device = #{id}
						AND (CONVERT_TZ( dv.time, 'UTC', t.value ) BETWEEN #{start_date} AND #{end_date})
						AND s.`status` = 1 
						AND d.`status` = 1 
					GROUP BY
						time_format
			) iv
			WHERE
				HOUR(iv.time_format) <![CDATA[>=]]> 8
				AND HOUR(iv.time_format) <![CDATA[<]]> 18
			GROUP BY
				iv.format_date
		) t ON t.format_date = ac.format_date
	</select>
	
	
	<select id="getSiteDataReportWeather" resultType="com.nwm.api.entities.SiteDataReportEntity">
		SELECT
			t.id_device,
			t.time_full AS `time`,
			0 AS InverterUptime,
			IFNULL((t.end_date_time - t.start_date_time), 10) AS DayTime,
			0 AS InverterUptimeDaytime,
			NULL AS ActualGeneration,
			NULL AS EstimatedGeneration,
			0 AS EstimatedGenerationIndex,
			0 AS InverterAvailability,
			NULL AS PowerTodayTotal,
			NULL AS PowerTodayAVG,
			ROUND(t.nvm_irradiance, 1) AS POATotal,
			ROUND(t.avg_nvm_irradiance, 1) AS POAAVG,
			ROUND(t.avg_nvm_temperature, 1) AS TCellAVG
		FROM (
			SELECT
				dv.id_device,
				s.start_date_time,
				s.end_date_time,
				dv.time,
				DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d' ) AS time_format,
				DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d 00:00' ) AS time_full,
				DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d' ) AS format_date,
				IF(SUM(dv.nvm_irradiance) <![CDATA[<]]> 0.1, 0, SUM(dv.nvm_irradiance)) AS nvm_irradiance,
				IF(AVG(dv.nvm_irradiance) <![CDATA[<]]> 0.1, 0, AVG(dv.nvm_irradiance)) AS avg_nvm_irradiance,
				IF(AVG(dv.nvm_temperature) <![CDATA[<]]> 0.1, 0, AVG(dv.nvm_temperature)) AS avg_nvm_temperature
			FROM
				${datatablename} dv
				LEFT JOIN device d ON d.id = dv.id_device
				LEFT JOIN site s ON s.id = d.id_site 
				LEFT JOIN time_zone t ON t.id = s.id_time_zone
			WHERE
				dv.id_device = #{id}
				AND (CONVERT_TZ( dv.time, 'UTC', t.value ) BETWEEN #{start_date} AND #{end_date})
				AND s.`status` = 1 
				AND d.`status` = 1 
			GROUP BY d.id, time_format
		)t
	</select>
	
	
	<insert id="insertSiteDataReport" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO ${table_data_report}
		<trim prefix="(" suffix=")" suffixOverrides=",">
				`time`,
				`id_device`,
				`InverterUptime`,
				`DayTime`,
				`InverterUptimeDaytime`,
				`ActualGeneration`,
				`EstimatedGeneration`,
				`EstimatedGenerationIndex`,
				`InverterAvailability`,
				`PowerTodayTotal`,
				`PowerTodayAVG`,
				`POATotal`,
				`POAAVG`,
				`TCellAVG`,
				`previousRead`,
				`currentRead`
		</trim>
		
		<foreach collection="dataDevice" item="item" open="VALUES" separator=",">
			<trim prefix="(" suffix=")" suffixOverrides=",">
				#{item.time},
				#{item.id_device},
				#{item.InverterUptime},
				#{item.DayTime},
				#{item.InverterUptimeDaytime},
				#{item.ActualGeneration},
				#{item.EstimatedGeneration},
				#{item.EstimatedGenerationIndex},
				#{item.InverterAvailability},
				#{item.PowerTodayTotal},
				#{item.PowerTodayAVG},
				#{item.POATotal},
				#{item.POAAVG},
				#{item.TCellAVG},
				#{item.previousRead},
				#{item.currentRead},
			</trim>
		</foreach>
		
		<trim prefix="ON DUPLICATE KEY UPDATE " suffix="" suffixOverrides=",">
				`InverterUptime` = VALUES(InverterUptime),
				`DayTime` = VALUES(DayTime),
				`InverterUptimeDaytime` = VALUES(InverterUptimeDaytime),
				`ActualGeneration` = VALUES(ActualGeneration),
				`EstimatedGeneration` = VALUES(EstimatedGeneration),
				`EstimatedGenerationIndex` = VALUES(EstimatedGenerationIndex),
				`InverterAvailability` = VALUES(InverterAvailability),
				`PowerTodayTotal` = VALUES(PowerTodayTotal),
				`PowerTodayAVG` = VALUES(PowerTodayAVG),
				`POATotal` = VALUES(POATotal),
				`POAAVG` = VALUES(POAAVG),
				`TCellAVG` = VALUES(TCellAVG),
				`previousRead` = VALUES(previousRead),
				`currentRead` = VALUES(currentRead),
		</trim>
		
	</insert>
	
	
	<select id="getDataIrradianceYesterday" resultType="com.nwm.api.entities.SiteEntity" >
		SELECT
			t.date_format,
			ROUND(( AVG( t.nvm_irradiance ) ), 1 ) AS nvm_irradiance,
			ROUND(( AVG( t.nvm_temperature ) ), 1 ) AS nvm_temperature
			
		FROM
			(
				<foreach collection="weatherStation" item="item" index="index" separator="union all">
				<![CDATA[
					SELECT
						m.date_format,
						AVG(m.nvm_irradiance) AS nvm_irradiance,
						AVG(m.nvm_temperature) AS nvm_temperature
					FROM
						(
						SELECT
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m-%d-%Y' ) AS date_format,
							AVG( IFNULL(dv.nvm_irradiance, 0) ) AS nvm_irradiance,
							 
							AVG( IFNULL(dv.nvm_temperature, 0) ) AS nvm_temperature
							
						FROM
							${item.datatablename} dv
							LEFT JOIN device d ON d.id = dv.id_device
							LEFT JOIN site s ON s.id = d.id_site 
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							s.id = #{item.id_site}
							AND d.id_device_type IN(4)
							AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN DATE_FORMAT(CONVERT_TZ ( SUBDATE(NOW(),1), '+00:00', t.`offset`),'%Y-%m-%d 00:00:00') AND DATE_FORMAT(CONVERT_TZ ( SUBDATE(NOW(),1), '+00:00', t.`offset`),'%Y-%m-%d 23:59:59'))
							AND s.`status` = 1 
							AND d.`status` = 1 
						GROUP BY
							d.id, date_format
						) m 
					GROUP BY
						m.date_format
					]]>
		      </foreach>
			) t 
		GROUP BY
			t.date_format
	</select>
	
	
	<select id="getDataPowerMeterYesterday" resultType="com.nwm.api.entities.SiteEntity" >
		SELECT
			t.date_format,
			ROUND(( AVG( t.actualPower ) ), 1 ) AS actualPower
			
		FROM
			(
				<foreach collection="groupMeter" item="item" index="index" separator="union all">
				<![CDATA[
					SELECT
						m.date_format,
						SUM(m.actualPower) AS actualPower
					FROM
						(
						SELECT
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m-%d-%Y' ) AS date_format,
							AVG( IFNULL(dv.nvmActivePower, 0) ) AS actualPower
						FROM
							${item.datatablename} dv
							LEFT JOIN device d ON d.id = dv.id_device
							LEFT JOIN site s ON s.id = d.id_site 
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							s.id = #{item.id_site}
							AND d.id_device_type IN(3)
							AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN DATE_FORMAT(CONVERT_TZ ( SUBDATE(NOW(),1), '+00:00', t.`offset`),'%Y-%m-%d 00:00:00') AND DATE_FORMAT(CONVERT_TZ ( SUBDATE(NOW(),1), '+00:00', t.`offset`),'%Y-%m-%d 23:59:59'))
							AND s.`status` = 1 
							AND d.`status` = 1 
						GROUP BY
							d.id, date_format
						) m 
					GROUP BY
						m.date_format
					]]>
		      </foreach>
			) t 
		GROUP BY
			t.date_format
	</select>
	
	
	
	
	<select id="getDataPowerInverterYesterday" resultType="com.nwm.api.entities.SiteEntity" >
		SELECT
			t.date_format,
			ROUND(( SUM( t.actualPower ) ), 1 ) AS actualPower
			
		FROM
			(
				<foreach collection="groupMeter" item="item" index="index" separator="union all">
				<![CDATA[
					SELECT
						m.date_format,
						SUM(m.actualPower) AS actualPower
					FROM
						(
						SELECT
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m-%d-%Y' ) AS date_format,
							AVG( IFNULL(dv.nvmActivePower, 0) ) AS actualPower
						FROM
							${item.datatablename} dv
							LEFT JOIN device d ON d.id = dv.id_device
							LEFT JOIN site s ON s.id = d.id_site 
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							s.id = #{item.id_site}
							AND d.id_device_type IN(1)
							AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN DATE_FORMAT(CONVERT_TZ ( SUBDATE(NOW(),1), '+00:00', t.`offset`),'%Y-%m-%d 00:00:00') AND DATE_FORMAT(CONVERT_TZ ( SUBDATE(NOW(),1), '+00:00', t.`offset`),'%Y-%m-%d 23:59:59'))
							AND s.`status` = 1 
							AND d.`status` = 1 
						GROUP BY
							d.id, date_format
						) m 
					GROUP BY
						m.date_format
					]]>
		      </foreach>
			) t 
		GROUP BY
			t.date_format
	</select>
  	
  	
  	<update id="updatPerformanceRatioYesterday">
		UPDATE `site`
		SET
			`PerformanceRatioYesterday` = #{PerformanceRatioYesterday}
		WHERE
			`id` = #{id}
	</update>
	
	<select id="getListSiteCheckNoCom" resultType="com.nwm.api.entities.SiteEntity" >
		SELECT
			s.id,
			s.`name`,
			s.id_time_zone,
			t.`value` AS time_zone_value,
			s.start_date_time,
			s.end_date_time,
			s.ac_capacity,
			s.dc_capacity
		FROM
			site s
			LEFT JOIN time_zone t ON t.id = s.id_time_zone 
		WHERE
			s.`status` = 1
	</select>
	
	
	<select id="getListSiteWeatherStationOrVirtual" resultType="com.nwm.api.entities.SiteEntity" >
		SELECT 
			s.id,
			s.table_data_report,
			s.table_data_virtual,
			IF(t.totalWeatherStation > 0 , t.totalWeatherStation, 0) AS totalWeatherStation,
			t.datatablename,
			IF(v.enable_virtual_device > 0 , 1, 0) AS enable_virtual_device
		FROM
			site s
			LEFT JOIN device d ON d.id_site = s.id
			LEFT JOIN (
				SELECT
					COUNT(*) AS enable_virtual_device,
					d.id_site
				FROM
					device d 
				WHERE
					d.`status` = 1 
					AND d.is_delete = 0 
					AND d.hidden = 0
					AND d.virtual_device_type IS NOT NULL
					AND d.virtual_device_type != ''
				GROUP BY
					d.id_site
			) v ON v.id_site = s.id
			LEFT JOIN (
				SELECT
					COUNT(IF(d.id_device_type = 4, 1, NULL)) AS totalWeatherStation,
					d.datatablename,
					d.id_site
				FROM
					device d 
				WHERE
					d.`status` = 1 
					AND d.is_delete = 0 
					AND d.hidden = 0
					AND d.id_device_type = 4
					AND d.reverse_poa = 0
				GROUP BY
					d.id_site
			) t ON t.id_site = s.id
		WHERE
			s.`status` = 1
			AND s.is_delete = 0
		GROUP BY
			s.id
	</select>


	
	<select id="getListReports" resultType="com.nwm.api.entities.ViewReportEntity" >
		SELECT
			r.id,
			r.schedule_enable,
			DATE_FORMAT(r.time_schedule, '%Y-%m-%d %H:%i') AS time_schedule,
			r.periodicity,
			r.days_week,
			r.offset_timezone
		FROM
			report r
			LEFT JOIN site s ON s.id = r.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			r.`status` = 1
			AND (CONVERT_TZ(NOW(), '+00:00', t.offset) <![CDATA[ < ]]> s.expiration OR s.expiration IS NULL)
			<if test="id > 0">
				AND r.id = #{id}
			</if>
	</select>
  	
  	<select id="getReportDetail" resultType="com.nwm.api.entities.ViewReportEntity" >
		SELECT
			<include refid="Reports.reportName"/> AS report_name,
			r.id,
			r.data_intervals,
			r.type_report,
			r.cadence_range,
			r.file_type,
			r.date_from,
			r.date_to,
			r.schedule_enable,
			DATE_FORMAT(r.time_schedule, '%Y-%m-%d %H:%i') AS time_schedule,
			r.periodicity,
			r.days_week,
			r.offset_timezone,
			r.subscribers,
			CASE
		    	WHEN r.cadence_range = 1 THEN "Daily"
				WHEN r.cadence_range = 2 THEN "Month-to-Date"
				WHEN r.cadence_range = 3 THEN "Last Full Quarter"
				WHEN r.cadence_range = 4 THEN "Year-to-Date"
				WHEN r.cadence_range = 5 THEN "Custom"
				WHEN r.cadence_range = 6 THEN "Week-to-Date"
				WHEN r.cadence_range = 7 THEN "Last Month"
				WHEN r.cadence_range = 8 THEN "Last Week"
		    	ELSE ""
			END	AS cadence_range_name,
			GROUP_CONCAT(s.id SEPARATOR ',') AS id_sites
		FROM
			report r
			JOIN site_employee_map sem ON sem.id_employee = r.id_employee
			JOIN site s ON s.id = sem.id_site
			JOIN time_zone tz ON tz.id = s.id_time_zone
			LEFT JOIN site_sub_group ssg ON ssg.id = s.id_site_sub_group
			LEFT JOIN report_site_map rsm ON r.type_option = 2 AND rsm.id_site = s.id AND rsm.id_report = r.id
		WHERE
			r.id = #{id}
			AND r.status = 1
			AND r.schedule_enable = 1
			AND s.`status` = 1
			AND s.is_delete = 0
			AND (CONVERT_TZ(NOW(), 'UTC', tz.value) <![CDATA[ < ]]> s.expiration OR s.expiration IS NULL)
			AND (
				CASE r.type_option
					WHEN 1 THEN TRUE
			    	WHEN 2 THEN rsm.id_report IS NOT NULL
			    	WHEN 3 THEN r.id_sub_group = ssg.id
					WHEN 4 THEN s.is_rec_report = 1
			    	ELSE TRUE
				END
			)
		GROUP BY
			r.id
	</select>
	
	<update id="updateReportScheduleNextRunTime">
		UPDATE report
		SET
			 next_run_time = #{time}
		WHERE
			`id` = #{id}
			AND `status` = 1
			AND schedule_enable = 1
			AND (next_run_time IS NULL OR NOW() >= next_run_time)
	</update>
	
  	<select id="checkExitsDeviceUploadSungrow" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			t.`value` AS timezone_value,
			t.`offset` AS timezone_offset,
			d.*
		FROM
			device d
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.timezone_datalogger 
		WHERE
			d.`status` = 1
			AND d.modbusdevicenumber = #{modbusdevicenumber}
			AND d.serial_number = #{serial_number}
			AND d.is_delete = 0
			LIMIT 1
	</select>
	
	
	<select id="checkExitsDeviceSMA" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			t.`value` AS timezone_value,
			t.`offset` AS timezone_offset,
			d.*
		FROM
			device d
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.timezone_datalogger 
		WHERE
			d.`status` = 1
			AND d.modbusdevicenumber = #{modbusdevicenumber}
			AND d.is_delete = 0
			LIMIT 1
	</select>
	
	<select id="getListSiteByDataloggerType" resultType="com.nwm.api.entities.SiteEntity" >
		SELECT
			s.id,
			s.`name`,
			s.id_time_zone,
			s.timezone_datalogger,
			s.ftp_server,
			s.ftp_user,
			s.ftp_pass,
			s.ftp_port,
			s.ftp_folder,
			s.datalogger_type,
			t.`value` AS time_zone_value,
			tz.`value` AS display_timezone
		FROM
			site s 
			LEFT JOIN time_zone t ON t.id = s.timezone_datalogger
			
			LEFT JOIN (
				SELECT * FROM time_zone tz
			) tz ON tz.id = s.id_time_zone
		WHERE
			s.datalogger_type = 1 
			AND s.`status` = 1 
			AND s.is_delete = 0
			AND s.ftp_server IS NOT NULL
			AND s.ftp_user IS NOT NULL
			AND s.ftp_pass IS NOT NULL
			AND s.ftp_folder IS NOT NULL
	</select>
	
	
	
	<select id="getDeviceDetailByModbus" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.*
		FROM
			device d
		WHERE
			d.`status` = 1
			AND d.modbusdevicenumber = #{modbusdevicenumber}
			AND d.id_site = #{id_site}
			AND d.is_delete = 0
			LIMIT 1
	</select>
	
	<select id="getListDeviceSMABySite" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			d.view_tablename,
			d.job_tablename,
			d.id_device_group,
			d.ssh_host,
			d.ssh_port,
			d.ssh_user,
			d.ssh_pass,
			dg.table_name  AS device_group_table
		FROM
			device AS d
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN device_group dg ON d.id_device_group = dg.id
		WHERE
			d.`status` = 1 
			AND d.is_delete = 0
			AND d.id_site = #{id_site} GROUP BY d.id
	</select>
	
	
	
	<select id="getListDeviceUpdateLastUpdate" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			IF(d.id_device_type = 12, s.table_data_virtual, d.datatablename) AS datatablename,
			IF(d.id_device_type = 12, s.table_data_virtual, d.view_tablename) AS view_tablename,
			IF(d.id_device_type = 12, s.table_data_virtual, d.job_tablename) AS job_tablename,
			d.id_device_group
		FROM
			device AS d
			LEFT JOIN site s ON s.id = d.id_site
		WHERE
			d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getLastRowItemUpdateDate" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    		`time`, 
    		id_device, 
    		d.devicename,
            u.error
		FROM ${datatablename} u
		LEFT JOIN device d ON d.id = u.id_device
		WHERE u.id_device = #{id_device}
		ORDER BY u.`time` DESC LIMIT 1;
  	</select>
	
	
	<update id="updateLastUpdatedCronJob">
		UPDATE `device`
		SET
			 `last_updated` = #{last_updated}
		WHERE
			`id` = #{id}
	</update>
	
	<select id="getEmployeeHidingSite" resultType="Map" >
  		SELECT
			e.email
		FROM 
			site_employee_map sem
			LEFT JOIN employee e ON e.id = sem.id_employee
		WHERE
			sem.id_site = #{id}
			AND sem.is_hiding = 1
	</select>
	
	<select id="getListCameraDevice" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.`devicename`,
			d.datatablename,
			d.device_ftp_server,
			d.device_ftp_user,
			d.device_ftp_pass,
			d.device_ftp_port,
			d.device_ftp_folder
		FROM
			device d

		WHERE
			d.`status` = 1
			AND d.id_device_type = 19
			AND d.is_delete = 0
			AND d.device_ftp_server IS NOT NULL
			AND d.device_ftp_user IS NOT NULL
			AND d.device_ftp_pass IS NOT NULL
			AND d.device_ftp_folder IS NOT NULL
	</select>
	
	<insert id="insertCameraImage" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
		INSERT INTO `${datatablename}`(
			`time`,
			`id_device`,
			`image_url`
		)VALUES(
			#{time},
			#{id_device},
			#{image_url}
		)ON DUPLICATE KEY UPDATE
		`image_url` = VALUES(image_url)
		
	</insert>
	
	<select id="getVirtualYesterdayGenerationBySite" parameterType="com.nwm.api.entities.SiteEntity" resultType="com.nwm.api.entities.EEREntity">
		SELECT
			d.id_site AS id,
			ROUND(SUM(vir.nvmActiveEnergy), 0) AS ActualGeneration,
			ROUND(IF(AVG(vir.expected_power_ac) > 0, AVG(vir.expected_power_ac) * 24,
			CASE
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '01' then ROUND((ee.jan / 31), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '02' then ROUND((ee.feb / DAY(LAST_DAY(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)))), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '03' then ROUND((ee.mar / 31), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '04' then ROUND((ee.apr / 30), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '05' then ROUND((ee.may / 31), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '06' then ROUND((ee.jun / 30), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '07' then ROUND((ee.jul / 31), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '08' then ROUND((ee.aug / 31), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '09' then ROUND((ee.sep / 30), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '10' then ROUND((ee.oct / 31), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '11' then ROUND((ee.nov / 30), 1)
				 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '12' then ROUND((ee.dec / 31), 1)
				 END
			), 1) AS EstimatedGeneration
			
		FROM
			${table_data_virtual} vir
			JOIN device d ON d.id = vir.id_device
			JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			JOIN energy_expectations ee ON ee.id_site = d.id_site AND ee.year = YEAR(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1))
		WHERE
			d.id_site = #{id}
			AND d.id_device_type = 12
			AND d.`status` = 1
			AND d.is_delete = 0
			AND (d.meter_type = 3 OR d.meter_type IS NULL)
			AND  (CONVERT_TZ( vir.time, 'UTC', t.value ) BETWEEN DATE_FORMAT(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1), '%Y-%m-%d 00:00:00') AND DATE_FORMAT(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1), '%y-%m-%d 23:59:59'))
		GROUP BY
			d.id_site
	</select>
	
	<select id="getYesterdayGenerationBySite" parameterType="com.nwm.api.entities.SiteEntity" resultType="com.nwm.api.entities.EEREntity">
		SELECT
			d.id_site AS id,
			ROUND(IF( (SUM(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, sdr.ActualGeneration, 0))) > 0, (SUM(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, sdr.ActualGeneration, 0))), (SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0))) ), 0) AS ActualGeneration,
			ROUND(ex.expected_energy, 1) AS EstimatedGeneration
		FROM
			${table_data_report} sdr
			JOIN device d ON d.id = sdr.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			<if test="datatablename == null">
			LEFT JOIN (
				SELECT
					ee.id_site,
					CASE
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '01' then ROUND((ee.jan / 31), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '02' then ROUND((ee.feb / DAY(LAST_DAY(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)))), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '03' then ROUND((ee.mar / 31), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '04' then ROUND((ee.apr / 30), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '05' then ROUND((ee.may / 31), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '06' then ROUND((ee.jun / 30), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '07' then ROUND((ee.jul / 31), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '08' then ROUND((ee.aug / 31), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '09' then ROUND((ee.sep / 30), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '10' then ROUND((ee.oct / 31), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '11' then ROUND((ee.nov / 30), 1)
						 WHEN MONTH(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1)) = '12' then ROUND((ee.dec / 31), 1)
					END	AS expected_energy
				
				FROM
					energy_expectations ee
					LEFT JOIN site s ON s.id = ee.id_site
					LEFT JOIN time_zone t ON t.id = s.id_time_zone
				WHERE
					ee.id_site = #{id}
					AND ee.year = YEAR(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1))
			) ex ON ex.id_site = d.id_site
			</if>
			<if test="datatablename != null">
			LEFT JOIN (
				SELECT
					dv.time,
					s.id,
					AVG(IF(
						d.id_device_type = 4,
						<include refid="com.nwm.common.expectedPowerByPvModel">
							<property name="irradiance" value="dv.nvm_irradiance" />
							<property name="temperature" value="dv.nvm_temperature" />
							<property name="panelTemperature" value="dv.nvm_panel_temperature" />
							<property name="power" value="NULL" />
						</include>,
						NULL
					)) * 24 AS expected_energy
				FROM
					${datatablename} dv
					LEFT JOIN device d ON d.id = dv.id_device
					LEFT JOIN site s ON s.id = d.id_site
					LEFT JOIN time_zone t ON t.id = s.id_time_zone
				WHERE
					s.`status` = 1
					AND d.`status` = 1
					AND d.id_site = #{id}
					AND s.is_delete = 0
					AND d.is_delete = 0
					AND d.id_device_type = 4
					AND CONVERT_TZ( dv.time, 'UTC', t.value ) BETWEEN DATE_FORMAT(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1), '%Y-%m-%d 00:00:00') AND DATE_FORMAT(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1), '%y-%m-%d 23:59:59')
			) ex ON ex.id = d.id_site
			</if>
			
		WHERE
			d.`status` = 1
			AND d.is_delete = 0
			AND sdr.time BETWEEN DATE_FORMAT(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1), '%Y-%m-%d 00:00:00') AND DATE_FORMAT(SUBDATE(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', t.value), 1), '%y-%m-%d 23:59:59')
		GROUP BY
			d.id_site
	</select>
	
	<update id="updatePerformanceRatioYesterdayAllSites">
		UPDATE site s,
			(
				<foreach collection="data" item="item" separator="UNION ALL">
					SELECT
						#{item.id} AS id,
						#{item.ActualGeneration} AS ActualGeneration,
						#{item.EstimatedGeneration} AS EstimatedGeneration
				</foreach>
			) t
		SET
			s.PerformanceRatioYesterday = IF(t.ActualGeneration IS NULL OR t.EstimatedGeneration IS NULL OR t.EstimatedGeneration <![CDATA[<=]]> 0, NULL, ROUND(t.ActualGeneration / t.EstimatedGeneration * 100 , 1))
		WHERE
			s.id = t.id
	</update>

  	
</mapper>