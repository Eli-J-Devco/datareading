<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ModelChintSolectriaInverterClass9725">
	<resultMap id="ModelChintSolectriaInverterClass9725Map"
		type="com.nwm.api.entities.ModelChintSolectriaInverterClass9725Entity">
		<result property="time" column="time" />
		<result property="id_device" column="id_device" />
		<result property="error" column="error" />
		<result property="low_alarm" column="low_alarm" />
		<result property="high_alarm" column="high_alarm" />
		<result property="PowerOnOff" column="PowerOnOff" />
		<result property="PActiveSet" column="PActiveSet" />
		<result property="PFactorSet" column="PFactorSet" />
		<result property="PReactiveSet" column="PReactiveSet" />
		<result property="GridVMax" column="GridVMax" />
		<result property="GridVmaxTripT" column="GridVmaxTripT" />
		<result property="GridVMin" column="GridVMin" />
		<result property="GridVminTripT" column="GridVminTripT" />
		<result property="GridFMax" column="GridFMax" />
		<result property="GridFMin" column="GridFMin" />
		<result property="GridFTripT" column="GridFTripT" />
		<result property="ActivePower" column="ActivePower" />
		<result property="PowerFactor" column="PowerFactor" />
		<result property="StartDelayTime" column="StartDelayTime" />
		<result property="Risomin" column="Risomin" />
		<result property="PVStartVol" column="PVStartVol" />
		<result property="DCIMax" column="DCIMax" />
		<result property="TambientMax" column="TambientMax" />
		<result property="TmoduleMax" column="TmoduleMax" />
		<result property="OffsetDiffMax" column="OffsetDiffMax" />
		<result property="GridVolUnbalance" column="GridVolUnbalance" />
		<result property="SoftPowerStep" column="SoftPowerStep" />
		<result property="TotalEnergyToEnergy"
			column="TotalEnergyToEnergy" />
		<result property="TotalEnergyToday" column="TotalEnergyToday" />
		<result property="InverterEfficiency"
			column="InverterEfficiency" />
		<result property="PowerFactor1" column="PowerFactor1" />
		<result property="MaxActivePowerToday"
			column="MaxActivePowerToday" />
		<result property="RunTimeToGrid" column="RunTimeToGrid" />
		<result property="AC_ActivePower" column="AC_ActivePower" />
		<result property="AC_ApparentPower" column="AC_ApparentPower" />
		<result property="GridVoltageUab" column="GridVoltageUab" />
		<result property="GridVoltageUbc" column="GridVoltageUbc" />
		<result property="GridVoltageUca" column="GridVoltageUca" />
		<result property="GridA_PhaseCurrent"
			column="GridA_PhaseCurrent" />
		<result property="GridB_PhaseCurrent"
			column="GridB_PhaseCurrent" />
		<result property="GridC_PhaseCurrent"
			column="GridC_PhaseCurrent" />
		<result property="PV1_Voltage" column="PV1_Voltage" />
		<result property="PV1_Current" column="PV1_Current" />
		<result property="PV2_Voltage" column="PV2_Voltage" />
		<result property="PV2_Current" column="PV2_Current" />
		<result property="PV3_Voltage" column="PV3_Voltage" />
		<result property="PV3_Current" column="PV3_Current" />
		<result property="Grid_Frequency" column="Grid_Frequency" />
		<result property="ModuleTemp" column="ModuleTemp" />
		<result property="InternalTemp" column="InternalTemp" />
		<result property="TransformerTemp" column="TransformerTemp" />
		<result property="InverterModeCode" column="InverterModeCode" />
		<result property="PermanentFaultCode"
			column="PermanentFaultCode" />
		<result property="WarnCode" column="WarnCode" />
		<result property="FaultCode0" column="FaultCode0" />
		<result property="FaultCode1" column="FaultCode1" />
		<result property="FaultCode2" column="FaultCode2" />
		<result property="SerialNumber" column="SerialNumber" />
		<result property="nvmActivePower" column="nvmActivePower" />
		<result property="nvmActiveEnergy" column="nvmActiveEnergy" />
		<result property="MeasuredProduction" column="MeasuredProduction" />
		<result property="datatablename" column="datatablename" />
		<result property="view_tablename" column="view_tablename" />
		<result property="job_tablename" column="job_tablename" />
	</resultMap>

	<insert id="insertModelChintSolectriaInverterClass9725"
		useGeneratedKeys="true" keyProperty="time">
		INSERT INTO `${datatablename}`
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="time != null">
				`time`,
			</if>
			<if test="id_device != 0.001">
				`id_device`,
			</if>
			<if test="error != 0.001">
				`error`,
			</if>
			<if test="low_alarm != 0.001">
				`low_alarm`,
			</if>
			<if test="high_alarm != 0.001">
				`high_alarm`,
			</if>
			<if test="PowerOnOff != 0.001">
				`PowerOnOff`,
			</if>
			<if test="PActiveSet != 0.001">
				`PActiveSet`,
			</if>
			<if test="PFactorSet != 0.001">
				`PFactorSet`,
			</if>
			<if test="PReactiveSet != 0.001">
				`PReactiveSet`,
			</if>
			<if test="GridVMax != 0.001">
				`GridVMax`,
			</if>
			<if test="GridVmaxTripT != 0.001">
				`GridVmaxTripT`,
			</if>
			<if test="GridVMin != 0.001">
				`GridVMin`,
			</if>
			<if test="GridVminTripT != 0.001">
				`GridVminTripT`,
			</if>
			<if test="GridFMax != 0.001">
				`GridFMax`,
			</if>
			<if test="GridFMin != 0.001">
				`GridFMin`,
			</if>
			<if test="GridFTripT != 0.001">
				`GridFTripT`,
			</if>
			<if test="ActivePower != 0.001">
				`ActivePower`,
			</if>
			<if test="PowerFactor != 0.001">
				`PowerFactor`,
			</if>
			<if test="StartDelayTime != 0.001">
				`StartDelayTime`,
			</if>
			<if test="Risomin != 0.001">
				`Risomin`,
			</if>
			<if test="PVStartVol != 0.001">
				`PVStartVol`,
			</if>
			<if test="DCIMax != 0.001">
				`DCIMax`,
			</if>
			<if test="TambientMax != 0.001">
				`TambientMax`,
			</if>
			<if test="TmoduleMax != 0.001">
				`TmoduleMax`,
			</if>
			<if test="OffsetDiffMax != 0.001">
				`OffsetDiffMax`,
			</if>
			<if test="GridVolUnbalance != 0.001">
				`GridVolUnbalance`,
			</if>
			<if test="SoftPowerStep != 0.001">
				`SoftPowerStep`,
			</if>
			<if test="TotalEnergyToEnergy != 0.001">
				`TotalEnergyToEnergy`,
			</if>
			<if test="TotalEnergyToday != 0.001">
				`TotalEnergyToday`,
			</if>
			<if test="InverterEfficiency != 0.001">
				`InverterEfficiency`,
			</if>
			<if test="PowerFactor1 != 0.001">
				`PowerFactor1`,
			</if>
			<if test="MaxActivePowerToday != 0.001">
				`MaxActivePowerToday`,
			</if>
			<if test="RunTimeToGrid != 0.001">
				`RunTimeToGrid`,
			</if>
			<if test="AC_ActivePower != 0.001">
				`AC_ActivePower`,
			</if>
			<if test="AC_ApparentPower != 0.001">
				`AC_ApparentPower`,
			</if>
			<if test="GridVoltageUab != 0.001">
				`GridVoltageUab`,
			</if>
			<if test="GridVoltageUbc != 0.001">
				`GridVoltageUbc`,
			</if>
			<if test="GridVoltageUca != 0.001">
				`GridVoltageUca`,
			</if>
			<if test="GridA_PhaseCurrent != 0.001">
				`GridA_PhaseCurrent`,
			</if>
			<if test="GridB_PhaseCurrent != 0.001">
				`GridB_PhaseCurrent`,
			</if>
			<if test="GridC_PhaseCurrent != 0.001">
				`GridC_PhaseCurrent`,
			</if>
			<if test="PV1_Voltage != 0.001">
				`PV1_Voltage`,
			</if>
			<if test="PV1_Current != 0.001">
				`PV1_Current`,
			</if>
			<if test="PV2_Voltage != 0.001">
				`PV2_Voltage`,
			</if>
			<if test="PV2_Current != 0.001">
				`PV2_Current`,
			</if>
			<if test="PV3_Voltage != 0.001">
				`PV3_Voltage`,
			</if>
			<if test="PV3_Current != 0.001">
				`PV3_Current`,
			</if>
			<if test="Grid_Frequency != 0.001">
				`Grid_Frequency`,
			</if>
			<if test="ModuleTemp != 0.001">
				`ModuleTemp`,
			</if>
			<if test="InternalTemp != 0.001">
				`InternalTemp`,
			</if>
			<if test="TransformerTemp != 0.001">
				`TransformerTemp`,
			</if>
			<if test="InverterModeCode != 0.001">
				`InverterModeCode`,
			</if>
			<if test="PermanentFaultCode != 0.001">
				`PermanentFaultCode`,
			</if>
			<if test="WarnCode != 0.001">
				`WarnCode`,
			</if>
			<if test="FaultCode0 != 0.001">
				`FaultCode0`,
			</if>
			<if test="FaultCode1 != 0.001">
				`FaultCode1`,
			</if>
			<if test="FaultCode2 != 0.001">
				`FaultCode2`,
			</if>
			<if test="SerialNumber != null">
				`SerialNumber`,
			</if>
			<if test="nvmActivePower != 0.001">
				`nvmActivePower`,
			</if>
			<if test="nvmActiveEnergy != 0.001">
				`nvmActiveEnergy`,
			</if>
			<if test="MeasuredProduction != 0.001">
				`MeasuredProduction`,
			</if>
		</trim>

		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="time != null">
				#{time},
			</if>
			<if test="id_device != 0.001">
				#{id_device},
			</if>
			<if test="error != 0.001">
				#{error},
			</if>
			<if test="low_alarm != 0.001">
				#{low_alarm},
			</if>
			<if test="high_alarm != 0.001">
				#{high_alarm},
			</if>
			<if test="PowerOnOff != 0.001">
				#{PowerOnOff},
			</if>
			<if test="PActiveSet != 0.001">
				#{PActiveSet},
			</if>
			<if test="PFactorSet != 0.001">
				#{PFactorSet},
			</if>
			<if test="PReactiveSet != 0.001">
				#{PReactiveSet},
			</if>
			<if test="GridVMax != 0.001">
				#{GridVMax},
			</if>
			<if test="GridVmaxTripT != 0.001">
				#{GridVmaxTripT},
			</if>
			<if test="GridVMin != 0.001">
				#{GridVMin},
			</if>
			<if test="GridVminTripT != 0.001">
				#{GridVminTripT},
			</if>
			<if test="GridFMax != 0.001">
				#{GridFMax},
			</if>
			<if test="GridFMin != 0.001">
				#{GridFMin},
			</if>
			<if test="GridFTripT != 0.001">
				#{GridFTripT},
			</if>
			<if test="ActivePower != 0.001">
				#{ActivePower},
			</if>
			<if test="PowerFactor != 0.001">
				#{PowerFactor},
			</if>
			<if test="StartDelayTime != 0.001">
				#{StartDelayTime},
			</if>
			<if test="Risomin != 0.001">
				#{Risomin},
			</if>
			<if test="PVStartVol != 0.001">
				#{PVStartVol},
			</if>
			<if test="DCIMax != 0.001">
				#{DCIMax},
			</if>
			<if test="TambientMax != 0.001">
				#{TambientMax},
			</if>
			<if test="TmoduleMax != 0.001">
				#{TmoduleMax},
			</if>
			<if test="OffsetDiffMax != 0.001">
				#{OffsetDiffMax},
			</if>
			<if test="GridVolUnbalance != 0.001">
				#{GridVolUnbalance},
			</if>
			<if test="SoftPowerStep != 0.001">
				#{SoftPowerStep},
			</if>
			<if test="TotalEnergyToEnergy != 0.001">
				#{TotalEnergyToEnergy},
			</if>
			<if test="TotalEnergyToday != 0.001">
				#{TotalEnergyToday},
			</if>
			<if test="InverterEfficiency != 0.001">
				#{InverterEfficiency},
			</if>
			<if test="PowerFactor1 != 0.001">
				#{PowerFactor1},
			</if>
			<if test="MaxActivePowerToday != 0.001">
				#{MaxActivePowerToday},
			</if>
			<if test="RunTimeToGrid != 0.001">
				#{RunTimeToGrid},
			</if>
			<if test="AC_ActivePower != 0.001">
				#{AC_ActivePower},
			</if>
			<if test="AC_ApparentPower != 0.001">
				#{AC_ApparentPower},
			</if>
			<if test="GridVoltageUab != 0.001">
				#{GridVoltageUab},
			</if>
			<if test="GridVoltageUbc != 0.001">
				#{GridVoltageUbc},
			</if>
			<if test="GridVoltageUca != 0.001">
				#{GridVoltageUca},
			</if>
			<if test="GridA_PhaseCurrent != 0.001">
				#{GridA_PhaseCurrent},
			</if>
			<if test="GridB_PhaseCurrent != 0.001">
				#{GridB_PhaseCurrent},
			</if>
			<if test="GridC_PhaseCurrent != 0.001">
				#{GridC_PhaseCurrent},
			</if>
			<if test="PV1_Voltage != 0.001">
				#{PV1_Voltage},
			</if>
			<if test="PV1_Current != 0.001">
				#{PV1_Current},
			</if>
			<if test="PV2_Voltage != 0.001">
				#{PV2_Voltage},
			</if>
			<if test="PV2_Current != 0.001">
				#{PV2_Current},
			</if>
			<if test="PV3_Voltage != 0.001">
				#{PV3_Voltage},
			</if>
			<if test="PV3_Current != 0.001">
				#{PV3_Current},
			</if>
			<if test="Grid_Frequency != 0.001">
				#{Grid_Frequency},
			</if>
			<if test="ModuleTemp != 0.001">
				#{ModuleTemp},
			</if>
			<if test="InternalTemp != 0.001">
				#{InternalTemp},
			</if>
			<if test="TransformerTemp != 0.001">
				#{TransformerTemp},
			</if>
			<if test="InverterModeCode != 0.001">
				#{InverterModeCode},
			</if>
			<if test="PermanentFaultCode != 0.001">
				#{PermanentFaultCode},
			</if>
			<if test="WarnCode != 0.001">
				#{WarnCode},
			</if>
			<if test="FaultCode0 != 0.001">
				#{FaultCode0},
			</if>
			<if test="FaultCode1 != 0.001">
				#{FaultCode1},
			</if>
			<if test="FaultCode2 != 0.001">
				#{FaultCode2},
			</if>
			<if test="SerialNumber != null">
				#{SerialNumber},
			</if>
			<if test="nvmActivePower != 0.001">
				#{nvmActivePower},
			</if>
			<if test="nvmActiveEnergy != 0.001">
				#{nvmActiveEnergy},
			</if>
			<if test="MeasuredProduction != 0.001">
				#{MeasuredProduction},
			</if>
		</trim>

		<trim prefix="ON DUPLICATE KEY UPDATE " suffix=""
			suffixOverrides=",">
			<if test="id_device != 0.001">
				`id_device` = #{id_device},
			</if>
			<if test="error != 0.001">
				`error` = #{error},
			</if>
			<if test="low_alarm != 0.001">
				`low_alarm` = #{low_alarm},
			</if>
			<if test="high_alarm != 0.001">
				`high_alarm` = #{high_alarm},
			</if>
			<if test="PowerOnOff != 0.001">
				`PowerOnOff` = #{PowerOnOff},
			</if>
			<if test="PActiveSet != 0.001">
				`PActiveSet` = #{PActiveSet},
			</if>
			<if test="PFactorSet != 0.001">
				`PFactorSet` = #{PFactorSet},
			</if>
			<if test="PReactiveSet != 0.001">
				`PReactiveSet` = #{PReactiveSet},
			</if>
			<if test="GridVMax != 0.001">
				`GridVMax` = #{GridVMax},
			</if>
			<if test="GridVmaxTripT != 0.001">
				`GridVmaxTripT` = #{GridVmaxTripT},
			</if>
			<if test="GridVMin != 0.001">
				`GridVMin` = #{GridVMin},
			</if>
			<if test="GridVminTripT != 0.001">
				`GridVminTripT` = #{GridVminTripT},
			</if>
			<if test="GridFMax != 0.001">
				`GridFMax` = #{GridFMax},
			</if>
			<if test="GridFMin != 0.001">
				`GridFMin` = #{GridFMin},
			</if>
			<if test="GridFTripT != 0.001">
				`GridFTripT` = #{GridFTripT},
			</if>
			<if test="ActivePower != 0.001">
				`ActivePower` = #{ActivePower},
			</if>
			<if test="PowerFactor != 0.001">
				`PowerFactor` = #{PowerFactor},
			</if>
			<if test="StartDelayTime != 0.001">
				`StartDelayTime` = #{StartDelayTime},
			</if>
			<if test="Risomin != 0.001">
				`Risomin` = #{Risomin},
			</if>
			<if test="PVStartVol != 0.001">
				`PVStartVol` = #{PVStartVol},
			</if>
			<if test="DCIMax != 0.001">
				`DCIMax` = #{DCIMax},
			</if>
			<if test="TambientMax != 0.001">
				`TambientMax` = #{TambientMax},
			</if>
			<if test="TmoduleMax != 0.001">
				`TmoduleMax` = #{TmoduleMax},
			</if>
			<if test="OffsetDiffMax != 0.001">
				`OffsetDiffMax` = #{OffsetDiffMax},
			</if>
			<if test="GridVolUnbalance != 0.001">
				`GridVolUnbalance` = #{GridVolUnbalance},
			</if>
			<if test="SoftPowerStep != 0.001">
				`SoftPowerStep` = #{SoftPowerStep},
			</if>
			<if test="TotalEnergyToEnergy != 0.001">
				`TotalEnergyToEnergy` = #{TotalEnergyToEnergy},
			</if>
			<if test="TotalEnergyToday != 0.001">
				`TotalEnergyToday` = #{TotalEnergyToday},
			</if>
			<if test="InverterEfficiency != 0.001">
				`InverterEfficiency` = #{InverterEfficiency},
			</if>
			<if test="PowerFactor1 != 0.001">
				`PowerFactor1` = #{PowerFactor1},
			</if>
			<if test="MaxActivePowerToday != 0.001">
				`MaxActivePowerToday` = #{MaxActivePowerToday},
			</if>
			<if test="RunTimeToGrid != 0.001">
				`RunTimeToGrid` = #{RunTimeToGrid},
			</if>
			<if test="AC_ActivePower != 0.001">
				`AC_ActivePower` = #{AC_ActivePower},
			</if>
			<if test="AC_ApparentPower != 0.001">
				`AC_ApparentPower` = #{AC_ApparentPower},
			</if>
			<if test="GridVoltageUab != 0.001">
				`GridVoltageUab` = #{GridVoltageUab},
			</if>
			<if test="GridVoltageUbc != 0.001">
				`GridVoltageUbc` = #{GridVoltageUbc},
			</if>
			<if test="GridVoltageUca != 0.001">
				`GridVoltageUca` = #{GridVoltageUca},
			</if>
			<if test="GridA_PhaseCurrent != 0.001">
				`GridA_PhaseCurrent` = #{GridA_PhaseCurrent},
			</if>
			<if test="GridB_PhaseCurrent != 0.001">
				`GridB_PhaseCurrent` = #{GridB_PhaseCurrent},
			</if>
			<if test="GridC_PhaseCurrent != 0.001">
				`GridC_PhaseCurrent` = #{GridC_PhaseCurrent},
			</if>
			<if test="PV1_Voltage != 0.001">
				`PV1_Voltage` = #{PV1_Voltage},
			</if>
			<if test="PV1_Current != 0.001">
				`PV1_Current` = #{PV1_Current},
			</if>
			<if test="PV2_Voltage != 0.001">
				`PV2_Voltage` = #{PV2_Voltage},
			</if>
			<if test="PV2_Current != 0.001">
				`PV2_Current` = #{PV2_Current},
			</if>
			<if test="PV3_Voltage != 0.001">
				`PV3_Voltage` = #{PV3_Voltage},
			</if>
			<if test="PV3_Current != 0.001">
				`PV3_Current` = #{PV3_Current},
			</if>
			<if test="Grid_Frequency != 0.001">
				`Grid_Frequency` = #{Grid_Frequency},
			</if>
			<if test="ModuleTemp != 0.001">
				`ModuleTemp` = #{ModuleTemp},
			</if>
			<if test="InternalTemp != 0.001">
				`InternalTemp` = #{InternalTemp},
			</if>
			<if test="TransformerTemp != 0.001">
				`TransformerTemp` = #{TransformerTemp},
			</if>
			<if test="InverterModeCode != 0.001">
				`InverterModeCode` = #{InverterModeCode},
			</if>
			<if test="PermanentFaultCode != 0.001">
				`PermanentFaultCode` = #{PermanentFaultCode},
			</if>
			<if test="WarnCode != 0.001">
				`WarnCode` = #{WarnCode},
			</if>
			<if test="FaultCode0 != 0.001">
				`FaultCode0` = #{FaultCode0},
			</if>
			<if test="FaultCode1 != 0.001">
				`FaultCode1` = #{FaultCode1},
			</if>
			<if test="FaultCode2 != 0.001">
				`FaultCode2` = #{FaultCode2},
			</if>
			<if test="SerialNumber != null">
				`SerialNumber` = #{SerialNumber},
			</if>
			<if test="nvmActivePower != 0.001">
				`nvmActivePower` = #{nvmActivePower},
			</if>
			<if test="nvmActiveEnergy != 0.001">
				`nvmActiveEnergy` = #{nvmActiveEnergy},
			</if>
			<if test="MeasuredProduction != 0.001 and MeasuredProduction > 0">
				`MeasuredProduction` = #{MeasuredProduction},
			</if>
		</trim>

	</insert>
	
	<select id="getListTriggerFaultCode" resultType="Map" parameterType="String">
		SELECT
			l.id,
			l.id_error,
			l.id_device,
			l.`status`,
			DATE_FORMAT(l.start_date,'%Y-%m-%d %H:%i:%s') AS start_date,
			DATE_FORMAT(NOW(),'%Y-%m-%d %H:%i:%s') AS end_date			
		FROM
			`alert` l
			LEFT JOIN error e ON e.id = l.id_error
			WHERE l.`status` = 1
			AND e.is_delete = 0 AND e.`status` = 1
			AND l.is_delete = 0 AND l.id_device = #{id_device}
			<if test="faultCodeLevel == 1">
				AND l.id_error IN(167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182)
			</if>
			<if test="faultCodeLevel == 2">
				AND l.id_error IN(183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198)
			</if>
			<if test="faultCodeLevel == 3">
				AND l.id_error IN(199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214)
			</if>
			
			<if test="faultCodeLevel == 4">
				AND l.id_error IN(215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230)
			</if>
			
			<if test="faultCodeLevel == 5">
				AND l.id_error IN(231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246)
			</if>
			
	</select>
	
	<select id="checkAlertWriteCode" resultType="Map">
    	SELECT
				m.PermanentFaultCode AS PermanentFaultCode,
				m.WarnCode AS WarnCode,
				m.FaultCode0 AS FaultCode0,
				m.FaultCode1 AS FaultCode1,
				m.FaultCode2 AS FaultCode2
			FROM
				${datatablename} m
			WHERE
				id_device = #{id_device}
			ORDER BY
				time DESC 
			LIMIT 20;
  	</select>
  	
  	
  	<select id="getLastRow" resultType="com.nwm.api.entities.ModelChintSolectriaInverterClass9725Entity">
		SELECT
			dv.*,
			s.enable_alert
		FROM
			${view_tablename} dv 
			LEFT JOIN device d ON d.id = dv.id_device
			LEFT JOIN site s ON s.id = d.id_site
		WHERE
			dv.id_device = #{id_device}
			<if test="time != null" >
	        	AND dv.time <![CDATA[<]]> #{time}
	        </if>
		ORDER BY
			dv.time DESC 
			LIMIT 1
	</select>
  	

</mapper> 