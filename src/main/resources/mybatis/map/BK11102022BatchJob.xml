<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BatchJob">
	<resultMap id="BatchJobMap"
		type="com.nwm.api.entities.DeviceEntity">
		<result property="id" column="id" />
		<result property="id_site" column="id_site" />
		<result property="id_vendor" column="id_vendor" />
		<result property="serial_number" column="serial_number" />
		<result property="modbusdevicenumber" column="modbusdevicenumber" />
		<result property="devicename" column="devicename" />
		<result property="devicetype" column="devicetype" />
		<result property="deviceclass" column="deviceclass" />
		<result property="configuration" column="configuration" />
		<result property="configurationchangetime" column="configurationchangetime" />
		<result property="configurationchecksum" column="configurationchecksum" />
		<result property="datatablename" column="datatablename" />
		<result property="id_customer" column="id_customer" />
		<result property="id_device_type" column="id_device_type" />
		<result property="active" column="active" />
		<result property="id_device_group" column="id_device_group" />
		<result property="keyword" column="keyword" />
		
		
	</resultMap>
	
	<select id="getListSiteSentMailAlert" resultType="com.nwm.api.entities.SiteEntity" >
		SELECT
			s.*
		FROM
			site AS s
		WHERE
			s.`status` = 1 AND s.is_delete = 0 AND s.cf_email_subscribers IS NOT NULL
	</select>
	
	
	
	<select id="getListDeviceSolarOpenWeather" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			s.lat,
			s.lng,
			d.devicename,
			d.datatablename
		FROM
			device d
			LEFT JOIN site s ON d.id_site = s.id 
		WHERE
			d.id_device_group = 24 
			AND s.`status` = 1 
			AND d.`status` = 1 
			AND s.is_delete = 0 
			AND d.is_delete = 0
			AND s.lat != 0
			AND s.lng != 0
	</select>
	
	<select id="getListAlertOpenBySite" resultType="Map" >
		SELECT
			a.id,
			a.id_device,
			a.open_send_mail,
			a.close_send_mail,
			d.devicename,
			e.message,
			e.error_code,
			IF(a.`status` = 0, 'Closed', 'Opened') AS `status`,
			IF(a.start_date IS NULL , "N/A", DATE_FORMAT( CONVERT_TZ( a.start_date, '+00:00', t.`offset` ), '%m-%d-%Y %H:%i %p' ) ) AS start_date,
			IF(a.end_date IS NULL , "N/A", DATE_FORMAT( CONVERT_TZ( a.end_date, '+00:00', t.`offset` ), '%m-%d-%Y %H:%i %p' ) ) AS end_date
		FROM
			alert a
			LEFT JOIN error e ON e.id = a.id_error
			LEFT JOIN device d ON d.id = a.id_device 
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 
			AND d.id_site  = #{id}
			AND a.open_send_mail = 0 AND a.`status` = 1
			ORDER BY a.`status` DESC
	</select>
	
	<select id="getListAlertCloseBySite" resultType="Map" >
		SELECT
			a.id,
			a.id_device,
			a.open_send_mail,
			a.close_send_mail,
			d.devicename,
			e.message,
			e.error_code,
			IF(a.`status` = 0, 'Closed', 'Opened') AS `status`,
			IF(a.start_date IS NULL , "N/A", DATE_FORMAT( CONVERT_TZ( a.start_date, '+00:00', t.`offset` ), '%m-%d-%Y %H:%i %p' ) ) AS start_date,
			IF(a.end_date IS NULL , "N/A", DATE_FORMAT( CONVERT_TZ( a.end_date, '+00:00', t.`offset` ), '%m-%d-%Y %H:%i %p' ) ) AS end_date
		FROM
			alert a
			LEFT JOIN error e ON e.id = a.id_error
			LEFT JOIN device d ON d.id = a.id_device 
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 
			AND d.id_site  = #{id}
			AND a.close_send_mail = 0 AND a.`status` = 0
			ORDER BY a.`status` DESC
	</select>
	
	
	
	<update id="updateOpenSentAlert">
		UPDATE `alert`
		SET
			open_send_mail = 1
		WHERE
			`id` = #{id} AND `id_device` = #{id_device}
	</update>
	
	
	<update id="updateCloseSentAlert">
		UPDATE `alert`
		SET
			close_send_mail = 1, open_send_mail = 1
		WHERE
			`id` = #{id} AND `id_device` = #{id_device}
	</update>
	
	
	
	<select id="getListErrorByType" resultType="com.nwm.api.entities.ErrorEntity" >
		SELECT
			e.*
		FROM
			error e 
			LEFT JOIN alert a ON a.id_error = e.id
		WHERE
			e.type = 1 
			AND e.id_device_group = #{id_device_group}
			AND e.`status` = 1
			AND a.id_device = #{id_device} 
			AND a.`status` = 1
	</select>
	
	<select id="getListSite" resultType="com.nwm.api.entities.SiteEntity" >
		SELECT
			s.*
		FROM
			site AS s
		WHERE
			s.`status` = 1 AND s.is_delete = 0
	</select>
	
	
	
	<select id="getListDeviceBySite" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			dg.code_prefix,
			s.start_date_time,
			s.end_date_time,
			t.`offset` AS timezone_offset,
			t.`value` AS timezone_value,
			d.id_device_group
		FROM
			device AS d
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 AND d.disable_alert = 0  AND s.`status` = 1 AND d.id_site = #{id_site} AND d.id_device_type NOT IN(5)
	</select>
	
	<select id="getLastRowItem" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    		`time`, 
    		id_device, 
    		error,
    		d.devicename,
    		CONVERT_TZ( u.time, '+00:00', t.`offset` ) AS time_format
		FROM ${datatablename} u
		LEFT JOIN device d ON d.id = u.id_device
		LEFT JOIN site s ON s.id = d.id_site
		LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE u.id_device = #{id_device}
		ORDER BY u.`time` DESC LIMIT 1;
  	</select>
  	
  	
  
	
	
	<select id="getLastValueLifetime" resultType="com.nwm.api.entities.DeviceEntity">
		SELECT
			dv.id_device AS id,
			nvmActiveEnergy AS energy_lifetime 
		FROM
			${datatablename} dv 
		WHERE
			dv.id_device = #{id} 
			AND dv.nvmActiveEnergy > 0 
		ORDER BY
			dv.time DESC 
			LIMIT 1;
			
	</select>
	
	<select id="getLastValueEnergyToday" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id_site,
			d.id,
			ROUND((
					MAX( dv.nvmActiveEnergy ) - MIN( dv.nvmActiveEnergy ) 
					),
				1 
			) AS energy_today 
		FROM
			${datatablename} dv
			LEFT JOIN device d ON d.id = dv.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone 
		WHERE
			d.id = #{id}
			AND dv.nvmActiveEnergy > 0 
			AND DATE_FORMAT(CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d') = DATE_FORMAT( #{current_time}, '%Y-%m-%d')
			AND s.`status` = 1 
			AND d.`status` = 1 
	</select>
	
	
	<select id="getDataDeviceEnergyThisMonth" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id_site,
			d.id,
			ROUND((
					MAX( dv.nvmActiveEnergy ) - MIN( dv.nvmActiveEnergy ) 
					),
				1 
			) AS energy_this_month 
		FROM
			${datatablename} dv
			LEFT JOIN device d ON d.id = dv.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone 
		WHERE
			d.id = #{id}
			AND dv.nvmActiveEnergy > 0 
			AND DATE_FORMAT(CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m') = DATE_FORMAT( #{current_time}, '%Y-%m')
			AND s.`status` = 1 
			AND d.`status` = 1 
	</select>
	
	<update id="updateDataDeviceEnergyThisMonth">
		UPDATE `device`
		SET
			`energy_this_month` = #{energy_this_month}
		WHERE
			`id` = #{id}
	</update>
	
	
	<update id="updateDataDeviceLifetime">
		UPDATE `device`
		SET
			`energy_lifetime` = #{energy_lifetime}
		WHERE
			`id` = #{id}
	</update>
	
	
	
	<update id="updateDataDeviceEnergyToday">
		UPDATE `device`
		SET
			`energy_today` = #{energy_today}
		WHERE
			`id` = #{id}
	</update>
	
	
	
	<select id="getListSiteCheckNoCom" resultType="com.nwm.api.entities.SiteEntity" >
		SELECT
			s.id,
			s.`name`,
			s.id_time_zone,
			t.`value` AS time_zone_value,
			s.start_date_time,
			s.end_date_time
		FROM
			site s
			LEFT JOIN time_zone t ON t.id = s.id_time_zone 
		WHERE
			s.`status` = 1 
			AND s.`status` = 1 AND s.id = 43
	</select>
	
	
	<select id="getListMeterAndInverter" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			dg.code_prefix,
			s.start_date_time,
			s.end_date_time,
			t.`offset` AS timezone_offset,
			t.`value` AS timezone_value,
			d.id_device_group
		FROM
			device AS d
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 
			AND s.`status` = 1 AND d.id_device_type IN (1, 3) AND d.disable_alert = 0
	</select>
	
	
	
	<select id="getListMeterAndInverterBySite" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			dg.code_prefix,
			s.start_date_time,
			s.end_date_time,
			t.`offset` AS timezone_offset,
			t.`value` AS timezone_value,
			d.id_device_group,
			d.last_updated
		FROM
			device AS d
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 
			AND s.`status` = 1 AND d.id_device_type IN (1, 3) AND d.disable_alert = 0 AND s.id = #{id_site}
	</select>
	
	
	
	<select id="getListAllDevice" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			dg.code_prefix,
			s.start_date_time,
			s.end_date_time,
			t.`offset` AS timezone_offset,
			t.`value` AS timezone_value,
			d.id_device_group,
			d.id_device_type
		FROM
			device AS d
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 
			AND s.`status` = 1 AND d.id_device_type IN (1, 3, 4, 6) AND s.`status` = 1 AND d.disable_alert = 0
	</select>
	
	
	<select id="getLastRowItemResetLastValue" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    		d.id,
    		`time`, 
    		id_device, 
    		error,
    		d.devicename,
    		<if test="id_device_type == 1 or id_device_type == 3">
				u.nvmActivePower AS nvmActivePower,
			</if>
			
			<if test="id_device_type == 4 or id_device_type == 6 ">
				u.nvm_irradiance AS nvmActivePower,
			</if>
			
    		CONVERT_TZ( u.time, '+00:00', t.`offset` ) AS time_format
    		
    		
		FROM ${datatablename} u
		LEFT JOIN device d ON d.id = u.id_device
		LEFT JOIN site s ON s.id = d.id_site
		LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE u.id_device = #{id_device}
		AND DATE_FORMAT( u.time, '%Y-%m-%d %H:%i:%s') <![CDATA[>=]]> DATE_FORMAT( DATE_ADD( #{current_time} ,INTERVAL -60 MINUTE), '%Y-%m-%d %H:%i:%s')
		ORDER BY u.`time` DESC LIMIT 1;
  	</select>
	

	
	<select id="getLastRowItemCheckNoProduction" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
			`time`,
			id_device,
			error,
			s.start_date_time,
			s.end_date_time,
			d.id,
			IFNULL(u.nvmActivePower, 0.001) AS nvmActivePower
		FROM
			${datatablename} u
			LEFT JOIN device d ON d.id = u.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			
		WHERE
		
			u.id_device = #{id}
			AND DATE_FORMAT(CONVERT_TZ( u.time, '+00:00', t.`offset` ), "%Y-%m-%d %H:%i:%s") <![CDATA[<=]]> DATE_FORMAT( #{current_time}, "%Y-%m-%d 18:00:00")
		ORDER BY
			u.`time` DESC 
			LIMIT 1;
  	</select>
  	
	<select id="checkAlertlExist" parameterType="com.nwm.api.entities.AlertEntity" resultType="int">
    	SELECT
    	COUNT(u.id) as totalRecord
		FROM `alert` as u
		LEFT JOIN error e ON e.id = u.id_error
		WHERE u.id_device = #{id_device} 
		AND u.id_error = #{id_error} 
		AND u.`status` = 1
		AND u.is_delete = 0
		AND e.is_delete = 0 
		AND e.`status` = 1;
		
			
  	</select>
  	
  	
  	<select id="checkErrorExist" parameterType="com.nwm.api.entities.ErrorEntity" resultType="int">
    	SELECT
    	COUNT(e.id) as totalRecord
		FROM `error` as e
		WHERE e.id = #{id_error} 
		AND e.is_delete = 0 
		AND e.`status` = 1;
		
			
  	</select>
	
	
	
	<select id="getRowItemAlert" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    	u.id,
    	u.id_device,
    	u.id_error
		FROM `alert` as u
		WHERE u.id_device = #{id} AND u.id_error = #{id_error} AND u.`status` = 1 AND u.is_delete = 0
			LIMIT 1;
  	</select>
  	
  	
	
	<update id="updateCloseAlert">
		UPDATE `alert`
		SET
			status = 0,
			end_date = #{end_date}
		WHERE
			`id` = #{id} AND `id_device` = #{id_device}
	</update>
	
	
	
	<update id="updateWeather">
		UPDATE `site`
		SET
			weather_icon = #{weather_icon},
			weather_description = #{weather_description}
		WHERE
			`id` = #{id_site}
	</update>
	
	
	<update id="updateLastValueDevice">
		UPDATE `device`
		SET
			`last_value` = #{last_value}
		WHERE
			`id` = #{id}
	</update>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	

	<select id="getListDevice" resultType="com.nwm.api.entities.DeviceEntity" >
		SELECT
			d.id,
			d.id_site,
			d.id_vendor,
			d.serial_number,
			d.modbusdevicenumber,
			d.devicename,
			d.datatablename,
			dg.code_prefix,
			s.start_date_time,
			s.end_date_time,
			t.`offset` AS timezone_offset,
			t.`value` AS timezone_value,
			d.id_device_group
		FROM
			device AS d
			LEFT JOIN device_group dg ON dg.id = d.id_device_group
			LEFT JOIN site s ON s.id = d.id_site 
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			d.`status` = 1 
			AND s.`status` = 1 AND d.id_device_type IN (1, 3)  AND d.id_device_type NOT IN(5)
	</select>
	
	
	
	
	
	
  	
  	
  	<select id="getErrorItem" resultType="com.nwm.api.entities.ErrorEntity">
    	SELECT
    		*
		FROM error e
		WHERE e.error_code = #{error_code} AND e.id_device_group = #{id_device_group} LIMIT 1;
  	</select>
  	
  	
  	
  	
  	
  	<insert id="insertAlert" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `alert`(
			`id_device`,
			`id_error`,
			`start_date`,
			`end_date`,
			`asset`,
			`capacity`
		)VALUES(
			#{id_device},
			#{id_error},
			#{start_date},
			#{end_date},
			#{asset},
			#{capacity}
		);
		<selectKey keyProperty="id" resultType="int">
	        SELECT 
	        LAST_INSERT_ID() as id
        </selectKey>
	</insert>
	
	
	<select id="getListAlertCronJob" resultType="Map" parameterType="String">
		SELECT
			a.id,
			a.id_device,
			a.id_error,
			d.datatablename,
			d.id_device_type,
			d.id_device_group
		FROM
			alert AS a
			LEFT JOIN device d ON d.id = a.id_device 
		WHERE
			a.`status` = 1 
			AND a.is_delete = 0 
			AND d.`status` = 1 
			AND d.is_delete = 0
					
	</select>
	
	
	<select id="getLastRowItemAutoCloseAlert" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    		u.`time`, 
    		u.`id_device`, 
    		u.`error`
		FROM ${datatablename} u 
		LEFT JOIN device d ON u.id_device = d.id
		LEFT JOIN site s ON d.id_site = s.id
		LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE u.id_device = #{id_device}
		AND CONVERT_TZ( u.time, '+00:00', t.`offset` ) <![CDATA[<=]]>  CONVERT_TZ( ( NOW() ), 'UTC', t.`value` )
		ORDER BY `time` DESC LIMIT 1;
  	</select>
  	
  	
  	<select id="getLastRowItemCheckNoCommunication" resultType="com.nwm.api.entities.BatchJobTableEntity">
    	SELECT
    		u.`time`, 
    		u.`id_device`, 
    		u.`error`,
    		IFNULL(u.nvmActivePower, 0.001) AS nvmActivePower,
    		u.nvmActiveEnergy,
    		d.devicename
		FROM ${datatablename} u 
		LEFT JOIN device d ON u.id_device = d.id
		LEFT JOIN site s ON d.id_site = s.id
		LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE u.id_device = #{id_device}
		AND DATE_FORMAT(CONVERT_TZ( u.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:%i:%s') <![CDATA[>=]]> DATE_FORMAT(CONVERT_TZ( DATE_ADD( NOW() ,INTERVAL -30 MINUTE) , '+00:00', t.`offset` ) , '%Y-%m-%d %H:%i:%s') 
		
		AND DATE_FORMAT(CONVERT_TZ( u.time, '+00:00', t.`offset` ), "%Y-%m-%d %H:%i:%s") <![CDATA[<=]]> DATE_FORMAT( #{current_time}, "%Y-%m-%d 18:00:00")
		
		ORDER BY u.time DESC LIMIT 1;
  	</select>
  	
  	<select id="getAlertDetail" resultType="com.nwm.api.entities.AlertEntity">
    	SELECT
    	u.*
		FROM `alert` as u
		WHERE u.id_device = #{id_device} AND u.id_error = #{id_error} AND u.`status` = 1 AND u.is_delete = 0
			LIMIT 1;
  	</select>
  	
  	

  	
  	
  	<delete id="deleteAlert">
		DELETE FROM `alert`
		WHERE id = #{id} AND id_device = #{id_device} AND id_error = #{id_error}
	</delete>
	
	<update id="UpdateErrorMultiRow">
	    UPDATE `alert` SET `status` = 0, `end_date` = #{end_date} 
	    WHERE `id_error` = #{id_error} AND `id_device` = #{id_device}
	</update>

	
	
	
	<select id="getDeviceDatalogger" resultMap="BatchJobMap" parameterType="Integer">
		SELECT
			* 
		FROM
			device d 
		WHERE
			d.`status` = 1 
			AND d.id_site = #{id_site}
			AND d.id_device_group = 19 
			LIMIT 1
	</select>
	
	
	<select id="getDataloggerItem" resultType="com.nwm.api.entities.BatchJobTableEntity">
		SELECT
			* 
		FROM
			model_datalogger m
			LEFT JOIN device d ON d.id = m.id_device
			LEFT JOIN site s ON s.id = d.id_site
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
		WHERE
			m.id_device = #{id_device}
			AND DATE_FORMAT(CONVERT_TZ( m.time, '+00:00', t.`offset` ) , '%Y-%m-%d %H:%i:%s') <![CDATA[>=]]> DATE_FORMAT(CONVERT_TZ( DATE_ADD( NOW() ,INTERVAL -30 MINUTE) , '+00:00', t.`offset` ) , '%Y-%m-%d %H:%i:%s')
			LIMIT 1;
			
  	</select>
  	
  	
  	<select id="getListDeviceMeterAndInverter" resultType="Map">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
		WHERE
			dt.id IN(1,3) 
			AND d.id_site = #{id}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getListDeviceMeterBySite" resultType="com.nwm.api.entities.DeviceEntity">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
		WHERE
			dt.id IN(3) 
			AND d.id_site = #{id}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	<select id="getListDeviceWeather" resultType="com.nwm.api.entities.DeviceEntity">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
		WHERE
			dt.id IN(4) 
			AND d.id_site = #{id}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getListDeviceInverterBySite" resultType="com.nwm.api.entities.DeviceEntity">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
		WHERE
			dt.id IN(1) 
			AND d.id_site = #{id}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	
	
	<select id="getSiteDataReportIIMW" resultType="com.nwm.api.entities.SiteDataReportEntity">
		SELECT
			t.id_device,
			t.time_full AS `time`,
			t.InverterUptime,
			IFNULL(pa.DayTime, (t.end_date_time - t.start_date_time)) AS DayTime,
			ROUND(t.InverterUptime/ (IFNULL(pa.DayTime, (t.end_date_time - t.start_date_time))), 2 ) AS InverterUptimeDaytime,
			ROUND(ac.nvmActiveEnergy, 2) AS ActualGenerationFromMeter,
			ROUND(ac.estimated, 2) AS EstimatedGeneration,
			ROUND(ac.nvmActiveEnergy/ac.estimated, 2) AS EstimatedGenerationIndex,
			IF( (ROUND(t.InverterUptime/ (IFNULL(pa.DayTime, (t.end_date_time - t.start_date_time))), 2 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 2)) > 1 , 1, ROUND(ROUND(t.InverterUptime/ (IFNULL(pa.DayTime, (t.end_date_time - t.start_date_time))), 2 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 2),2)) AS InverterAvailability,
			t.nvmActivePower AS PowerTodayTotal,
			0 AS EnergyTodayTotal,
			0 AS PowerTodayAVG,
			0 AS EnergyTodayAVG,
			0 AS POATotal,
			0 AS POAAVG
		FROM (
			SELECT 
				iv.id_site,
				iv.id_device,
				iv.time_full,
				iv.start_date_time,
				iv.end_date_time,
				iv.format_date,
				COUNT(IF(iv.nvmActivePower > 0, format_date, NULL)) AS InverterUptime,
				ROUND(SUM(iv.nvmActivePower), 2) AS nvmActivePower
			FROM (
				SELECT
						d.id_site,
						dv.id_device,
						s.start_date_time,
						s.end_date_time,
						dv.time,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:00' ) AS time_format,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
						IF(SUM(dv.nvmActivePower) <![CDATA[<]]> 0.1, 0, SUM(dv.nvmActivePower)) AS nvmActivePower
					FROM
						${datatablename} dv
						LEFT JOIN device d ON d.id = dv.id_device
						LEFT JOIN site s ON s.id = d.id_site 
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
					WHERE
						dv.id_device = #{id}
						AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
						AND s.`status` = 1 
						AND d.`status` = 1 
					GROUP BY time_format
			)iv
			GROUP BY iv.format_date
		)t
		LEFT JOIN (
			SELECT 
				p.id_device,
				p.time_full,
				p.format_date,
				COUNT(*) AS DayTime
				
			FROM (
				<foreach collection="groupWeather" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT 
							d.id_site,
							poa.id_device,
							poa.time,
							DATE_FORMAT( CONVERT_TZ( poa.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:00' ) AS time_format,
							DATE_FORMAT( CONVERT_TZ( poa.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
							DATE_FORMAT( CONVERT_TZ( poa.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
							IF(SUM(poa.nvm_irradiance) < 0.1, 0, SUM(poa.nvm_irradiance)) AS nvm_irradiance
						FROM ${item.datatablename} poa 
						LEFT JOIN device d ON d.id = poa.id_device
						LEFT JOIN site s ON s.id = d.id_site 
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							poa.id_device = #{item.id}
							AND (CONVERT_TZ( poa.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
							AND s.`status` = 1 
							AND d.`status` = 1 
						GROUP BY time_format 
					]]>
			      </foreach>
				
				
			)p 
			WHERE p.nvm_irradiance > 0
			GROUP BY p.format_date
		)pa ON pa.format_date = t.format_date
		
		LEFT JOIN (
		
			SELECT 
				k.estimated,
				k.time_month,
				k.time_full,
				k.format_date,
				SUM(k.nvmActiveEnergy) AS nvmActiveEnergy
			 FROM (
			 	<foreach collection="groupMeter" item="item" index="index" separator="union all">
				<![CDATA[
				SELECT 
					iv.id_device,
					iv.time_full,
					iv.format_date,
					SUM(iv.nvmActiveEnergy) AS nvmActiveEnergy,
					iv.time_month,
					CASE
						 when iv.time_month = '01' then ROUND((SELECT en.jan FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '02' then ROUND((SELECT en.feb FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/28)
						 when iv.time_month = '03' then ROUND((SELECT en.mar FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '04' then ROUND((SELECT en.apr FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '05' then ROUND((SELECT en.may FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '06' then ROUND((SELECT en.jun FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '07' then ROUND((SELECT en.jul FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '08' then ROUND((SELECT en.aug FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '09' then ROUND((SELECT en.sep FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '10' then ROUND((SELECT en.oct FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '11' then ROUND((SELECT en.nov FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '12' then ROUND((SELECT en.`dec` FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						END as estimated
				FROM (
					SELECT
							d.id_site,
							dv.id_device,
							dv.time,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS time_format,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m' ) AS time_month,
							MAX(dv.nvmActiveEnergy) - MIN(dv.nvmActiveEnergy) AS nvmActiveEnergy
						FROM
							${item.datatablename} dv
							LEFT JOIN device d ON d.id = dv.id_device
							LEFT JOIN site s ON s.id = d.id_site 
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							dv.id_device = #{item.id}
							AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
							AND s.`status` = 1 
							AND d.`status` = 1 
							AND dv.nvmActiveEnergy > 0
						GROUP BY d.id, time_format
				)iv
				GROUP BY iv.format_date
				]]>
		      </foreach>
			 )k
			
		)ac ON ac.format_date = t.format_date LIMIT 1
		
	</select>
	
	
	
	<select id="getSiteDataReportMIMW" resultType="com.nwm.api.entities.SiteDataReportEntity">
		SELECT
			t.id_device,
			t.time_full AS `time`,
			t.InverterUptime,
			IFNULL(pa.DayTime, (t.end_date_time - t.start_date_time)) AS DayTime,
			ROUND(t.InverterUptime/ (IFNULL(pa.DayTime, (t.end_date_time - t.start_date_time))), 2 ) AS InverterUptimeDaytime,
			ROUND(ac.nvmActiveEnergy, 2) AS ActualGenerationFromMeter,
			ROUND(ac.estimated,2) AS EstimatedGeneration,
			ROUND(ac.nvmActiveEnergy/ac.estimated, 2) AS EstimatedGenerationIndex,
			IF( (ROUND(t.InverterUptime/ (IFNULL(pa.DayTime, (t.end_date_time - t.start_date_time))), 2 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 2)) > 1 , 1, ROUND(ROUND(t.InverterUptime/ (IFNULL(pa.DayTime, (t.end_date_time - t.start_date_time))), 2 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 2),2)) AS InverterAvailability,
			t.nvmActivePower AS PowerTodayTotal,
			0 AS EnergyTodayTotal,
			0 AS PowerTodayAVG,
			0 AS EnergyTodayAVG,
			0 AS POATotal,
			0 AS POAAVG
		FROM (
			SELECT 
				iv.id_site,
				iv.id_device,
				iv.time_full,
				iv.start_date_time,
				iv.end_date_time,
				iv.format_date,
				COUNT(IF(iv.nvmActivePower > 0, format_date, NULL)) AS InverterUptime,
				ROUND(SUM(iv.nvmActivePower), 2) AS nvmActivePower
				
			FROM (
				SELECT
						d.id_site,
						dv.id_device,
						s.start_date_time,
						s.end_date_time,
						dv.time,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:00' ) AS time_format,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
						IF(SUM(dv.nvmActivePower) <![CDATA[<]]> 0.1, 0, SUM(dv.nvmActivePower)) AS nvmActivePower
					FROM
						${datatablename} dv
						LEFT JOIN device d ON d.id = dv.id_device
						LEFT JOIN site s ON s.id = d.id_site 
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
					WHERE
						dv.id_device = #{id}
						AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
						AND s.`status` = 1 
						AND d.`status` = 1 
					GROUP BY time_format
			)iv
			GROUP BY iv.format_date
		)t
		LEFT JOIN (
			SELECT 
				p.id_device,
				p.time_full,
				p.format_date,
				COUNT(*) AS DayTime
				
			FROM (
				<foreach collection="groupWeather" item="item" index="index" separator="union all">
					<![CDATA[
						SELECT 
							d.id_site,
							poa.id_device,
							poa.time,
							DATE_FORMAT( CONVERT_TZ( poa.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:00' ) AS time_format,
							DATE_FORMAT( CONVERT_TZ( poa.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
							DATE_FORMAT( CONVERT_TZ( poa.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
							IF(SUM(poa.nvm_irradiance) < 0.1, 0, SUM(poa.nvm_irradiance)) AS nvm_irradiance
						FROM ${item.datatablename} poa 
						LEFT JOIN device d ON d.id = poa.id_device
						LEFT JOIN site s ON s.id = d.id_site 
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							poa.id_device = #{item.id}
							AND (CONVERT_TZ( poa.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
							AND s.`status` = 1 
							AND d.`status` = 1 
						GROUP BY time_format 
					]]>
			      </foreach>
				
				
			)p 
			WHERE p.nvm_irradiance > 0
			GROUP BY p.format_date
		)pa ON pa.format_date = t.format_date
		
		LEFT JOIN (
		
			SELECT 
				k.estimated,
				k.time_month,
				k.time_full,
				k.format_date,
				SUM(k.nvmActiveEnergy) AS nvmActiveEnergy
			 FROM (
			 	<foreach collection="groupMeter" item="item" index="index" separator="union all">
				<![CDATA[
				SELECT 
					iv.id_device,
					iv.time_full,
					iv.format_date,
					SUM(iv.nvmActiveEnergy) AS nvmActiveEnergy,
					iv.time_month,
					CASE
						 when iv.time_month = '01' then ROUND((SELECT en.jan FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '02' then ROUND((SELECT en.feb FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/28)
						 when iv.time_month = '03' then ROUND((SELECT en.mar FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '04' then ROUND((SELECT en.apr FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '05' then ROUND((SELECT en.may FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '06' then ROUND((SELECT en.jun FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '07' then ROUND((SELECT en.jul FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '08' then ROUND((SELECT en.aug FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '09' then ROUND((SELECT en.sep FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '10' then ROUND((SELECT en.oct FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '11' then ROUND((SELECT en.nov FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '12' then ROUND((SELECT en.`dec` FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						END as estimated
				FROM (
					SELECT
							d.id_site,
							dv.id_device,
							dv.time,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS time_format,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m' ) AS time_month,
							MAX(dv.nvmActiveEnergy) - MIN(dv.nvmActiveEnergy) AS nvmActiveEnergy
						FROM
							${item.datatablename} dv
							LEFT JOIN device d ON d.id = dv.id_device
							LEFT JOIN site s ON s.id = d.id_site 
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							dv.id_device = #{item.id}
							AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
							AND s.`status` = 1 
							AND d.`status` = 1 
							AND dv.nvmActiveEnergy > 0
						GROUP BY d.id, time_format
				)iv
				GROUP BY iv.format_date
				]]>
		      </foreach>
			 )k
			
		)ac ON ac.format_date = t.format_date LIMIT 1
		
	</select>
	
	
	<insert id="insertSiteDataReport" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `site_data_report`(
			`time`,
			`id_device`,
			`InverterUptime`,
			`DayTime`,
			`InverterUptimeDaytime`,
			`ActualGenerationFromMeter`,
			`EstimatedGeneration`,
			`EstimatedGenerationIndex`,
			`InverterAvailability`,
			`PowerTodayTotal`,
			`EnergyTodayTotal`,
			`PowerTodayAVG`,
			`EnergyTodayAVG`,
			`POATotal`,
			`POAAVG`
		)VALUES(
			#{time},
			#{id_device},
			#{InverterUptime},
			#{DayTime},
			#{InverterUptimeDaytime},
			#{ActualGenerationFromMeter},
			#{EstimatedGeneration},
			#{EstimatedGenerationIndex},
			#{InverterAvailability},
			#{PowerTodayTotal},
			#{EnergyTodayTotal},
			#{PowerTodayAVG},
			#{EnergyTodayAVG},
			#{POATotal},
			#{POAAVG}
		)
		ON DUPLICATE KEY UPDATE
				InverterUptime = #{InverterUptime},
				DayTime = #{DayTime},
				InverterUptimeDaytime = #{InverterUptimeDaytime},
				ActualGenerationFromMeter = #{ActualGenerationFromMeter},
				EstimatedGeneration = #{EstimatedGeneration},
				EstimatedGenerationIndex = #{EstimatedGenerationIndex},
				InverterAvailability = #{InverterAvailability},
				PowerTodayTotal = #{PowerTodayTotal},
				EnergyTodayTotal = #{EnergyTodayTotal},
				PowerTodayAVG = #{PowerTodayAVG},
				EnergyTodayAVG = #{EnergyTodayAVG},
				POATotal = #{POATotal},
				POAAVG = #{POAAVG};
	</insert>
	
	
	<select id="getSiteDataReportIIM" resultType="com.nwm.api.entities.SiteDataReportEntity">
		SELECT
			t.id_device,
			t.time_full AS `time`,
			t.InverterUptime,
			t.end_date_time - t.start_date_time AS DayTime,
			
			ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 2 ) AS InverterUptimeDaytime,
			ROUND(ac.nvmActiveEnergy, 2) AS ActualGenerationFromMeter,
			ROUND(ac.estimated, 2) AS EstimatedGeneration,
			ROUND(ac.nvmActiveEnergy/ac.estimated, 2) AS EstimatedGenerationIndex,
			IF( (ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 3 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 3)) > 1 , 1, ROUND(ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 3 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 3),3)) AS InverterAvailability,
			t.nvmActivePower AS PowerTodayTotal,
			0 AS EnergyTodayTotal,
			0 AS PowerTodayAVG,
			0 AS EnergyTodayAVG,
			0 AS POATotal,
			0 AS POAAVG
		FROM (
			SELECT 
				iv.id_site,
				iv.id_device,
				iv.time_full,
				iv.start_date_time,
				iv.end_date_time,
				iv.format_date,
				COUNT(IF(iv.nvmActivePower > 0, format_date, NULL)) AS InverterUptime,
				ROUND(SUM(iv.nvmActivePower), 2) AS nvmActivePower
			FROM (
				SELECT
						d.id_site,
						dv.id_device,
						s.start_date_time,
						s.end_date_time,
						dv.time,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:00' ) AS time_format,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
						IF(AVG(dv.nvmActivePower) <![CDATA[<]]> 0.1, 0, ROUND(AVG(dv.nvmActivePower),2) ) AS nvmActivePower
					FROM
						${datatablename} dv
						LEFT JOIN device d ON d.id = dv.id_device
						LEFT JOIN site s ON s.id = d.id_site 
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
					WHERE
						dv.id_device = #{id}
						AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
						AND s.`status` = 1 
						AND d.`status` = 1 
					GROUP BY time_format
			)iv
			GROUP BY iv.format_date
		)t
	
		
		LEFT JOIN (
		
			SELECT 
				k.estimated,
				k.time_month,
				k.time_full,
				k.format_date,
				SUM(k.nvmActiveEnergy) AS nvmActiveEnergy
			 FROM (
			 	<foreach collection="groupMeter" item="item" index="index" separator="union all">
				<![CDATA[
				SELECT 
					iv.id_device,
					iv.time_full,
					iv.format_date,
					SUM(iv.nvmActiveEnergy) AS nvmActiveEnergy,
					iv.time_month,
					CASE
						 when iv.time_month = '01' then ROUND((SELECT en.jan FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '02' then ROUND((SELECT en.feb FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/28)
						 when iv.time_month = '03' then ROUND((SELECT en.mar FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '04' then ROUND((SELECT en.apr FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '05' then ROUND((SELECT en.may FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '06' then ROUND((SELECT en.jun FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '07' then ROUND((SELECT en.jul FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '08' then ROUND((SELECT en.aug FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '09' then ROUND((SELECT en.sep FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '10' then ROUND((SELECT en.oct FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '11' then ROUND((SELECT en.nov FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '12' then ROUND((SELECT en.`dec` FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						END as estimated
				FROM (
					SELECT
							d.id_site,
							dv.id_device,
							dv.time,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS time_format,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m' ) AS time_month,
							MAX(dv.nvmActiveEnergy) - MIN(dv.nvmActiveEnergy) AS nvmActiveEnergy
						FROM
							${item.datatablename} dv
							LEFT JOIN device d ON d.id = dv.id_device
							LEFT JOIN site s ON s.id = d.id_site 
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							dv.id_device = #{item.id}
							AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
							AND s.`status` = 1 
							AND d.`status` = 1 
							AND dv.nvmActiveEnergy > 0
						GROUP BY d.id, time_format
				)iv
				GROUP BY iv.format_date
				]]>
		      </foreach>
			 )k
			
		)ac ON ac.format_date = t.format_date LIMIT 1
		
	</select>
	
	<select id="getSiteDataReportMIM" resultType="com.nwm.api.entities.SiteDataReportEntity">
		SELECT
			t.id_device,
			t.time_full AS `time`,
			t.InverterUptime,
			t.end_date_time - t.start_date_time AS DayTime,
			ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 2 ) AS InverterUptimeDaytime,
			ROUND(ac.nvmActiveEnergy, 2) AS ActualGenerationFromMeter,
			ROUND(ac.estimated,2) AS EstimatedGeneration,
			ROUND(ac.nvmActiveEnergy/ac.estimated, 2) AS EstimatedGenerationIndex,
			IF( (ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 3 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 3)) > 1 , 1, ROUND(ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 3 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 3),3)) AS InverterAvailability,
			t.nvmActivePower AS PowerTodayTotal,
			0 AS EnergyTodayTotal,
			0 AS PowerTodayAVG,
			0 AS EnergyTodayAVG,
			0 AS POATotal,
			0 AS POAAVG
		FROM (
			SELECT 
				iv.id_site,
				iv.id_device,
				iv.time_full,
				iv.start_date_time,
				iv.end_date_time,
				iv.format_date,
				COUNT(IF(iv.nvmActivePower > 0, format_date, NULL)) AS InverterUptime,
				ROUND(SUM(iv.nvmActivePower), 2) AS nvmActivePower
				
			FROM (
				SELECT
						d.id_site,
						dv.id_device,
						s.start_date_time,
						s.end_date_time,
						dv.time,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:00' ) AS time_format,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
						IF(AVG(dv.nvmActivePower) <![CDATA[<]]> 0.1, 0, ROUND(AVG(dv.nvmActivePower),2) ) AS nvmActivePower
					FROM
						${datatablename} dv
						LEFT JOIN device d ON d.id = dv.id_device
						LEFT JOIN site s ON s.id = d.id_site 
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
					WHERE
						dv.id_device = #{id}
						AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
						AND s.`status` = 1 
						AND d.`status` = 1 
					GROUP BY time_format
			)iv
			GROUP BY iv.format_date
		)t
		
		LEFT JOIN (
		
			SELECT 
				k.estimated,
				k.time_month,
				k.time_full,
				k.format_date,
				SUM(k.nvmActiveEnergy) AS nvmActiveEnergy
			 FROM (
			 	<foreach collection="groupMeter" item="item" index="index" separator="union all">
				<![CDATA[
				SELECT 
					iv.id_device,
					iv.time_full,
					iv.format_date,
					SUM(iv.nvmActiveEnergy) AS nvmActiveEnergy,
					iv.time_month,
					CASE
						 when iv.time_month = '01' then ROUND((SELECT en.jan FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '02' then ROUND((SELECT en.feb FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/28)
						 when iv.time_month = '03' then ROUND((SELECT en.mar FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '04' then ROUND((SELECT en.apr FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '05' then ROUND((SELECT en.may FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '06' then ROUND((SELECT en.jun FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '07' then ROUND((SELECT en.jul FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '08' then ROUND((SELECT en.aug FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '09' then ROUND((SELECT en.sep FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '10' then ROUND((SELECT en.oct FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '11' then ROUND((SELECT en.nov FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '12' then ROUND((SELECT en.`dec` FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						END as estimated
				FROM (
					SELECT
							d.id_site,
							dv.id_device,
							dv.time,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS time_format,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m' ) AS time_month,
							MAX(dv.nvmActiveEnergy) - MIN(dv.nvmActiveEnergy) AS nvmActiveEnergy
						FROM
							${item.datatablename} dv
							LEFT JOIN device d ON d.id = dv.id_device
							LEFT JOIN site s ON s.id = d.id_site 
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							dv.id_device = #{item.id}
							AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
							AND s.`status` = 1 
							AND d.`status` = 1 
							AND dv.nvmActiveEnergy > 0
						GROUP BY d.id, time_format
				)iv
				GROUP BY iv.format_date
				]]>
		      </foreach>
			 )k
			
		)ac ON ac.format_date = t.format_date LIMIT 1
		
	</select>
	
	<select id="getSiteDataReportIIW" resultType="com.nwm.api.entities.SiteDataReportEntity">
		SELECT
			t.id_device,
			t.time_full AS `time`,
			t.InverterUptime,
			t.end_date_time - t.start_date_time AS DayTime,
			ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 2 ) AS InverterUptimeDaytime,
			ROUND(ac.nvmActiveEnergy, 2) AS ActualGenerationFromMeter,
			ROUND(ac.estimated, 2) AS EstimatedGeneration,
			ROUND(ac.nvmActiveEnergy/ac.estimated, 2) AS EstimatedGenerationIndex,
			IF( (ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 3 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 3)) > 1 , 1, ROUND(ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 3 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 3),3)) AS InverterAvailability,
			t.nvmActivePower AS PowerTodayTotal,
			0 AS EnergyTodayTotal,
			0 AS PowerTodayAVG,
			0 AS EnergyTodayAVG,
			0 AS POATotal,
			0 AS POAAVG
		FROM (
			SELECT 
				iv.id_site,
				iv.id_device,
				iv.time_full,
				iv.start_date_time,
				iv.end_date_time,
				iv.format_date,
				COUNT(IF(iv.nvmActivePower > 0.1, format_date, NULL)) AS InverterUptime,
				ROUND(SUM(iv.nvmActivePower), 2) AS nvmActivePower
			FROM (
				SELECT
						d.id_site,
						dv.id_device,
						s.start_date_time,
						s.end_date_time,
						dv.time,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:00' ) AS time_format,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
						IF(AVG(dv.nvmActivePower) <![CDATA[<]]> 0.1, 0, ROUND(AVG(dv.nvmActivePower),2) ) AS nvmActivePower
					FROM
						${datatablename} dv
						LEFT JOIN device d ON d.id = dv.id_device
						LEFT JOIN site s ON s.id = d.id_site 
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
					WHERE
						dv.id_device = #{id}
						AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
						AND s.`status` = 1 
						AND d.`status` = 1 
					GROUP BY time_format
			)iv
			GROUP BY iv.format_date
		)t
		
		LEFT JOIN (
		
			SELECT 
				k.estimated,
				k.time_month,
				k.time_full,
				k.format_date,
				SUM(k.nvmActiveEnergy) AS nvmActiveEnergy
			 FROM (
			 	<foreach collection="groupInverter" item="item" index="index" separator="union all">
				<![CDATA[
				SELECT 
					iv.id_device,
					iv.time_full,
					iv.format_date,
					SUM(iv.nvmActiveEnergy) AS nvmActiveEnergy,
					iv.time_month,
					CASE
						 when iv.time_month = '01' then ROUND((SELECT en.jan FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '02' then ROUND((SELECT en.feb FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/28)
						 when iv.time_month = '03' then ROUND((SELECT en.mar FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '04' then ROUND((SELECT en.apr FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '05' then ROUND((SELECT en.may FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '06' then ROUND((SELECT en.jun FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '07' then ROUND((SELECT en.jul FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '08' then ROUND((SELECT en.aug FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '09' then ROUND((SELECT en.sep FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '10' then ROUND((SELECT en.oct FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '11' then ROUND((SELECT en.nov FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '12' then ROUND((SELECT en.`dec` FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						END as estimated
				FROM (
					SELECT
							d.id_site,
							dv.id_device,
							dv.time,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS time_format,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m' ) AS time_month,
							MAX(dv.nvmActiveEnergy) - MIN(dv.nvmActiveEnergy) AS nvmActiveEnergy
						FROM
							${item.datatablename} dv
							LEFT JOIN device d ON d.id = dv.id_device
							LEFT JOIN site s ON s.id = d.id_site 
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							dv.id_device = #{item.id}
							AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
							AND s.`status` = 1 
							AND d.`status` = 1 
							AND dv.nvmActiveEnergy > 0
						GROUP BY d.id, time_format
				)iv
				GROUP BY iv.format_date
				]]>
		      </foreach>
			 )k
			
		)ac ON ac.format_date = t.format_date LIMIT 1
		
	</select>
	
	
	<select id="getSiteDataReportMM" resultType="com.nwm.api.entities.SiteDataReportEntity">
		SELECT
			t.id_device,
			t.time_full AS `time`,
			t.InverterUptime,
			t.end_date_time - t.start_date_time AS DayTime,
			ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 2 ) AS InverterUptimeDaytime,
			ROUND(ac.nvmActiveEnergy, 2) AS ActualGenerationFromMeter,
			ROUND(ac.estimated,2) AS EstimatedGeneration,
			ROUND(ac.nvmActiveEnergy/ac.estimated, 2) AS EstimatedGenerationIndex,
			IF( (ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 3 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 3)) > 1 , 1, ROUND(ROUND(t.InverterUptime/ (t.end_date_time - t.start_date_time), 3 ) * ROUND(ac.nvmActiveEnergy/ac.estimated, 3),3)) AS InverterAvailability,
			t.nvmActivePower AS PowerTodayTotal,
			0 AS EnergyTodayTotal,
			0 AS PowerTodayAVG,
			0 AS EnergyTodayAVG,
			0 AS POATotal,
			0 AS POAAVG
		FROM (
			SELECT 
				iv.id_site,
				iv.id_device,
				iv.time_full,
				iv.start_date_time,
				iv.end_date_time,
				iv.format_date,
				COUNT(IF(iv.nvmActivePower > 0.1, format_date, NULL)) AS InverterUptime,
				ROUND(SUM(iv.nvmActivePower), 2) AS nvmActivePower
				
			FROM (
				SELECT
						d.id_site,
						dv.id_device,
						s.start_date_time,
						s.end_date_time,
						dv.time,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d %H:00' ) AS time_format,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
						DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
						IF(AVG(dv.nvmActivePower) <![CDATA[<]]> 0.1, 0, ROUND(AVG(dv.nvmActivePower),2) ) AS nvmActivePower
					FROM
						${datatablename} dv
						LEFT JOIN device d ON d.id = dv.id_device
						LEFT JOIN site s ON s.id = d.id_site 
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
					WHERE
						dv.id_device = #{id}
						AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
						AND s.`status` = 1 
						AND d.`status` = 1 
					GROUP BY time_format
			)iv
			GROUP BY iv.format_date
		)t
		
		LEFT JOIN (
		
			SELECT 
				k.estimated,
				k.time_month,
				k.time_full,
				k.format_date,
				SUM(k.nvmActiveEnergy) AS nvmActiveEnergy
			 FROM (
			 	<foreach collection="groupMeter" item="item" index="index" separator="union all">
				<![CDATA[
				SELECT 
					iv.id_device,
					iv.time_full,
					iv.format_date,
					SUM(iv.nvmActiveEnergy) AS nvmActiveEnergy,
					iv.time_month,
					CASE
						 when iv.time_month = '01' then ROUND((SELECT en.jan FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '02' then ROUND((SELECT en.feb FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/28)
						 when iv.time_month = '03' then ROUND((SELECT en.mar FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '04' then ROUND((SELECT en.apr FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '05' then ROUND((SELECT en.may FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '06' then ROUND((SELECT en.jun FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '07' then ROUND((SELECT en.jul FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '08' then ROUND((SELECT en.aug FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '09' then ROUND((SELECT en.sep FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '10' then ROUND((SELECT en.oct FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						 when iv.time_month = '11' then ROUND((SELECT en.nov FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/30)
						 when iv.time_month = '12' then ROUND((SELECT en.`dec` FROM energy_expectations en WHERE en.id_site=#{item.id_site} AND `year`=${year})/31)
						END as estimated
				FROM (
					SELECT
							d.id_site,
							dv.id_device,
							dv.time,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS time_format,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d 00:00' ) AS time_full,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%Y-%m-%d' ) AS format_date,
							DATE_FORMAT( CONVERT_TZ( dv.time, '+00:00', t.`offset` ), '%m' ) AS time_month,
							MAX(dv.nvmActiveEnergy) - MIN(dv.nvmActiveEnergy) AS nvmActiveEnergy
						FROM
							${item.datatablename} dv
							LEFT JOIN device d ON d.id = dv.id_device
							LEFT JOIN site s ON s.id = d.id_site 
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
						WHERE
							dv.id_device = #{item.id}
							AND (CONVERT_TZ( dv.time, '+00:00', t.`offset` ) BETWEEN #{start_date} AND #{end_date})
							AND s.`status` = 1 
							AND d.`status` = 1 
							AND dv.nvmActiveEnergy > 0
						GROUP BY d.id, time_format
				)iv
				GROUP BY iv.format_date
				]]>
		      </foreach>
			 )k
			
		)ac ON ac.format_date = t.format_date LIMIT 1
		
	</select>
	
  	
	
  	
  	
</mapper>