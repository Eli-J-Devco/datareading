<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Reports">
	<resultMap id="ReportsMap" type="com.nwm.api.entities.ReportsEntity">
		<result property="id" column="id" />
		<result property="id_site" column="id_site" />
		<result property="id_employee" column="id_employee" />
		<result property="report_type" column="report_type" />
		<result property="cadence_range" column="cadence_range" />
		<result property="date_from" column="date_from" />
		<result property="date_to" column="date_to" />
		<result property="subscribers" column="subscribers" />
		<result property="data_intervals" column="data_intervals" />
		<result property="file_type" column="file_type" />
		<result property="status" column="status" />
		<result property="created_date" column="created_date" />
		<result property="created_by" column="created_by" />
		<result property="updated_date" column="updated_date" />
		<result property="updated_by" column="updated_by" />
	</resultMap>
	
	<select id="getListSiteByIdEmployee" resultType="Map">
		SELECT
			s.id,
            <include refid="com.nwm.common.siteName"/> AS `name`
		FROM
			site_employee_map sem
			LEFT JOIN site s ON s.id = sem.id_site
		WHERE
			s.is_delete = 0
			AND s.`status` = 1
			AND sem.id_employee = #{id_employee}
	</select>
	
	<select id="getListSiteSubGroupByEmployee" resultType="Map" >
		SELECT
			ssg.id,
			ssg.id_site_group,
			<include refid="com.nwm.common.siteGroupName"/> AS text
		FROM
			site s
			LEFT JOIN site_sub_group ssg ON ssg.id = s.id_site_sub_group
			LEFT JOIN site_group sg ON sg.id = ssg.id_site_group
		WHERE 
			ssg.status = 1
			AND ssg.is_delete = 0
			AND sg.status = 1
			AND sg.is_delete = 0
			<if test="is_supper_admin != 1 and id_sites != null">
				AND s.id IN  (
					<foreach item="item" index="index" collection="id_sites" separator=" , ">
						#{item.id}
					</foreach>
				)
			</if>
		GROUP BY ssg.id
	    ORDER BY ssg.id ASC
	</select>
	
	<select id="getListSiteBySubGroup" resultType="Map" >
		SELECT
			s.id,
            <include refid="com.nwm.common.siteName"/> AS `name`
		FROM
			site s
			LEFT JOIN site_sub_group ssg ON ssg.id = s.id_site_sub_group
			LEFT JOIN site_group sg ON sg.id = ssg.id_site_group
		WHERE 
			s.`status` = 1
			AND s.is_delete = 0
			AND ssg.status = 1
			AND ssg.is_delete = 0
			AND sg.status = 1
			AND sg.is_delete = 0
			AND s.id_site_sub_group = #{id_sub_group}
	</select>
	
	<select id="getListSelectedSiteByIdSite" resultType="Map" >
		SELECT
			s.id,
			<include refid="com.nwm.common.siteName"/> AS `name`
		FROM
			site s
		WHERE 
			s.`status` = 1
			AND s.is_delete = 0
			AND s.id IN (${ids_site})
	</select>
	
	<insert id="insertReports" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `report`(
			`id_site`,
			`id_employee`,
			`name`,
			`type_report`,
			`cadence_range`,
			`date_from`,
			`date_to`,
			`subscribers`,
			`data_intervals`,
			`file_type`,
			`status`,
			`created_date`,
			`created_by`,
			`id_sub_group`,
			`type_option`,
			`schedule_enable`,
			`periodicity`,
			`time_schedule`,
			`days_week`,
			`offset_timezone`
		)VALUES(
			#{id_site},
			#{created_by},
			IF(TRIM(#{name}) = '', NULL, #{name}),
			#{type_report},
			#{cadence_range},
			#{date_from},
			#{date_to},
			#{subscribers},
			#{data_intervals},
			#{file_type},
			#{status},
			NOW(),
			#{created_by},
			#{id_sub_group},
			#{type_option},
			#{schedule_enable},
			#{periodicity},
			#{time_schedule},
			#{days_week},
			#{offset_timezone}
		);
		<selectKey keyProperty="id" resultType="int">
	        SELECT 
	        LAST_INSERT_ID() as id
        </selectKey>
	</insert>
	
	<update id="updateReports">
		UPDATE `report`
		SET
			`id_site` = #{id_site},
			`name` = IF(TRIM(#{name}) = '', NULL, #{name}),
			`type_report` = #{type_report},
			`cadence_range` = #{cadence_range},
			`date_from` = #{date_from},
			`date_to` = #{date_to},
			`subscribers` = #{subscribers},
			`data_intervals` = #{data_intervals},
			`file_type` = #{file_type},
			`status` = #{status},
			`updated_date` = NOW(),
			`updated_by` = #{updated_by},
			`id_sub_group` = #{id_sub_group},
			`type_option` = #{type_option},
			`schedule_enable` = #{schedule_enable},
			`periodicity` = #{periodicity},
			`time_schedule` = #{time_schedule},
			`days_week` = #{days_week},
			`offset_timezone` = #{offset_timezone},
			`next_run_time` = NULL
		WHERE
			`id` = #{id}
	</update>
	
	<insert id="duplicate" parameterType="com.nwm.api.entities.ReportDuplicateRequest" useGeneratedKeys="true" keyProperty="newId">
		INSERT INTO `report` (
			id_employee,
			id_site,
			name,
			type_report,
			cadence_range,
			date_from,
			date_to,
			subscribers,
			data_intervals,
			file_type,
			created_date,
			created_by,
			id_sub_group,
			type_option,
			schedule_enable,
			periodicity,
			time_schedule,
			days_week,
			offset_timezone,
			duplicated_from
		)
		WITH RECURSIVE cte(id) AS (
			SELECT
				#{id}
			UNION ALL
			SELECT
				report.duplicated_from
			FROM
				report
				JOIN cte ON report.id = cte.id
			WHERE
				report.id = cte.id
		)
		SELECT
			#{created_by},
			id_site,
			name,
			type_report,
			cadence_range,
			date_from,
			date_to,
			subscribers,
			data_intervals,
			file_type,
			NOW(),
			#{created_by},
			id_sub_group,
			type_option,
			schedule_enable,
			periodicity,
			time_schedule,
			days_week,
			offset_timezone,
			(SELECT MIN(id) FROM cte)
		FROM
			`report`
		WHERE
			id = #{id};
		
		<selectKey keyProperty="newId" resultType="int">
	        SELECT LAST_INSERT_ID()
        </selectKey>
	</insert>
	
	<sql id="reportName">
		CONCAT_WS(
			" ",
			IFNULL(
				r.name,
				CASE r.type_option
					WHEN 1 THEN "Entire Portfolio"
					WHEN 2 THEN CONCAT(SUBSTRING_INDEX(GROUP_CONCAT(<include refid="com.nwm.common.siteName"/> SEPARATOR " / "), " / ", 3), IF(COUNT(*) > 3, " /...", ""))
					WHEN 3 THEN CONCAT_WS(" ", <include refid="com.nwm.common.siteGroupName"/>, "Sub-Group")
					WHEN 4 THEN "REC"
					ELSE ""
				END
			),
			CASE r.type_report
	    		WHEN 1 THEN "Solar Production Report"
		    	WHEN 2 THEN "Production Trend Report"
		    	WHEN 3 THEN "Leviton BMO Consumption Report"
		    	WHEN 4 THEN "Asset Management and Operation Performance Report"
		    	WHEN 5 THEN "Sanity Check Report"
		    	WHEN 6 THEN "Meter-Level Production vs Irradiance/Temp"
		    	ELSE "Report"
			END,
			IF(
				r.duplicated_from IS NULL,
				NULL,
				IF(
					ROW_NUMBER() OVER(PARTITION BY r.duplicated_from) > 1,
					CONCAT("(COPY ", ROW_NUMBER() OVER(PARTITION BY r.duplicated_from), ")"),
					"(COPY)"
				)
			)
		)
	</sql>
	
	<select id="getList" resultType="Map" >
		SELECT
			<include refid="reportName"/> AS report_name,
			CASE
		    	WHEN r.cadence_range = 1 THEN "Daily"
				WHEN r.cadence_range = 2 THEN "Month-to-Date"
				WHEN r.cadence_range = 3 THEN "Last Full Quarter"
				WHEN r.cadence_range = 4 THEN "Year-to-Date"
				WHEN r.cadence_range = 5 THEN "Custom"
				WHEN r.cadence_range = 6 THEN "Week-to-Date"
				WHEN r.cadence_range = 7 THEN "Last Month"
				WHEN r.cadence_range = 8 THEN "Last Week"
		    	ELSE ""
			END	AS cadence_range_name,
			r.id,
			r.id_employee,
			r.name,
			r.cadence_range,
			r.type_report,
			r.data_intervals,
			<choose> 
	            <when test="domain =='demo.nextwavemonitoring.com' || domain_role == '1ff1de774005f8da13f42943881c655f'">
	                CONCAT_WS("#", "#subscribers", s.id) AS `subscribers`,
	            </when>
	            <otherwise>
			      r.subscribers,
			    </otherwise>                                                  
	        </choose>
	        
			r.file_type,
			r.type_option,
			r.id_sub_group,
			DATE_FORMAT(r.date_from, '%Y-%m-%d 00:00:00') AS date_from,
			DATE_FORMAT(r.date_to, '%Y-%m-%d 23:59:59') AS date_to,
			r.`status`,
			r.schedule_enable,
			DATE_FORMAT(r.time_schedule, '%Y-%m-%d %H:%i') AS time_schedule,
			r.periodicity,
			r.days_week,
			r.offset_timezone,
			DATE_FORMAT(CONVERT_TZ(r.created_date, 'UTC', IFNULL(r.offset_timezone, 'UTC')), '%m/%d/%Y %H:%i %p') AS created_on,
			DATE_FORMAT(CONVERT_TZ(r.updated_date, 'UTC', IFNULL(r.offset_timezone, 'UTC')), '%m/%d/%Y %H:%i %p') AS last_modified,
			GROUP_CONCAT(s.id SEPARATOR ',') AS ids_site,
			JSON_ARRAYAGG(JSON_OBJECT(
				'id', s.id,
				'value', s.id,
				'text', <include refid="com.nwm.common.siteName"/>,
				'label', <include refid="com.nwm.common.siteName"/>,
				'id_group', s.id_site_sub_group
			)) AS sitesListJSON
		FROM
			report r
			JOIN site_employee_map sem ON sem.id_employee = r.id_employee
			JOIN site s ON s.id = sem.id_site
			JOIN time_zone tz ON tz.id = s.id_time_zone
			LEFT JOIN site_sub_group ssg ON ssg.id = s.id_site_sub_group
			LEFT JOIN report_site_map rsm ON r.type_option = 2 AND rsm.id_site = s.id AND rsm.id_report = r.id
		WHERE
			r.status = 1
			<if test="is_supper_admin != 1">
				AND r.id_employee = #{id_employee}
			</if>
			AND s.`status` = 1
			AND s.is_delete = 0
			AND (CONVERT_TZ(NOW(), 'UTC', tz.value) <![CDATA[ < ]]> s.expiration OR s.expiration IS NULL)
			AND (
				CASE r.type_option
					WHEN 1 THEN TRUE
			    	WHEN 2 THEN rsm.id_report IS NOT NULL
			    	WHEN 3 THEN r.id_sub_group = ssg.id
					WHEN 4 THEN s.is_rec_report = 1
			    	ELSE TRUE
				END
			)
		GROUP BY r.id 
		ORDER BY
	        <choose>  
	            <when test="sort_column == 'id'">
	                r.id ${order_by}
	            </when>         
	            <when test="sort_column == 'name'">
	                r.name ${order_by}
	            </when>
	            
	            <otherwise>
			      r.id DESC
			    </otherwise>                                                  
	        </choose>  

		<if test="limit > 0">
			LIMIT ${limit} OFFSET ${offset};
		</if>
	</select>
	
  	
	
	<select id="getListCount"  resultType="int" parameterType="com.nwm.api.entities.ReportsEntity">
    	SELECT count(*) as totalRow
		FROM report r
		WHERE r.status = 1
		<if test="is_supper_admin != 1">
			AND r.id_employee = #{id_employee}
		</if>
		
		
  	</select>
  	
  	
  	
  	<delete id="deleteReports">
		DELETE FROM `report`
		WHERE id = #{id}
	</delete>
	
	<update id="auditLogging">
		UPDATE report_log
		SET
			updated_by = #{updated_by}
		WHERE
			id_report = #{id}
			AND operation = 3
	</update>
	
	<select id="getLogs" resultType="com.nwm.api.entities.ReportLogs">
		SELECT
			r.operation,
			r.site_mapping,
			r.id_site,
			r.name,
			r.type_report,
			r.cadence_range,
			r.date_from,
			r.date_to,
			r.subscribers,
			r.data_intervals,
			r.file_type,
			IF(r.operation = 1, r.created_date, r.updated_date) AS modified_date,
			e.email AS modified_by,
			r.id_sub_group,
			r.type_option,
			r.schedule_enable,
			r.periodicity,
			r.time_schedule,
			r.days_week,
			r.duplicated_from
		FROM
			report_log r
			JOIN employee e ON e.id = IF(r.operation = 1, r.created_by, r.updated_by)
		WHERE
			r.id_report = #{id}
		ORDER BY
			r.id DESC
	</select>
	
	<select id="getSiteDetail" resultType="com.nwm.api.entities.ViewReportEntity" parameterType="com.nwm.api.entities.ViewReportEntity" >
		SELECT
			s.id,
			s.id AS id_site,
			<include refid="com.nwm.common.siteName"/> AS site_name,
			DATE_FORMAT(NOW(), '%m/%d/%Y') AS report_date,
			s.ac_capacity,
			s.dc_capacity,
			"Normal" AS system_status
		FROM
			site s 
		WHERE
			s.id = #{id_site}
	</select>
	
	
	<select id="getDetailReport" resultType="com.nwm.api.entities.ViewReportEntity" parameterType="com.nwm.api.entities.ViewReportEntity" >
		SELECT
			r.id,
			s.id AS id_site,
			<include refid="com.nwm.common.siteName"/> AS site_name,
			s.table_data_report,
			s.table_data_virtual,
			DATE_FORMAT(CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', IFNULL(r.offset_timezone, 'UTC')), '%m/%d/%Y') AS report_date,
			s.ac_capacity,
			s.dc_capacity,
			s.is_rec_report,
			r.subscribers,
			r.data_intervals,
			r.type_report,
			r.type_option,
			r.cadence_range,
			IF(v.enable_virtual_device > 0 , 1, 0) AS enable_virtual_device,
			COUNT(IF(d.id_device_type = 4 AND d.reverse_poa = 0, 1, NULL)) > 0 AS have_poa,
			COUNT(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, 1, NULL)) > 0 AS have_meter,
			COUNT(IF(d.id_device_type = 1, 1, NULL)) > 0 AS have_inverter
		FROM
			report r
			LEFT JOIN site_employee_map sem ON sem.id_employee = r.id_employee
			LEFT JOIN site s ON s.id = sem.id_site
			LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
			LEFT JOIN (
				SELECT
					COUNT(*) AS enable_virtual_device,
					d.id_site
				FROM
					device d 
				WHERE
					d.`status` = 1 
					AND d.is_delete = 0 
					AND d.hidden = 0
					AND d.virtual_device_type IS NOT NULL
					AND d.virtual_device_type != ''
					AND d.id_site = #{id_site}
			) v ON v.id_site = s.id
			LEFT JOIN device d ON d.id_site = s.id
		WHERE
			r.id = #{id}
			AND s.id = #{id_site}
			AND (CONVERT_TZ(NOW(), 'UTC', tz.value) <![CDATA[ < ]]> s.expiration OR s.expiration IS NULL)
	</select>
  	
	
	<select id="getReportEnergyExpectations" resultType="Map" >
		SELECT
			* 
		FROM
			energy_expectations ee 
		WHERE
			ee.id_site = #{id_site}
	</select>
	
	
	<select id="getListDeviceTypeMeter" resultType="Map">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site,
			s.cost,
			s.cost_unit,
			<include refid="com.nwm.common.siteName"/> AS name,
			dt.`name` AS device_type
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
			LEFT JOIN site s ON d.id_site = s.id
		WHERE
			dt.id IN (3,7,9)
			AND d.is_excluded_meter = 0
			AND d.id_site = #{id_site}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getListDeviceTypeInverter" resultType="Map">
		SELECT
			d.id,
			d.devicename,
			d.devicename AS export_devicename,
			d.datatablename,
			d.id_site
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
		WHERE
			dt.id = 1
			AND d.id_site = #{id_site}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getDataEnergyMonthlyReport" resultType="com.nwm.api.entities.MonthlyDateEntity" >
		SELECT
			categories_time,
			CAST(actual AS DECIMAL) AS actual,
			CAST(estimated AS DECIMAL) AS estimated,
			ROUND(actual / estimated * 100, 1) AS percent
		FROM (
			SELECT
				DATE_FORMAT( sdr.time, '%m/%d/%Y' ) AS categories_time,
				GREATEST(0, IF(
					#{have_meter},
					SUM(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, sdr.ActualGeneration, 0)),
					SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0))
				)) AS actual,
				CASE
					WHEN MONTH(#{start_date}) = 01 then (ee.jan / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 02 then (ee.feb / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 03 then (ee.mar / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 04 then (ee.apr / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 05 then (ee.may / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 06 then (ee.jun / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 07 then (ee.jul / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 08 then (ee.aug / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 09 then (ee.sep / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 10 then (ee.oct / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 11 then (ee.nov / DAY(LAST_DAY(#{end_date})))
					WHEN MONTH(#{start_date}) = 12 then (ee.dec / DAY(LAST_DAY(#{end_date})))
				END AS estimated
			FROM
				${table_data_report} sdr 
				LEFT JOIN device d ON d.id = sdr.id_device
				LEFT JOIN site s ON s.id = d.id_site
				LEFT JOIN energy_expectations ee ON ee.id_site = s.id AND ee.`year` = DATE_FORMAT(#{start_date},"%Y")
			WHERE
				s.`status` = 1
				AND d.`status` = 1
				AND s.is_delete = 0
				AND d.is_delete = 0
				AND s.id = #{id_site}
				AND (sdr.time BETWEEN #{start_date} AND #{end_date})
			GROUP BY
				s.id,
				categories_time
		) t
	</select>
	
	<select id="getListSiteREC" resultType="Map" >
		SELECT
			s.id,
			<include refid="com.nwm.common.siteName"/> AS name,
			s.id AS id_site,
			IF(s.rec_id IS NULL || s.rec_id = '', CONCAT_WS("-", "NWM", s.id), s.rec_id) AS rec_id,
			IF(s.gu_id IS NULL || s.gu_id = '', CONCAT_WS("-", "NWM", s.id), s.gu_id) AS gu_id,
			IFNULL(ROUND(SUM( d.energy_this_month ) / 1000, 1), 0 ) AS energy_this_month,
			DATE_FORMAT( #{start_date}, "%m/%d/%Y") AS start_date,
			DATE_FORMAT(#{end_date}, "%m/%d/%Y") AS end_date,
			DATE_FORMAT(#{end_date}, "%m/%Y") AS vintage_date
		FROM
			site s
			LEFT JOIN device d ON d.id_site = s.id 
		WHERE
			s.`status` = 1 
			AND d.`status` = 1 
			<if test="id_sites != null">
				AND s.id IN  (
					<foreach item="item" index="index" collection="id_sites" separator=" , ">
						#{item.id}
					</foreach>
				)
			</if>
		GROUP BY
			s.id
	</select>
	
	
	
	<select id="getDataEnergyRECReport" resultType="Map" >
		<foreach item="item" index="index" collection="id_sites" separator="UNION">
		SELECT
			d.id,
			<include refid="com.nwm.common.siteName"/> AS name,
			d.devicename,
			IF(d.ru_id IS NULL || d.ru_id = '', CONCAT_WS("-", "NWM", d.id), d.ru_id) AS ru_id,
			IF(d.gu_id IS NULL || d.gu_id = '', CONCAT_WS("-", "NWM", d.id), d.gu_id) AS gu_id,
			DATE_FORMAT(#{start_date}, "%m/%d/%Y") AS start_date,
			DATE_FORMAT(#{end_date}, "%m/%d/%Y") AS end_date,
			DATE_FORMAT(#{end_date}, "%m/%Y") AS vintage_date,
			0 AS is_edit,
			CASE
			    WHEN DATE_FORMAT( sdr.time, '%m/%Y' ) != DATE_FORMAT(CONVERT_TZ(NOW(),'UTC', t.`value`), '%m/%Y') THEN CAST((GREATEST(0, SUM(sdr.ActualGeneration)) / 1000 * 0.97) AS DECIMAL(10, 2)) 
			    ELSE NULL
			END AS energy_this_month
			
		FROM
			site s
			LEFT JOIN device d ON d.id_site = s.id
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			LEFT JOIN (
				SELECT
					time,
					id_device,
					ActualGeneration
				FROM
					${item.table_data_report}
				WHERE
					DATE_FORMAT(time, '%Y-%m') = DATE_FORMAT( #{end_date}, '%Y-%m')
			) sdr ON sdr.id_device = d.id
			
		WHERE
			s.`status` = 1
			AND s.is_delete = 0
			AND d.`status` = 1
			AND d.is_delete = 0
			AND d.id = #{item.value}
			AND d.id_device_type IN (3,7,9)
			AND d.is_excluded_meter = 0
			AND s.is_rec_report = 1
			AND s.reporting_region = #{reporting_region}
		GROUP BY
			d.id
		</foreach>
		
		
	</select>
	
	
	
	<update id="updateRECID">
		UPDATE `device`
		SET
			`ru_id` = #{ru_id}
		WHERE
			`id` = #{id}
	</update>
	
	
	<update id="updateGUID">
		UPDATE `device`
		SET
			`gu_id` = #{gu_id}
		WHERE
			`id` = #{id}
	</update>
	
	
	
	
	<select id="getDataEnergyQuarterlyReportByMonth" resultType="com.nwm.api.entities.QuarterlyDateEntity" >
		SELECT
			categories_time,
			CAST(actual AS DECIMAL) AS actual,
			CAST(estimated AS DECIMAL) AS estimated,
			CAST(difference AS DECIMAL) AS difference,
			ROUND(differencePercentage, 1) AS differencePercentage,
			CAST(actualCumulative AS DECIMAL) AS actualCumulative,
			CAST(estimatedCumulative AS DECIMAL) AS estimatedCumulative,
			CAST((actualCumulative - estimatedCumulative) AS DECIMAL) AS cumulativeDifference,
			IF(estimatedCumulative > 0, ROUND((actualCumulative - estimatedCumulative) / estimatedCumulative * 100, 1), NULL) AS cumulativeDifferencePercentage
		FROM (
			SELECT
				categories_time,
				actual,
				estimated,
				(actual - estimated) AS difference,
				IF(estimated > 0, (actual - estimated) / estimated * 100, NULL) AS differencePercentage,
				SUM(actual) OVER (ORDER BY time) AS actualCumulative,
				SUM(estimated) OVER (ORDER BY time) AS estimatedCumulative
			FROM (
				SELECT
					sdr.time,
					DATE_FORMAT( sdr.time, '%b-%Y' ) AS categories_time,
					GREATEST(0, IF(
						#{have_meter},
						SUM(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, sdr.ActualGeneration, 0)),
						SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0))
					)) AS actual,
					CASE
						WHEN DATE_FORMAT(sdr.time, '%b') = "Jan" THEN ee.jan
						WHEN DATE_FORMAT(sdr.time, '%b') = "Feb" THEN ee.feb
						WHEN DATE_FORMAT(sdr.time, '%b') = "Mar" THEN ee.mar
						WHEN DATE_FORMAT(sdr.time, '%b') = "Apr" THEN ee.apr
						WHEN DATE_FORMAT(sdr.time, '%b') = "May" THEN ee.may
						WHEN DATE_FORMAT(sdr.time, '%b') = "Jun" THEN ee.jun
						WHEN DATE_FORMAT(sdr.time, '%b') = "Jul" THEN ee.jul
						WHEN DATE_FORMAT(sdr.time, '%b') = "Aug" THEN ee.aug
						WHEN DATE_FORMAT(sdr.time, '%b') = "Sep" THEN ee.sep
						WHEN DATE_FORMAT(sdr.time, '%b') = "Oct" THEN ee.oct
						WHEN DATE_FORMAT(sdr.time, '%b') = "Nov" THEN ee.nov
						WHEN DATE_FORMAT(sdr.time, '%b') = "Dec" THEN ee.`dec`
					END AS estimated
				FROM
					${table_data_report} sdr 
					LEFT JOIN device d ON d.id = sdr.id_device
					LEFT JOIN site s ON s.id = d.id_site
					LEFT JOIN energy_expectations ee ON ee.id_site = s.id AND ee.`year` = DATE_FORMAT(#{start_date},"%Y")
				WHERE
					s.`status` = 1
					AND d.`status` = 1
					AND s.is_delete = 0
					AND d.is_delete = 0
					AND s.id = #{id_site}
					AND (sdr.time BETWEEN #{start_date} AND #{end_date})
				GROUP BY 
					s.id,
					categories_time
			) t
		) t
	</select>
	
	<select id="getDataEnergyQuarterlyReportByDay" resultType="com.nwm.api.entities.QuarterlyDateEntity" >
		SELECT
			categories_time,
			CAST(actual AS DECIMAL) AS actual,
			ROUND(POAInsolation, 4) AS POAInsolation,
			ROUND(TCellAVG, 1) AS TCellAVG,
			ROUND(IF(POAInsolation > 0, (actual / ((dc_capacity * POAInsolation) * (1 - (-0.47 / 100) * (25 - TCellAVG))) * 100), NULL), 1) AS temperatureCorrected,
			ROUND(inverterAvailability, 1) AS inverterAvailability
		FROM (
			SELECT
				s.dc_capacity,
				DATE_FORMAT( sdr.time, '%m/%d/%Y' ) AS categories_time,
				GREATEST(0, IF(
					#{have_meter},
					SUM(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, sdr.ActualGeneration, 0)),
					SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0))
				)) AS actual,
				AVG(IF(d.id_device_type = 4, sdr.POAAVG * 24 / 1000, NULL)) AS POAInsolation,
				AVG(IF(d.id_device_type = 4, sdr.TCellAVG, NULL)) AS TCellAVG,
				AVG(IF(d.id_device_type = 1, sdr.InverterAvailability * 100, NULL)) AS inverterAvailability
			FROM
				${table_data_report} sdr 
				LEFT JOIN device d ON d.id = sdr.id_device
				LEFT JOIN site s ON s.id = d.id_site
			WHERE
				s.`status` = 1
				AND d.`status` = 1
				AND s.is_delete = 0
				AND d.is_delete = 0
				AND s.id = #{id_site}
				AND (sdr.time BETWEEN #{start_date} AND #{end_date})
			GROUP BY 
				s.id,
				categories_time
		) t
	</select>
	
	<select id="getDataEnergyAnnuallyReport" resultType="com.nwm.api.entities.QuarterlyDateEntity" >
		SELECT
			*,
			IF(estimatedCumulative > 0, ROUND(actualCumulative / estimatedCumulative * 100, 1), NULL) AS cumulativeDifferencePercentage
		FROM (
			SELECT
				categories_time,
				actual,
				estimated,
				ROUND(inverterAvailability, 1) AS inverterAvailability,
				ROUND(IF(estimated > 0, actual / estimated * 100, NULL), 1) AS differencePercentage,
				CAST(SUM(actual) OVER (ORDER BY time) AS DECIMAL) AS actualCumulative,
				CAST(SUM(estimated) OVER (ORDER BY time) AS DECIMAL) AS estimatedCumulative
			FROM (
				SELECT
					time,
					categories_time,
					CAST(GREATEST(0, SUM(actual)) AS DECIMAL) AS actual,
					CAST(estimated AS DECIMAL) AS estimated,
					SUM(inverterAvailability) / DAY(LAST_DAY(time)) AS inverterAvailability
				FROM (
					SELECT
						sdr.time,
						DATE_FORMAT( sdr.time, '%b' ) AS categories_time,
						IF(
							#{have_meter},
							SUM(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, sdr.ActualGeneration, 0)),
							SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0))
						) AS actual,
						CASE
							WHEN MONTH(sdr.time) = 01 then ee.jan
							WHEN MONTH(sdr.time) = 02 then ee.feb
							WHEN MONTH(sdr.time) = 03 then ee.mar
							WHEN MONTH(sdr.time) = 04 then ee.apr
							WHEN MONTH(sdr.time) = 05 then ee.may
							WHEN MONTH(sdr.time) = 06 then ee.jun
							WHEN MONTH(sdr.time) = 07 then ee.jul
							WHEN MONTH(sdr.time) = 08 then ee.aug
							WHEN MONTH(sdr.time) = 09 then ee.sep
							WHEN MONTH(sdr.time) = 10 then ee.oct
							WHEN MONTH(sdr.time) = 11 then ee.nov
							WHEN MONTH(sdr.time) = 12 then ee.dec
						END AS estimated,
						IF(
							#{have_inverter},
							AVG(IF(d.id_device_type = 1, sdr.inverterAvailability, NULL)) * 100,
							AVG(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, sdr.inverterAvailability, NULL)) * 100
						) AS inverterAvailability
					FROM
						${table_data_report} sdr 
						LEFT JOIN device d ON d.id = sdr.id_device
						LEFT JOIN site s ON s.id = d.id_site
						LEFT JOIN energy_expectations ee ON ee.id_site = s.id AND ee.`year` = DATE_FORMAT(#{start_date},"%Y")
					WHERE
						s.`status` = 1
						AND d.`status` = 1
						AND s.is_delete = 0
						AND d.is_delete = 0
						AND s.id = #{id_site}
						AND (sdr.time BETWEEN #{start_date} AND #{end_date})
					GROUP BY 
						s.id,
						sdr.time
				) t
				GROUP BY
					categories_time
			) t
		) t
	</select>
	
	
	<select id="getInverterAvailability" resultType="Map" >
		SELECT 
			ROUND((SUM(t.InverterAvailability)/ DATE_FORMAT(LAST_DAY(t.time),'%d') ), 1) AS InverterAvailability,
			t.time_full
			FROM (
			SELECT
				sd.time,
				ROUND(AVG(sd.InverterAvailability) * 100, 2) AS InverterAvailability,
				DATE_FORMAT( sd.time, '%b-%Y') AS time_full
			FROM
				${table_data_report} sd
				LEFT JOIN device d ON d.id = sd.id_device 
			WHERE
				d.id_site = #{id_site}
				AND d.id_device_type = 1
				AND (sd.time BETWEEN #{start_date} AND #{end_date})
				GROUP BY sd.time
		)t
		GROUP BY t.time_full
	</select>
	
	<select id="getMeterAvailability" resultType="Map" >
		SELECT 
			ROUND((SUM(t.InverterAvailability)/ DATE_FORMAT(LAST_DAY(t.time),'%d') ), 1) AS InverterAvailability,
			t.time_full
			FROM (
			SELECT
				sd.time,
				ROUND(AVG(sd.InverterAvailability) * 100, 2) AS InverterAvailability,
				DATE_FORMAT( sd.time, '%b-%Y') AS time_full
			FROM
				${table_data_report} sd
				LEFT JOIN device d ON d.id = sd.id_device 
			WHERE
				d.id_site = #{id_site}
				AND d.id_device_type IN (3,7,9)
				AND d.is_excluded_meter = 0
				AND (sd.time BETWEEN #{start_date} AND #{end_date})
				GROUP BY sd.time
		)t
		GROUP BY t.time_full
	</select>
	
	
	
	
	
	<select id="getDataEnergyMeter" resultType="com.nwm.api.entities.DailyDateEntity" >
		 	SELECT
				t.categories_time,
				ROUND(SUM(t.nvmActivePower), 0) AS power,
				CAST(SUM(t.energy) AS DECIMAL) AS energy
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
							SELECT
								<if test="data_intervals == 1">
									FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, 'UTC', t.`value` )) DIV 300)*300), '%m/%d/%Y %H:%i') AS categories_time,
								</if>
								<if test="data_intervals == 2">
									FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, 'UTC', t.`value` )) DIV 900)*900), '%m/%d/%Y %H:%i') AS categories_time,
								</if>
								<if test="data_intervals == 8">
									FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, 'UTC', t.`value` )) DIV 1800)*1800), '%m/%d/%Y %H:%i') AS categories_time,
								</if>
								<if test="data_intervals == 3">
									DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.`value` ), '%m/%d/%Y %H:00' ) AS categories_time,
								</if>
								AVG(dv.nvmActivePower) AS nvmActivePower,
								SUM(dv.MeasuredProduction) AS energy
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND (CONVERT_TZ( dv.time, 'UTC', t.`value` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, categories_time
			      </foreach>
				) t 
			GROUP BY
				t.categories_time
	</select>
	
	<select id="getDataEnergyCustomReport" resultType="com.nwm.api.entities.CustomReportDataEntity" >
			SELECT
				<choose>
					<when test="data_intervals == 4">
						DATE_FORMAT( sdr.time, '%m/%d/%Y' )
					</when>
					<when test="data_intervals == 6">
						DATE_FORMAT( sdr.time , "%m/%Y" )
					</when>
					<when test="data_intervals == 7">
						DATE_FORMAT( sdr.time , "%Y" )
					</when>
					<otherwise>
						DATE_FORMAT( sdr.time , "%m/%Y" )
					</otherwise>
				</choose>
				AS categories_time,
				GREATEST(0, IF(
					#{have_meter},
					ROUND(CAST(SUM(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, sdr.ActualGeneration, 0)) AS DECIMAL), 0),
					ROUND(CAST(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)) AS DECIMAL), 0)
				)) AS actual
				
			FROM
				${table_data_report} sdr 
				LEFT JOIN device d ON d.id = sdr.id_device
				LEFT JOIN site s ON s.id = d.id_site
				LEFT JOIN time_zone t ON t.id = s.id_time_zone
				
			WHERE
				s.`status` = 1
				AND d.`status` = 1
				AND s.is_delete = 0
				AND d.is_delete = 0
				AND s.id = #{id_site}
				AND (sdr.time BETWEEN #{start_date} AND #{end_date})
				
			GROUP BY 
				s.id,
				categories_time
	</select>
	
	<select id="getOperationPerformanceReport" resultType="com.nwm.api.entities.AssetManagementAndOperationPerformanceDataEntity">
		SELECT
			time_full,
			ROUND(actualEnergy, 0) AS actualEnergy,
			ROUND(modeledEnergy, 0) AS modeledEnergy,
			ROUND(expectedEnergy, 0) AS expectedEnergy,
			ROUND(actualPOA, 1) AS actualPOA,
			ROUND(modeledPOA, 1) AS modeledPOA,
			ROUND(IF(actualEnergy IS NOT NULL AND actualPOA IS NOT NULL AND dc_capacity IS NOT NULL, actualEnergy / (actualPOA * dc_capacity), NULL), 3) AS actualPerformanceRatio,
			ROUND(IF(modeledEnergy IS NOT NULL AND modeledPOA IS NOT NULL AND dc_capacity IS NOT NULL, modeledEnergy / (modeledPOA * dc_capacity), NULL), 3) AS modeledPerformanceRatio,
			ROUND(IF(actualEnergy IS NOT NULL AND modeledEnergy IS NOT NULL, actualEnergy / modeledEnergy, NULL), 3) AS energyIndex,
			ROUND(IF(actualPOA IS NOT NULL AND modeledPOA IS NOT NULL, actualPOA / modeledPOA, NULL), 3) AS weatherIndex,
			ROUND(IF(actualEnergy IS NOT NULL AND modeledEnergy IS NOT NULL AND actualPOA IS NOT NULL AND modeledPOA IS NOT NULL, (actualEnergy / modeledEnergy) / (actualPOA / modeledPOA), NULL), 3) AS weatherAdjustedIndex,
			ROUND(InverterAvailability, 3) AS inverterAvailability
		FROM (
			SELECT
				sdr.time_full,
				sdr.dc_capacity,
				sdr.InverterAvailability AS InverterAvailability,
				CASE
					WHEN sdr.`month` = "Jan" THEN ee.jan
					WHEN sdr.`month` = "Feb" THEN ee.feb
					WHEN sdr.`month` = "Mar" THEN ee.mar
					WHEN sdr.`month` = "Apr" THEN ee.apr
					WHEN sdr.`month` = "May" THEN ee.may
					WHEN sdr.`month` = "Jun" THEN ee.jun
					WHEN sdr.`month` = "Jul" THEN ee.jul
					WHEN sdr.`month` = "Aug" THEN ee.aug
					WHEN sdr.`month` = "Sep" THEN ee.sep
					WHEN sdr.`month` = "Oct" THEN ee.oct
					WHEN sdr.`month` = "Nov" THEN ee.nov
					WHEN sdr.`month` = "Dec" THEN ee.`dec`
				END AS modeledEnergy,
				CASE
					WHEN sdr.`month` = "Jan" THEN ie.jan
					WHEN sdr.`month` = "Feb" THEN ie.feb
					WHEN sdr.`month` = "Mar" THEN ie.mar
					WHEN sdr.`month` = "Apr" THEN ie.apr
					WHEN sdr.`month` = "May" THEN ie.may
					WHEN sdr.`month` = "Jun" THEN ie.jun
					WHEN sdr.`month` = "Jul" THEN ie.jul
					WHEN sdr.`month` = "Aug" THEN ie.aug
					WHEN sdr.`month` = "Sep" THEN ie.sep
					WHEN sdr.`month` = "Oct" THEN ie.oct
					WHEN sdr.`month` = "Nov" THEN ie.nov
					WHEN sdr.`month` = "Dec" THEN ie.`dec`
				END AS modeledPOA,
				<choose>
					<when test="enable_virtual_device.booleanValue()">
						vir.actualEnergy AS actualEnergy,
						vir.expectedEnergy AS expectedEnergy,
						vir.actualPOA AS actualPOA
					</when>
					<otherwise>
						sdr.actualEnergy AS actualEnergy,
						sdr.expectedEnergy AS expectedEnergy,
						sdr.actualPOA AS actualPOA
					</otherwise>
				</choose>
			FROM
				(
					SELECT
						DATE_FORMAT(sdr.time, "%b-%y") AS time_full,
						DATE_FORMAT(sdr.time, "%b") AS `month`,
						DATE_FORMAT(sdr.time, "%Y") AS `year`,
						GREATEST(0, IF(
							#{have_meter},
							ROUND(CAST(SUM(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, sdr.ActualGeneration, 0)) AS DECIMAL), 1),
							ROUND(CAST(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)) AS DECIMAL), 1)
						)) AS actualEnergy,
						AVG(IF(
							d.id_device_type = 4,
							<include refid="com.nwm.common.expectedPowerByPvModel">
								<property name="irradiance" value="sdr.POAAVG" />
								<property name="temperature" value="sdr.TCellAVG" />
								<property name="panelTemperature" value="sdr.TCellAVG" />
								<property name="power" value="sdr.PowerTodayAVG" />
							</include>,
							NULL
						)) * 24 * COUNT(*) AS expectedEnergy,
						AVG(IF(d.id_device_type = 4 AND d.reverse_poa = 0, sdr.POAAVG, NULL)) AS actualPOA,
						SUM(ia.InverterAvailability) / DATE_FORMAT(LAST_DAY(sdr.time),'%d') AS InverterAvailability,
						s.dc_capacity
					FROM
						${table_data_report} sdr
						LEFT JOIN device d ON d.id = sdr.id_device
						LEFT JOIN site s ON s.id = d.id_site
						LEFT JOIN (
							SELECT
								sdr.time,
								AVG(sdr.InverterAvailability) AS InverterAvailability,
								d.id
							FROM
								${table_data_report} sdr
								LEFT JOIN device d ON d.id = sdr.id_device
							WHERE
								d.id_site = #{id_site}
								AND d.status = 1
								AND d.is_delete = 0
								AND d.id_device_type = 1
								AND sdr.time BETWEEN #{start_date} AND #{end_date}
							GROUP BY
								sdr.time
						) ia ON ia.time = sdr.time AND ia.id = d.id
					WHERE
						d.id_site = #{id_site}
						AND d.status = 1
						AND d.is_delete = 0
						AND s.status = 1
						AND s.is_delete = 0
						AND sdr.time BETWEEN #{start_date} AND #{end_date}
					GROUP BY
						time_full
				) sdr
				LEFT JOIN (
					SELECT
						id_site, `year`, jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, `dec`
					FROM
						energy_expectations
					WHERE
						id_site = #{id_site}
						AND `year` BETWEEN DATE_FORMAT(#{start_date}, "%Y") AND DATE_FORMAT(#{end_date}, "%Y")
				) ee ON ee.`year` = sdr.`year`
				LEFT JOIN (
					SELECT
						id_site, jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, `dec`
					FROM
						irradiance_expectations
					WHERE
						id_site = #{id_site}
				) ie ON ie.id_site = ee.id_site
				<if test="enable_virtual_device.booleanValue()">
					LEFT JOIN (
						SELECT
							DATE_FORMAT(group_by_day, "%b-%y") AS time_full,
							GREATEST(0, SUM(actualEnergy)) AS actualEnergy,
							AVG(expectedPower) * 24 * COUNT(*) AS expectedEnergy,
							AVG(actualPOA) AS actualPOA
						FROM (
							SELECT
								DATE_FORMAT(CONVERT_TZ(vir.time, 'UTC', tz.`value`), "%Y-%m-%d") AS group_by_day,
								SUM(vir.nvmActiveEnergy) AS actualEnergy,
								AVG(vir.expected_power_ac) AS expectedPower,
								AVG(vir.nvm_irradiance) AS actualPOA
							FROM
								${table_data_virtual} vir
								LEFT JOIN device d ON d.id = vir.id_device
								LEFT JOIN site s ON s.id = d.id_site
								LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
							WHERE
								d.id_site = #{id_site}
								AND d.status = 1
								AND d.is_delete = 0
								AND s.status = 1
								AND s.is_delete = 0
								AND vir.time BETWEEN CONVERT_TZ(#{start_date}, tz.`value`, 'UTC') AND CONVERT_TZ(#{end_date}, tz.`value`, 'UTC')
							GROUP BY
								group_by_day
						) t
						GROUP BY
							time_full
					) vir ON vir.time_full = sdr.time_full
				</if>
		) m
	</select>
	
	<select id="getMonthlyPerformanceReport" resultType="com.nwm.api.entities.AssetManagementAndOperationPerformanceDataEntity">
		SELECT
			time_full,
			ROUND(actualEnergy, 0) AS actualEnergy,
			ROUND(expectedEnergy, 0) AS expectedEnergy,
			ROUND(modeledEnergy, 0) AS modeledEnergy,
			ROUND(IF(actualEnergy IS NOT NULL AND expectedEnergy IS NOT NULL, actualEnergy / expectedEnergy, NULL), 3) AS expectedGenerationIndex,
			ROUND(IF(actualEnergy IS NOT NULL AND modeledEnergy IS NOT NULL, actualEnergy / modeledEnergy, NULL), 3) AS modeledGenerationIndex
		FROM (
			SELECT
				sdr.time_full,
				sdr.actualEnergy,
				sdr.expectedPower * 24 AS expectedEnergy,
				CASE
					WHEN sdr.`month` = "Jan" THEN ee.jan
					WHEN sdr.`month` = "Feb" THEN ee.feb
					WHEN sdr.`month` = "Mar" THEN ee.mar
					WHEN sdr.`month` = "Apr" THEN ee.apr
					WHEN sdr.`month` = "May" THEN ee.may
					WHEN sdr.`month` = "Jun" THEN ee.jun
					WHEN sdr.`month` = "Jul" THEN ee.jul
					WHEN sdr.`month` = "Aug" THEN ee.aug
					WHEN sdr.`month` = "Sep" THEN ee.sep
					WHEN sdr.`month` = "Oct" THEN ee.oct
					WHEN sdr.`month` = "Nov" THEN ee.nov
					WHEN sdr.`month` = "Dec" THEN ee.`dec`
				END / DAY(LAST_DAY(STR_TO_DATE(sdr.time_full, "%m/%d/%Y"))) AS modeledEnergy
			FROM
				(
					<choose>
						<when test="enable_virtual_device.booleanValue()">
							SELECT
								DATE_FORMAT(CONVERT_TZ(vir.time, 'UTC', tz.`value`), "%m/%d/%Y") AS time_full,
								DATE_FORMAT(CONVERT_TZ(vir.time, 'UTC', tz.`value`), "%b") AS `month`,
								DATE_FORMAT(CONVERT_TZ(vir.time, 'UTC', tz.`value`), "%Y") AS `year`,
								GREATEST(0, SUM(vir.nvmActiveEnergy)) AS actualEnergy,
								AVG(vir.expected_power_ac) AS expectedPower
							FROM
								${table_data_virtual} vir
								LEFT JOIN device d ON d.id = vir.id_device
								LEFT JOIN site s ON s.id = d.id_site
								LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
							WHERE
								d.id_site = #{id_site}
								AND d.status = 1
								AND d.is_delete = 0
								AND s.status = 1
								AND s.is_delete = 0
								AND vir.time BETWEEN CONVERT_TZ(#{start_date}, tz.`value`, 'UTC') AND CONVERT_TZ(#{end_date}, tz.`value`, 'UTC')
							GROUP BY
								time_full
						</when>
						<otherwise>
							SELECT
								DATE_FORMAT(sdr.time, "%m/%d/%Y") AS time_full,
								DATE_FORMAT(sdr.time, "%b") AS `month`,
								DATE_FORMAT(sdr.time, "%Y") AS `year`,
								GREATEST(0, IF(
									#{have_meter},
									ROUND(CAST(SUM(IF(d.id_device_type IN (3,7,9) AND d.is_excluded_meter = 0, sdr.ActualGeneration, 0)) AS DECIMAL), 1),
									ROUND(CAST(SUM(IF(d.id_device_type = 1, sdr.ActualGeneration, 0)) AS DECIMAL), 1)
								)) AS actualEnergy,
								AVG(IF(
									d.id_device_type = 4,
									<include refid="com.nwm.common.expectedPowerByPvModel">
										<property name="irradiance" value="sdr.POAAVG" />
										<property name="temperature" value="sdr.TCellAVG" />
										<property name="panelTemperature" value="sdr.TCellAVG" />
										<property name="power" value="sdr.PowerTodayAVG" />
									</include>,
									NULL
								)) AS expectedPower
							FROM
								${table_data_report} sdr
								LEFT JOIN device d ON d.id = sdr.id_device
								LEFT JOIN site s ON s.id = d.id_site
							WHERE
								d.id_site = #{id_site}
								AND d.status = 1
								AND d.is_delete = 0
								AND s.status = 1
								AND s.is_delete = 0
								AND sdr.time BETWEEN #{start_date} AND #{end_date}
							GROUP BY
								time_full
						</otherwise>
					</choose>
				) sdr
				LEFT JOIN (
					SELECT
						id_site, `year`, jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, `dec`
					FROM
						energy_expectations
					WHERE
						id_site = #{id_site}
						AND `year` BETWEEN DATE_FORMAT(#{start_date}, "%Y") AND DATE_FORMAT(#{end_date}, "%Y")
				) ee ON ee.`year` = sdr.`year`
		) m
	</select>
	
	<select id="getEstimatedLossByEventReport" resultType="com.nwm.api.entities.AssetManagementAndOperationPerformanceDataEntity">
		SELECT
			event,
			devicename,
			startTime,
			endTime,
			duration,
			ROUND(duration * modeledEnergy * ratio / DAY(LAST_DAY(#{start_date})), 0) AS estimatedLoss
		FROM (
			SELECT
				er.message AS event,
				d.devicename,
				IFNULL(d.rating_ac_power, 0) / s.ac_capacity AS ratio,
				DATE_FORMAT(CONVERT_TZ(al.start_date, 'UTC', tz.`value`), "%m/%d/%Y %h:%i %p") AS startTime,
				DATE_FORMAT(CONVERT_TZ(al.end_date, 'UTC', tz.`value`), "%m/%d/%Y %h:%i %p") AS endTime,
				DATEDIFF(IFNULL(CONVERT_TZ(al.end_date, 'UTC', tz.`value`), CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', tz.`value`)), CONVERT_TZ(al.start_date, 'UTC', tz.`value`)) AS duration,
				ROUND(
					CASE
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Jan" THEN ee.jan
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Feb" THEN ee.feb
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Mar" THEN ee.mar
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Apr" THEN ee.apr
						WHEN DATE_FORMAT(#{start_date}, "%b") = "May" THEN ee.may
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Jun" THEN ee.jun
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Jul" THEN ee.jul
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Aug" THEN ee.aug
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Sep" THEN ee.sep
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Oct" THEN ee.oct
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Nov" THEN ee.nov
						WHEN DATE_FORMAT(#{start_date}, "%b") = "Dec" THEN ee.`dec`
					END,
					0
				) AS modeledEnergy
			FROM
				device d
				LEFT JOIN alert al ON al.id_device = d.id
				LEFT JOIN error er ON er.id = al.id_error
				LEFT JOIN site s ON s.id = d.id_site
				LEFT JOIN time_zone tz ON tz.id = s.id_time_zone
				LEFT JOIN energy_expectations ee ON ee.id_site = s.id AND ee.`year` = DATE_FORMAT(#{start_date}, "%Y")
			WHERE
				d.id_site = #{id_site}
				AND d.id_device_type = 1
				AND d.`status` = 1
				AND d.is_delete = 0
				AND s.`status` = 1
				AND s.is_delete = 0
				AND er.`status` = 1
				AND er.is_delete = 0
				AND er.error_code = "1000"
				AND al.is_delete = 0
				AND al.start_date IS NOT NULL
				AND al.start_date BETWEEN CONVERT_TZ(#{start_date}, tz.`value`, 'UTC') AND CONVERT_TZ(#{end_date}, tz.`value`, 'UTC')
		) m
	</select>
	
	<select id="getDataIrradiance" resultType="com.nwm.api.entities.DailyDateEntity" >
			SELECT
				ROUND(AVG(t.irradiance), 0)  AS `irradiance`,
				t.categories_time
			FROM
				(
					<foreach collection="groupDevices" item="item" index="index" separator="union all">
							SELECT
								<if test="data_intervals == 1">
									FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, 'UTC', t.`value` )) DIV 300)*300), '%m/%d/%Y %H:%i') AS categories_time,
								</if>
								<if test="data_intervals == 2">
									FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, 'UTC', t.`value` )) DIV 900)*900), '%m/%d/%Y %H:%i') AS categories_time,
								</if>
								<if test="data_intervals == 3">
									DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.`value` ), '%m/%d/%Y %H:00' ) AS categories_time,
								</if>
								AVG(dv.nvm_irradiance) AS irradiance 
							FROM
								${item.datatablename} dv
								LEFT JOIN device d ON d.id = dv.id_device
								LEFT JOIN site s ON s.id = d.id_site 
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
							WHERE
								s.id = #{item.id_site}
								AND d.id_device_type IN(4,6)
								AND (CONVERT_TZ( dv.time, 'UTC', t.`value` ) BETWEEN #{start_date} AND #{end_date})
								AND s.`status` = 1 
								AND d.`status` = 1 
							GROUP BY
								d.id, categories_time
			      </foreach>
				) t 
			GROUP BY
				t.categories_time
	</select>
	
	<select id="getListDeviceTypeIrradiance" resultType="Map">
		SELECT
			d.id,
			d.devicename,
			d.datatablename,
			d.id_site
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id 
		WHERE
			dt.id IN(4,6)
			AND d.id_site = #{id_site}
			AND d.`status` = 1 
			AND d.is_delete = 0
	</select>
	
	
	<select id="getExpectationsRow" resultType="com.nwm.api.entities.EnergyExpectationsEntity">
		SELECT
			* 
		FROM
			energy_expectations ee 
		WHERE
			ee.id_site = #{id_site}
			AND `year` = DATE_FORMAT(#{start_date},"%Y")
  	</select>
	
	
	<insert id="insertReportSiteMap">
		INSERT INTO `report_site_map`(
			id_report,
			id_site
		)VALUES
			<foreach item="item" collection="dataSite" separator=",">
				(#{id}, #{item.id})
			</foreach>
	</insert>
	
	<insert id="duplicateReportSiteMap" parameterType="com.nwm.api.entities.ReportDuplicateRequest">
		INSERT INTO report_site_map (
			id_report,
			id_site
		)
		SELECT
			#{newId} AS id_report,
			id_site
		FROM
			report_site_map
		WHERE
			id_report = #{id}
	</insert>
	
	
	<delete id = "deleteReportSiteMap" parameterType = "com.nwm.api.entities.ReportsEntity">
		DELETE FROM `report_site_map`
		WHERE id_report = #{id};
	</delete>
	
	<select id="getEnergySanityCheckReport" resultType="com.nwm.api.entities.AccumulatedEnergyByMonthEntity">
		<foreach collection="groupDevices" item="item" separator="UNION ALL">
			SELECT
				#{item.id_device_type} AS deviceTypeId,
				(SELECT CAST(nvmActiveEnergy AS DECIMAL) FROM ${item.datatablename} WHERE time = curr.beginning) AS currentBOM,
				(SELECT CAST(nvmActiveEnergy AS DECIMAL) FROM ${item.datatablename} WHERE time = IFNULL(next.beginning, curr.ending)) AS currentEOM,
				(SELECT CAST(nvmActiveEnergy AS DECIMAL) FROM ${item.datatablename} WHERE time = last.beginning) AS lastBOM,
				(SELECT CAST(nvmActiveEnergy AS DECIMAL) FROM ${item.datatablename} WHERE time = IFNULL(curr.beginning, last.ending)) AS lastEOM
			FROM 
				(
					SELECT
						MIN(time) AS beginning,
						MAX(time) AS ending
					FROM
						${item.datatablename}
					WHERE
						time BETWEEN CONVERT_TZ(DATE_ADD(#{start_date}, INTERVAL 1 MONTH), #{item.timezone_value}, 'UTC') AND CONVERT_TZ(DATE_FORMAT(LAST_DAY(DATE_ADD(#{start_date}, INTERVAL 1 MONTH)), '%Y-%m-%d 23:59:59'), #{item.timezone_value}, 'UTC')
						AND nvmActiveEnergy IS NOT NULL
				) next
				CROSS JOIN
				(
					SELECT
						MIN(time) AS beginning,
						MAX(time) AS ending
					FROM
						${item.datatablename}
					WHERE
						time BETWEEN CONVERT_TZ(#{start_date}, #{item.timezone_value}, 'UTC') AND CONVERT_TZ(DATE_FORMAT(LAST_DAY(#{start_date}), '%Y-%m-%d 23:59:59'), #{item.timezone_value}, 'UTC')
						AND nvmActiveEnergy IS NOT NULL
				) curr
				CROSS JOIN
				(
					SELECT
						MIN(time) AS beginning,
						MAX(time) AS ending
					FROM
						${item.datatablename}
					WHERE
						time BETWEEN CONVERT_TZ(DATE_SUB(#{start_date}, INTERVAL 1 MONTH), #{item.timezone_value}, 'UTC') AND CONVERT_TZ(DATE_FORMAT(LAST_DAY(DATE_SUB(#{start_date}, INTERVAL 1 MONTH)), '%Y-%m-%d 23:59:59'), #{item.timezone_value}, 'UTC')
						AND nvmActiveEnergy IS NOT NULL
				) last
		</foreach>
	</select>
	
	<select id="getIrradianceSanityCheckReport" resultType="Map">
		<foreach collection="groupDevices" item="item" separator="UNION ALL">
			SELECT
				(
					SELECT
						AVG(nvm_irradiance)
					FROM (
						SELECT
							AVG(nvm_irradiance) AS nvm_irradiance
						FROM
							${item.datatablename}
						WHERE
							time >= CONVERT_TZ(#{start_date}, #{item.timezone_value}, 'UTC') AND time <![CDATA[ < ]]> CONVERT_TZ(DATE_ADD(#{start_date}, INTERVAL 1 MONTH), #{item.timezone_value}, 'UTC')
						GROUP BY
							DAY(CONVERT_TZ(time, 'UTC', #{item.timezone_value}))
					) t
				) AS current,
				(
					SELECT
						AVG(nvm_irradiance)
					FROM (
						SELECT
							AVG(nvm_irradiance) AS nvm_irradiance
						FROM
							${item.datatablename}
						WHERE
							time >= CONVERT_TZ(DATE_SUB(#{start_date}, INTERVAL 1 MONTH), #{item.timezone_value}, 'UTC') AND time <![CDATA[ < ]]> CONVERT_TZ(#{start_date}, #{item.timezone_value}, 'UTC')
						GROUP BY
							DAY(CONVERT_TZ(time, 'UTC', #{item.timezone_value}))
					) t
				) AS last
		</foreach>
	</select>
	
	<select id="getListDeviceTypeMeterWeatherStation" resultType="Map">
		SELECT
			d.id,
			d.devicename,
			d.id_device_type,
			d.devicename AS export_devicename,
			d.datatablename,
			dp.table_name,
			CASE
				WHEN d.id_device_type = 3 THEN concat( d.devicename, ', Real power (kW)'  ) 
				WHEN d.id_device_type = 4 THEN concat( d.devicename, ' POA sensor (W/m²)'  )
			END AS `power_irradiance`,
			CASE
				WHEN d.id_device_type = 3 THEN concat( d.devicename, ', Delivered energy (kWh)'  ) 
				WHEN d.id_device_type = 4 THEN concat( d.devicename, ', External Module Temp (°C)'  )
			END AS `energy_temp`,
			d.id_site
		FROM
			device d
			LEFT JOIN device_type dt ON d.id_device_type = dt.id
			LEFT JOIN device_group dp ON dp.id = d.id_device_group
		WHERE
			dt.id IN (3, 4)
			AND d.is_excluded_in_report = 0
			AND d.is_excluded_meter = 0
			AND d.id_site = #{ids_site}
			AND d.`status` = 1 
			AND d.is_delete = 0
			ORDER BY d.order_id ASC
	</select>
  	
  	<select id="getDataEnergyEachMeter" resultType="Map" >
		SELECT 
			t.Timestamp,
			t.time_group_by,
			ROUND(AVG(t.power_irradiance), 2) AS `${power_irradiance}`,
			ROUND(SUM(t.energy_temp), 2) AS `${energy_temp}`
		FROM (
			SELECT
				<if test="data_intervals == 1">
					FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, 'UTC', t.`value` )) DIV 300)*300), '%m/%d/%Y %H:%i') AS Timestamp,
					FROM_UNIXTIME(( UNIX_TIMESTAMP( CONVERT_TZ( dv.time, 'UTC', t.value ) ) DIV 300  )* 300, '%Y-%m-%d %H:%i' ) AS time_group_by,
				</if>
				<if test="data_intervals == 2">
					FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, 'UTC', t.`value` )) DIV 900)*900), '%m/%d/%Y %H:%i') AS Timestamp,
					FROM_UNIXTIME(( UNIX_TIMESTAMP( CONVERT_TZ( dv.time, 'UTC', t.value ) ) DIV 900  )* 900, '%Y-%m-%d %H:%i' ) AS time_group_by,
				</if>
				<if test="data_intervals == 3">
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.`value` ), '%m/%d/%Y %H:00' ) AS Timestamp,
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d %H:00' ) AS time_group_by,
				</if>
				<if test="data_intervals == 4">
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.`value` ), '%m/%d/%Y' ) AS Timestamp,
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d') AS time_group_by,
				</if>
				<if test="data_intervals == 6">
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.`value` ), '%m/%Y' ) AS Timestamp,
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d') AS time_group_by,
				</if>
				
				AVG(IF(dv.nvmActivePower <![CDATA[<]]> 0, 0, dv.nvmActivePower)) AS `power_irradiance`,
				SUM(dv.MeasuredProduction) AS `energy_temp`

			FROM
				${datatablename} dv
				LEFT JOIN device d ON d.id = dv.id_device
				LEFT JOIN site s ON s.id = d.id_site 
				LEFT JOIN time_zone t ON t.id = s.id_time_zone
			WHERE
				s.id = #{id_site}
				AND (CONVERT_TZ( dv.time, 'UTC', t.`value` ) BETWEEN #{start_date} AND #{end_date})
				AND s.`status` = 1 
				AND d.`status` = 1 
			GROUP BY time_group_by
			ORDER BY time_group_by ASC
			) t
		GROUP BY t.Timestamp
	</select>
	
	<select id="getDataEnergyEachWeatherStation" resultType="Map" >
		SELECT 
 			t.Timestamp,
			t.time_group_by,
			ROUND(AVG(t.power_irradiance), 2) AS `${power_irradiance}`,
			ROUND(AVG(t.energy_temp), 2) AS `${energy_temp}`
		FROM (
			SELECT
				<if test="data_intervals == 1">
					FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, 'UTC', t.`value` )) DIV 300)*300), '%m/%d/%Y %H:%i') AS Timestamp,
					FROM_UNIXTIME(( UNIX_TIMESTAMP( CONVERT_TZ( dv.time, 'UTC', t.value ) ) DIV 300  )* 300, '%Y-%m-%d %H:%i' ) AS time_group_by,
				</if>
				<if test="data_intervals == 2">
					FROM_UNIXTIME(((UNIX_TIMESTAMP(CONVERT_TZ( dv.time, 'UTC', t.`value` )) DIV 900)*900), '%m/%d/%Y %H:%i') AS Timestamp,
					FROM_UNIXTIME(( UNIX_TIMESTAMP( CONVERT_TZ( dv.time, 'UTC', t.value ) ) DIV 900  )* 900, '%Y-%m-%d %H:%i' ) AS time_group_by,
				</if>
				<if test="data_intervals == 3">
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.`value` ), '%m/%d/%Y %H:00' ) AS Timestamp,
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d %H:00' ) AS time_group_by,
				</if>
				<if test="data_intervals == 4">
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.`value` ), '%m/%d/%Y' ) AS Timestamp,
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d') AS time_group_by,
				</if>
				<if test="data_intervals == 6">
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.`value` ), '%m/%Y' ) AS Timestamp,
					DATE_FORMAT( CONVERT_TZ( dv.time, 'UTC', t.value ), '%Y-%m-%d') AS time_group_by,
				</if>
				AVG(IF(dv.nvm_irradiance <![CDATA[<]]> 0, 0, dv.nvm_irradiance)) AS `power_irradiance`,
				<choose>
					<when test="(table_name == 'model_kippzonen_rt1_class8009')">
						AVG(dv.panel_temperature) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_imtsolar_class8000')">
						AVG(dv.tcell) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_rt1_class30000')">
						AVG(dv.panel_temperature) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_w_kipp_zonen_rt1')">
						AVG(dv.PanelTemperature) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_imtsolar_tmodul_class8006')">
						AVG(dv.ModuleTemperature) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_hukseflux_sr30d1_deviceclass_v0')">
						AVG(dv.SensorBodyTemperature) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_pyranometer_poa')">
						AVG(dv.point2) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_eri_weather_icp_class8050')">
						AVG(dv.ambient_temp) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_pvmet_100')">
						AVG(dv.AmbientTemperature) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_pvmet_200')">
						AVG(dv.Ambient_Air_Temperature) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_weather_station_bsp')">
						AVG(dv.AmbientTemperature) AS `energy_temp`
					</when>
					<when test="(table_name == 'model_Hukseflux_HB500')">
						AVG(dv.AmbientTemperature) AS `energy_temp`
					</when>
					
					<otherwise>
						AVG(dv.nvm_temperature) AS `energy_temp`
					</otherwise>
				</choose>
				
				

			FROM
				${datatablename} dv
				LEFT JOIN device d ON d.id = dv.id_device
				LEFT JOIN site s ON s.id = d.id_site 
				LEFT JOIN time_zone t ON t.id = s.id_time_zone
			WHERE
				s.id = #{id_site}
				AND (CONVERT_TZ( dv.time, 'UTC', t.`value` ) BETWEEN #{start_date} AND #{end_date})
				AND s.`status` = 1 
				AND d.`status` = 1 
			GROUP BY time_group_by
			ORDER BY time_group_by ASC
			) t
		GROUP BY t.Timestamp
	</select>
	
</mapper>